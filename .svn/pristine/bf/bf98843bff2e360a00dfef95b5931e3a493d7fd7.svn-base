
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>短信充值</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="__PUBLIC__/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="__PUBLIC__/layuiadmin/style/admin.css" media="all">
  <link rel="stylesheet" href="__PUBLIC__/layuiadmin/style/public.css">
  <style>
    .autosend-switch+.layui-form-switch {
      margin-top: 0;
    }
  </style>
</head>

<body layadmin-themealias="default">


  <div class="layui-fluid">
    <div class="layui-card">
      <div class="layui-card-body">

        <div id="part1">

          <div class="layui-form-item">
            <label class="layui-form-label">短信充值数量</label>
            <div class="layui-input-inline">
              <input type="text" class="layui-input" value="" name="sms_num" id="sms_num" onchange="showPrice()">
            </div>
            <div class="layui-form-mid layui-word-aux">单位：千条</div>
          </div>
          
          <div class="layui-form-item">
            <label class="layui-form-label">金额</label>
            <div class="layui-input-inline">
              <input type="text" class="layui-input"  min="0" value="0" id="price">
            </div>
          </div>

        </div>
        
        <div style="text-align: center; display: none;" id="part2">
          <img src="./images/111.png" alt="" width="200">
          <div class="layui-word-aux">请扫描微信二维码进行支付</div>
        </div>
      </div>
    </div>
  </div>

  <div class="layui-form-item layui-layout-admin" id="partFooter1">
    <div class="layui-input-block">
      <div class="layui-footer" style="left: 0;z-index: 9999;">
        <button class="layui-btn" onclick="recharge(this)">下一步</button>
      </div>
    </div>
  </div>

  <div class="layui-form-item layui-layout-admin" id="partFooter2" style="display: none;">
    <div class="layui-input-block">
      <div class="layui-footer" style="left: 0;z-index: 9999;">
        <button class="layui-btn" onclick="recharge_complete()">充值完成</button>
        <button class="layui-btn" onclick="back()">返回上一步</button>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="__PUBLIC__/layuiadmin/js/jquery-3.3.1.js"></script>
  <script src="__PUBLIC__/layuiadmin/layui/layui.js"></script>
  <script>
    layui.config({
      base: '__PUBLIC__/layuiadmin/' //静态资源所在路径
    }).extend({
      index: 'lib/index' //主入口模块
    }).use(['index', 'table'], function () {
        window.recharge_complete = function() {
            closewin();
        }
        window.closewin = function(){
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
            parent.location.reload();
        }
    })

  </script>

  <script type="text/javascript">
    var t;
    var waitTime = 0;
    function showPrice() {
      var sms_num = $("#sms_num").val();
      sms_num = sms_num;
      console.log(sms_num);
      $("#price").val(sms_num * 60);
    }

    /**
     * 充值
     */
    function recharge(objThis) {
      var sms_num = $("#sms_num").val();
      sms_num = sms_num * 1000;
      var flag = true;
      if (sms_num < 1000) {
        layer.msg('短信充值数量不能少于1000条！');
        flag = false;
        return flag;
      }
      if ((sms_num % 1000) != 0) {
        layer.msg('短信充值数量须为1000的倍数！');
        flag = false;
        return flag;
      }

      if (flag) {
        var url = "/admin/sms/pay/sms_num/" + sms_num;
        if (waitTime != 0) {  
          $("#part1").hide();
          $("#partFooter1").hide();
          $("#part2").show();
          $("#partFooter2").show();
        } else {
          var msg = "您将购买" + sms_num + "条短信，共计" + ((sms_num * 0.06).toFixed(2)) + "元，确认支付？";
          layer.confirm(msg, {
            btn: ['确定', '取消'] //按钮
          }, function () {
            layer.closeAll();
            $(objThis).attr("disabled", true);
            $.ajax({
              url: url,
              type: "post",
              dataType: 'json',
              success: function (obj) {
                if (obj.status === "success") {
                  $("#part1").hide();
                  $("#partFooter1").hide();
                  $("#part2").show();
                  $("#partFooter2").show();
                  waitTime = 60;
                  $(objThis).attr("disabled", false);
                  setTimeout(function () {
                    $(objThis).text("下一步");
                    clearInterval(t);
                  }, 61000);
                  t = setInterval(function () {
                    waitTime--;
                    $(objThis).text("继续支付(" + (waitTime) + "s后可重新生成订单)");
                  }, 1000);
                  $("#pay_qrcode").show();
                  $("#str_pay_qrcode").show();
                  $("#pay_qrcode").attr("src", obj.pay_url);
                } else {
                  $(objThis).attr("disabled", false);
                  layer.alert('请求支付失败，请刷新后重试', { icon: 2 }, function (index) {
                    layer.close(index);
                  });
                }
              },
              error: function (msg) {
                $(objThis).attr("disabled", false);
                layer.alert('操作失败', { icon: 2 }, function (index) {
                  layer.close(index);
                  // location.reload();
                });
              }
            })
          });
        }
      }
    }

    function back() {
      $("#part1").show();
      $("#partFooter1").show();
      $("#part2").hide();
      $("#partFooter2").hide();
    }
  </script>
</body>

</html>