<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport"
        content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,user-scalable=0" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">

    <title>功能介绍</title>
    <meta name="keywords" content="" />
    <meta name="description" content="" />

    <script type="text/javascript" src="/static/modules/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/modules/js/swiper.min.js"></script>
    <script type="text/javascript" src="/static/modules/js/common.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/modules/style/css/swiper.min.css">
    <link rel="stylesheet" type="text/css" href="/static/modules/style/css/common.css">
    <link rel="stylesheet" type="text/css" href="/static/modules/style/css/pc.css">
    <style>
        .comment-list ul li.noword {
            flex: 0 0 100%;
            font-size: 0.14rem;
            color: #999;
            background: #e7e7e7;
            line-height: 0.32rem;
            padding: 0 0 0 0.1rem;
            margin-bottom: 0;
            border-radius: 4px;
        }

        .info_head {
            padding: 0 0.1rem;
            background: #ff7902;
            color: #fff;
            border-radius: 4px;
            line-height: 24px;
            margin-top: 0.05rem;
            font-size: 0.12rem;
        }
    </style>
</head>

<body>
    {include file="modules/lib/header" /}
    <div class="site-section clearfix">
        <div class="where jigou">
            <p>相册列表</p>
            <a href="/{$sitecode}" class="iconfont">&#xe617;</a>
        </div>

        <ul class="common-list" id="data">
            <?php  if(!$result_data) { ?>
            <li class="noword">没有相关的相册</li>
            <?php }
			foreach($result_data as $k=>$val){ ?>
            <li>
                <a href="/{$sitecode}/photolist/{$val.id}">
                    <img src="{$val.album_cover_url}">
                    <div class="word">
                        <div class="tit">{$val.album_name}</div>
                        <div class="txt"></div>
                        <div class="info">
                            <div class="view">相片数<span>{$val.photo_num}</span></div>
                            <div class="time">{$val.create_time}</div>
                        </div>
                    </div>
                </a>
                {if condition="$userinfo.ismanage == 1"}
                <input type="button" value="上传图片" class="info_head" data-id="{$val.id}" />
                {/if}
            </li>
            <?php } ?>

        </ul>
        <div id="dataload" class="iconfont iconload" style="display: none">&#xe72f;</div>
        {include file="modules/lib/footer0" /}
    </div>
</body>
<script type="text/javascript" src="/static/js/layer/layer.js"></script>
<script type="text/javascript">

    //==============核心代码=============
    var winH = $(window).height(); //页面可视区域高度

    var ipage = 2;
    var scrollHandler = function () {
        var pageH = $(document).height();
        var scrollT = $(window).scrollTop(); //滚动条top

        if (pageH - winH - scrollT < 1) {
            LoadData(ipage)
            ipage++;
        }
    }
    //定义鼠标滚动事件
    $(window).scroll(scrollHandler);
    //==============核心代码=============

    function LoadData(ipage) {

        $("#dataload").show();
        $(window).unbind('scroll');

        $.ajax({
            url: "/{$sitecode}/album/{$nodeid}/" + ipage + "?&ajax=1",
            type: 'POST',
            // data:,
            cache: false,
            success: function (data) {

                if (data == 11) {
                    $("#dataload").hide();
                    // $("#loadmsg").html("已无更多数据");
                    return;
                }
                $("#dataload").hide();
                $("#data").html($("#data").html() + data);
                $(window).scroll(scrollHandler);
            }
        });

    }




</script>
<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script>
    wx.config({
        debug: false,
        appId: '<?php echo $signPackage["appId"]; ?>',
        timestamp: '<?php echo $signPackage["timestamp"]; ?>',
        nonceStr: '<?php echo $signPackage["nonceStr"]; ?>',
        signature: '<?php echo $signPackage["signature"]; ?>',
        jsApiList: ['chooseImage', 'uploadImage']
    });
    $('.info_head').on('click', function () {
        //获取要上传图片到的相册id
        var albumId = $(this).attr('data-id');
        serverIds = '';
        wx.chooseImage({
            count: 9, // 默认9
            sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
            sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
            success: function (res) {
                var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                // debugger;
                uploadImages(localIds, albumId);
            }
        });
    })
    //上传图片
    function uploadImages(localIds, albumId) {
        //删除图片列表中的最后一张，并返回最后一张图片
        var localId = localIds.pop();
        wx.uploadImage({
            localId: localId,
            isShowProgressTips: 1,
            success: function (res) {
                //将上传到微信返回的图片serverId，拼接
                serverIds += res.serverId + ',';
                //如果还有图片，继续上传
                if (localIds.length > 0) {
                    uploadImages(localIds, albumId);
                } else {
                    $.ajax({
                        url: "/{$sitecode}/uploadalbumphoto/" + albumId,
                        type: "POST",
                        data: { media: serverIds },
                        success: function (data) {
                            if (data.code == 1) {
                                // $('#petavatar').attr('src',data.data.httpimgurls);
                                // avatar = data.data.imgurls;
                                layer.confirm('上传成功，确定可查看图片列表', { btn: ['确定'], btn1: function (index, layero) { window.location = "/{$sitecode}/photolist/" + albumId; return false; } });
                            }
                        }
                    });
                    loading("数据处理中，请稍等！");
                }
            },
        });
    }
    function loading(msg) {
        layer.msg(msg, {
            icon: 16,
            shade: [0.1, '#fff'],
            time: false  //取消自动关闭
        })
    }
</script>

</html>