

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>相册管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" href="__PUBLIC__/layuiadmin/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="__PUBLIC__/layuiadmin/style/admin.css" media="all">
  <style>
    .layui-form-item{
      margin-bottom: 5px;
    }
    .layui-table-cell{
      height: auto;
    }
    .lastcell>a{
      text-decoration: underline;
      color: #333;
      white-space: nowrap;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <div class="layui-fluid">
    <div class="layui-row layui-col-space15">
      <div class="layui-col-md12">
        <div class="layui-card">
          <div class="layui-tab">
            <ul class="layui-tab-title">
              <?php if($cms->CheckPurview('album_manage','view')){ ?>
              <li class="layui-this" onclick="javascript:window.location='{:url('album/index','')}'">相册列表</li>
              <?php } ?>
            </ul>
          </div>

          <!-- 搜索区域 -->
          <div class="layui-card-body">
              <form class="layui-form" action="" lay-filter="component-form-group">
                <div class="layui-form-item">
                  <label class="layui-form-label">相册名称：</label>
                  <div class="layui-input-inline">
                    <input type="text" name="album_name" lay-verify="album_name" autocomplete="off" placeholder="请输入相册名称" class="layui-input" value="{$search['album_name']}">
                  </div>
                </div>
                <div class="layui-form-item">
                  <div class="layui-inline">
                    <label class="layui-form-label">相册状态：</label>
                    <div class="layui-input-inline">
                      <select name="state">
                        <option value="">所有</option>
                        <option value="1" <?php if($search['state']==1) { echo "selected"; } ?> >启用</option>
                        <option value="2" <?php if($search['state']==2) { echo "selected"; } ?> >禁用</option>
                      </select>
                    </div>
                  </div>
                </div>

                <div class="layui-form-item">
                  <div class="layui-inline">
                    <label class="layui-form-label">创建时间：</label>
                    <div class="layui-input-inline">
                      <input name="dtstart" type="text" class="layui-input"   id="test-laydate-start" placeholder="开始日期"  value="{$search['dtstart']}">
                    </div>
                    <div class="layui-form-mid">
                      -
                    </div>
                    <div class="layui-input-inline">
                      <input name="dtend"  type="text" class="layui-input" id="test-laydate-end" placeholder="结束日期"  value="{$search['dtend']}">
                    </div>
                  </div>
                  <div class="layui-inline">
                    <button class="layui-btn layuiadmin-btn-list"  lay-submit lay-filter="LAY-app-contlist-search">
                      <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                    </button>
                  </div>
                </div>
            </div>

            <table class="layui-hide" id="test-table-toolbar" lay-filter="table_action"></table>

            <script type="xt/html" id="test-table-toolbar-toolbarDemo">
            <?php if($cms->CheckPurview('album_manage','add')){ ?>
              <div class="layui-btn-container">
               <button class="layui-btn layui-btn-sm" type="button" onclick="javascript:CustomOpen('{:url('album/modi','&action=add','')}', 'activity','添加相册', 600,500)" >添加相册</button>
              </div>
              <?php } ?>
            </script>


            <script type="text/html" id="test-table-toolbar-barDemo">
              <div class="test-table-toolbar-barDemo" style="white-space:normal;text-align: left;">
                <?php  if($cms->CheckPurview('album_manage','edit') ){ ?>
                <a class="layui-btn layui-btn-xs" href="javascript:CustomOpen('/admin/album/modi/action/edit/id/{{d.id}}','activity','修改相册',600,600)">修改</a>
                <?php } ?>
                <?php  if($cms->CheckPurview('album_manage','delete') ){ ?>
                <a class="layui-btn layui-btn-xs" lay-event="del">删除</a>
                <?php } ?>
                <?php  if($cms->CheckPurview('photo_manage','view') ){ ?>
                <a class="layui-btn layui-btn-xs" href="/admin/album/photo_list/album_id/{{d.id}}">图片管理</a>
                <?php } ?>
              </div>
              
            </script>

            <div style="overflow: hidden" >
              <div id="test-laypage-demo1" style="text-align: right; margin-right: 15px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <script src="__PUBLIC__/layuiadmin/layui/layui.js"></script>
  <script src="__PUBLIC__/layuiadmin/js/public.js"></script>
  <script>
  layui.config({
    base: '__PUBLIC__/layuiadmin/' //静态资源所在路径
  }).extend({
    index: 'lib/index' //主入口模块
  }).use(['index', 'table','laydate','jquery'], function(){
    var laypage = layui.laypage
    ,table = layui.table
    ,laydate = layui.laydate
    ,$ = layui.jquery;

    table.render({
      elem: '#test-table-toolbar'
      ,toolbar: '#test-table-toolbar-toolbarDemo'//左侧工具栏
      ,title: '相册表'
      ,defaultToolbar: ['filter'] //设置右侧工具栏（打印，导出等）

  ,cols: [[
        {field:'album_name', title: '相册名称' }
        ,{field:'album_desc', title: '描述' }
        ,{field:'album_cover_url', title:'相册封面图片', width:190}
        ,{field:'view_count', title:'浏览次数', width:100, unresize: true}
        ,{field:'account_name', title:'创建人', width:100, unresize: true}
        ,{field:'create_time', title:'创建时间', width:160, unresize: true}
        ,{field:'state', title:'相册状态', width:100, unresize: true}
        ,{title:'操作', toolbar: '#test-table-toolbar-barDemo', width:190}
      ]]

        ,data:[
            {volist name="data" id="vo"}
            {
            "id": "{$vo['id']}"
            ,"album_name": "{$vo['album_name']}"
            ,"album_desc": "{$vo['album_desc']}"
            ,"album_cover_url": "<img src=\"{$vo['album_cover_url']}\" alt=\"\" style=\"width: 60px;height: 60px\">"
            ,"view_count": "{$vo['view_count']}"
            ,"account_name": "{$vo['account_name']}"
            ,"create_time": "{$vo['create_time']}"
            ,"state": '{if condition = "$vo['state'] == 1"}启用{else}禁用{/if}'
            },
            {/volist}
            ]
        ,limit: {:$page->pageSize}
    });

      //总页数大于页码总数
      laypage.render({
          elem: 'test-laypage-demo1'
          ,count: {:$page->count}
          ,curr: {:$page->iPage}
          ,limit: {:$page->pageSize}
          ,layout: ['count', 'prev', 'page', 'next', 'skip']
          ,jump: function(obj){
          if(obj.curr!= "{:$page->iPage}"){
              var jumpUrl = "{:$page->url('currentPage')}";
              jumpUrl = jumpUrl.replace("currentPage",obj.curr);
              location.href = jumpUrl;
          }
          }
      });

      //开始日期
      var insStart = laydate.render({
          elem: '#test-laydate-start'
          , done: function (value, date) {
              //更新结束日期的最小日期
              insEnd.config.min = lay.extend({}, date, {
                  month: date.month - 1
              });
              //自动弹出结束日期的选择器
              insEnd.config.elem[0].focus();
          }
      });
      //结束日期
      var insEnd = laydate.render({
          elem: '#test-laydate-end'
          , done: function (value, date) {
              //更新开始日期的最大日期
              insStart.config.max = lay.extend({}, date, {
                  month: date.month - 1
              });
          }
      });

    //头工具栏事件
    table.on('toolbar(table_action)', function(obj){
        if(obj.event === 'add'){
            layer.open({
                type: 2,
                title: '添加相册',
                shadeClose: true,
                shade: 0.8,
                area: ['600px', '600px'],
                content: "{:url('album/modi','&action=add','')}"
            });
        }
    });
    
    //监听行工具事件
    table.on('tool(table_action)', function(obj){
      var data = obj.data;
      if(obj.event === 'del'){
        layer.confirm('真的删除“'+obj.data.album_name+'”行么？', function(index){
          layer.close(index);
            var s = obj.data.id;
            loading("数据删除中，请稍等！");
            $.ajax({
                url:"{:url('album/del')}",
                data:"id="+s,
                type:"post",
                dataType:"json",
                success:function(msg) {
                    if (msg.success) {
                        layer.alert('删除成功', {icon:1});
                        location.reload();
                    }
                    else
                    {
                        layer.alert('删除失败，'+msg.message, {icon: 2});
                    }
                }
            })
        });
      } else if(obj.event === 'edit'){
          layer.prompt({
          formType: 2
          ,value: data.album_desc
        }, function(value, index){
          obj.update({
            email: value
          });
          layer.close(index);
        });
      }
    });

      //监听性别操作
      table.on('switch(test-table-sexDemo)', function(obj){
          var json = JSON.parse(decodeURIComponent($(this).data('json')));
          layer.tips(this.value + ' ' + this.name + '：'+ obj.elem.checked, obj.othis);

          json = table.clearCacheKey(json);
          console.log(json); //当前行数据

      });


  });

  function loading(msg){
      layer.msg(msg, {
          icon:16,
          shade:[0.1, '#fff'],
          time:false  //取消自动关闭
      })
  }

  </script>

</body>
</html>