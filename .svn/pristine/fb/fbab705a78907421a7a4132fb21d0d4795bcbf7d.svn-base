<?php
/**
 * Created by PhpStorm.
 * User: admin
 * Date: 2017/8/3
 * Time: 9:37
 */

namespace app\home\controller;
use think\Exception;
use think\exception\ErrorException;
use think\Image;
use think\Request;
use think\captcha\Captcha;
use think\Url;
use think\Log;
use think\Verify;
use think\Db;
use PHPExcel_IOFactory;
use PHPExcel;
use think\wx\Utils\SHA1;
use app\admin\module\Common;
use app\home\model\Package;
use app\home\model\GroupBuyOrder;
use app\home\model\GroupBuy;
use think\db\Query;
use think\Session;

class Index extends BaseAuth {

    private $PageSize=5;

    public function reg()
    {
        $request = Request::instance()->param();
        if (Request::instance()->isPost())
        {
            $msg=[];
            $msg['state']=0;
            $msg['msg']="";

            $companyname=$request['companyname'];
            $Contacts=$request['Contacts'];
            $Contactstel=$request['Contactstel'];
            $txtICode=$request['txtICode'];
            $verify = new Verify();

            if($companyname=="")
            {
                $msg['msg']="企业名称不能为空";
            }
            else if($Contacts=="")
            {
                $msg['msg']="联系人不能为空";
            }
            else if($Contactstel=="")
            {
                $msg['msg']="联系电话不能为空";
            }
            else if($txtICode=="")
            {
                $msg['msg']="验证码不能为空";
            }
            else if(!$verify->check($txtICode, "loginsn"))
            {
                $msg['msg']="验证码不正确";
            }
            else
            {
                $result = db('reg')->where(array("contactstel"=>$Contactstel))->find();
                if($result)
                {
                    $msg['msg']="联系电话已登记，不能重复登记。";
                }
            }


            if($msg['msg']!="")
            {
                exit(json_encode($msg));
            }


            $arr=[];
            $arr["companyname"]=$companyname;
            $arr["contacts"]=$Contacts;
            $arr["contactstel"]=$Contactstel;
            $arr["cratetime"]=date("Y-m-d H:i:s",time());
            $result = db('reg')->insert($arr);
            if($result)
            {
                $msg['state']=1;
            }
            else
            {
                $msg['msg']="信息保存失败";
            }
            exit(json_encode($msg));
        }
        return $this->fetch('template/reg.html');
    }
    
    public function test()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;

        $api = new \think\wx\Api(
            array(
                'appId' => trim($config['appid']),
                'appSecret'    => trim($config['appsecret']),
            )
        );
        $imgurl= $api->get_qrcode_url_by_str('213556489798798798798');
        $template_url="template/weixin.html";
        $this->assign('msg',"本活动要求关注后才能报名<br>请扫下面二维码关注");
        $this->assign('imgurl',$imgurl);
        return $this->fetch($template_url);

    }
    public function qrcodeurl()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;

        $api = new \think\wx\Api(
            array(
                'appId' => trim($config['appid']),
                'appSecret'    => trim($config['appsecret']),
            )
        );
        $imgurl= $api->get_qrcode_url();
        return $imgurl;
    }
    //首页
    public function index(){
        //session_destroy();
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        if(empty($sitecode))
        {
            echo "站点不存在！";
            exit();
        }
        //确认用户已登陆
        $userid = $this->userinfo['idmember'];

        $config = $this->wxConfig;
        $idsite=$config['id'];
        //cache('config'.$request['idsite']);
        $roottpl = 'template/'.GetConfigVal("weboption","rootdir",$idsite);

        $url=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api( array(
            'appId' => trim($config['appid']),
            'appSecret'    => trim($config['appsecret']),
        ));

        $signPackage=$api->get_jsapi_config($url);
        $this->assign('signPackage',$signPackage);

        if(empty($node_info['templateofnodeindex'])){
            $url = $roottpl.'/'.GetConfigVal("weboption","indexfilename",$idsite); //模版路径
        }else{
            $url = $roottpl.'/'.$node_info['templateofnodeindex'];
        }

        // 签到是否开启
        $is_sign = 0;
        if(checkedMarketingPackage($idsite,'integral')){
            $is_sign = db('integral_rule_config')->where('idsite',$idsite)->value('is_sign');
        }

        // 获取首页拼团数据
        $groupBuys = GroupBuy::getList($idsite);

        //访问记录
        $this->loginCount();

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('groupBuys',$groupBuys);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',1);
        $this->assign('is_sign',$is_sign);
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        return $this->fetch($url);
    }

    public function signin()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $this->assign('state',"2");
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $checkcode=empty($request['checkcode'])?"":$request['checkcode'];
        $id=empty($request['id'])?"":$request['id'];
        $token=$config['token'];
        $strkey=empty($request['key'])?"":$request['key'];
        $flag=empty($request['flag'])?"1":$request['flag'];

        $msg="";
        $row=[];
        $frmdata=[];
        $frmdatasub=[];

        $roottpl = 'template/modules/';
        $this->assign('roottpl','/'.$roottpl);
        $url = $roottpl.'/mine/signin.html';

        $userid=$this->userinfo['idmember'];
        //确认用户已登陆
        if($userid<1)
        {
            $msg="请联系管理，配置好公众号和平台绑定";
        }

        if( $msg=="")
        {
            $userinfo=db("member")->where(array("idmember"=>$userid,'idsite'=>$idsite))->find();
        }


        if (Request::instance()->isPost() && !empty($strkey) && !empty($id) && $msg=="")
        {

            if($strkey!= md5($token.$id))
            {
                exit(json_encode(array("state"=>2,"msg"=>"数据验证不通！")));
            }

            if(empty($userinfo))
            {
                exit(json_encode(array("state"=>2,"msg"=>"管理员账号不存在，请确认后重新签到！！")));
            }
            if($userinfo['ismanage']!=1)
            {
                exit(json_encode(array("state"=>2,"msg"=>"你不是管理，不能为用户签到！")));
            }

            $arr=[];
            $arr["issign"]="1";
            $arr["singntype"]=$flag;//1扫码签到，2输码签到，3电脑签到
            $arr["signuserid"]=$userinfo['idmember'];
            $arr["signusername"]=$userinfo['nickname'];
            $arr["dtsigntime"]=date("Y-m-d H:i:s",time());
            $result = db('order')->where(array('ordersn'=>$id,'idsite'=>$idsite))->update($arr);
            if($result)
            {
                //获取订单信息
                $order = db('order')->where(array('ordersn'=>$id,'idsite'=>$idsite))->find();
                $replace = [];
                //给客户和商务发短信通知    类型：10--签到
                sysSendMsg($idsite, 10, $order, $replace);
                exit(json_encode(array("state"=>1,"msg"=>"签到成功！")));
            }
            else
            {
                exit(json_encode(array("state"=>2,"msg"=>"签到失败！")));
            }
        }

        $strkey="";
        if($msg=="") {
            if (empty($userinfo)) {
                $msg = "管理员账号不存在，请确认后重新签到！";
            } else {
                if ($userinfo['ismanage'] != 1)
                    $msg = "你不是管理，不能为用户签到！";
            }
        }
        if((!empty($id) || !empty($checkcode)) && $msg=="")
        {
            if(empty($checkcode))
            {
                $row = db('order')->where(array('ordersn'=>$id,'idsite'=>$idsite))->find();
            }
            else
            {
                $row = db('order')->where(array('checkcode'=>$checkcode,'idsite'=>$idsite))->find();
            }

            if($row)
            {
                if(!empty($row['txtdata']))
                {
                    $row2= explode("☆", $row['txtfield']);
                    $row1= explode("☆", $row['txtdata']);
                    foreach($row1 as $k=>$vo) {
                        $arr = explode("∫", $row2[$k]);
                        $datatype = 1;
                        $datafield = $arr[0];
                        if (count($arr) > 1) {
                            $datatype = $arr[1];
                        }
                        if($datatype==7)
                        {
                            $frmdata[$datafield]='<img src="'.$vo.'" style="border: 0px;height: 50px;padding: 1px;"  />';
                        }
                        else
                        {
                            $frmdata[$datafield]=$vo;
                        }

                    }
                }
                if(!empty($row['txtdata1'])) {

                    $row2 = explode("☆", $row['txtfield1']);

                    $frmdatasubRow = explode("§", $row['txtdata1']);

                    foreach ($frmdatasubRow as $k1 => $vo) {
                        $row1 = explode("☆", $vo);
                        $frmdata1 = [];
                        foreach ($row1 as $k => $vo) {
                            $arr = explode("∫", $row2[$k]);
                            $datatype = 1;
                            $datafield = $arr[0];
                            if (count($arr) > 1) {
                                $datatype = $arr[1];
                            }
                            if ($datatype == 7) {
                                $frmdata1[$datafield] = '<img src="' . $vo . '" style="border: 0px;height: 50px;padding: 1px;"  />';
                            } else {
                                $frmdata1[$datafield] = $vo;
                            }
                        }
                        $frmdatasub[] = $frmdata1;

                    }
                }
                $strkey= md5($token.$row['ordersn']);
            }
            else
            {
                $msg="没有找到相关订单数据";
            }
        }


        $url1=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api( array(
            'appId' => trim($config['appid']),
            'appSecret'    => trim($config['appsecret']),
        ));

        $signPackage=$api->get_jsapi_config($url1);
        $this->assign('signPackage',$signPackage);

        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('flag',$flag);
        $this->assign('roottpl','/'.$roottpl);
        $this->assign('orderinfo',$row);
        $this->assign('key',$strkey);
        $this->assign('frmdatasub',$frmdatasub);
        $this->assign('frmdata',$frmdata);
        $this->assign('msg',$msg);
        $this->assign('order_state',config('order_state'));
        $this->assign('order_paytype1',config('order_paytype1'));
        return $this->fetch($url);

    }

    /**
     * 签到数据加载
     *
     * @return void
     * @author Chenjie
     * @Date 2019-07-18 15:55:04
     */
    public function signinloaddata(){
        $request = Request::instance()->param();
        $sitecode = $request['sitecode'];
        $config = $this->wxConfig;
        $idsite = $config['id'];
        $url = isset($request['url']) ? $request['url'] : '';
        $flag = isset($request['flag'])? $request['flag'] : 1;
        $checkcode = isset($request['checkcode'])? $request['checkcode'] : '';
        $operation = isset($request['operation'])? $request['operation'] : '';
        $param = explode("/", $url);
        $type = isset($param[2]) ? $param[2] : $request['signintype'];  // 数据类型
        $id = isset($param[3]) ? $param[3] : 0;                       // 数据ID


        $msg = '';              // 提示消息
        $row = [];              // 活动数据
        $frmdata = [];          // 表单数据
        $frmdatasub = [];       // 子表单数据
        $subscriberecord = [];  // 预约记录
        $roottpl = '';          // 模板目录
        $template_url = '';     // 模板地址
        // 活动签到
        if($type == 'signin'){
            // 活动签到数据加载
            if((empty($operation) && !empty($id) || empty($operation) && !empty($checkcode)))
            {
                if($id){
                    $row = db('order')->where(array('ordersn'=>$id,'idsite'=>$idsite))->find();
                }else{
                    $row = db('order')->where(array('checkcode'=>$checkcode,'idsite'=>$idsite))->find();
                }
                if($row)
                {
                    if(!empty($row['txtdata']))
                    {
                        $row2= explode("☆", $row['txtfield']);
                        $row1= explode("☆", $row['txtdata']);
                        foreach($row1 as $k=>$vo) {
                            $arr = explode("∫", $row2[$k]);
                            $datatype = 1;
                            $datafield = $arr[0];
                            if (count($arr) > 1) {
                                $datatype = $arr[1];
                            }
                            if($datatype==7)
                            {
                                $frmdata[$datafield]='<img src="'.$vo.'" style="border: 0px;height: 50px;padding: 1px;"  />';
                            }
                            else
                            {
                                $frmdata[$datafield]=$vo;
                            }
    
                        }
                    }
                    if(!empty($row['txtdata1'])) {
    
                        $row2 = explode("☆", $row['txtfield1']);
    
                        $frmdatasubRow = explode("§", $row['txtdata1']);
    
                        foreach ($frmdatasubRow as $k1 => $vo) {
                            $row1 = explode("☆", $vo);
                            $frmdata1 = [];
                            foreach ($row1 as $k => $vo) {
                                $arr = explode("∫", $row2[$k]);
                                $datatype = 1;
                                $datafield = $arr[0];
                                if (count($arr) > 1) {
                                    $datatype = $arr[1];
                                }
                                if ($datatype == 7) {
                                    $frmdata1[$datafield] = '<img src="' . $vo . '" style="border: 0px;height: 50px;padding: 1px;"  />';
                                } else {
                                    $frmdata1[$datafield] = $vo;
                                }
                            }
                            $frmdatasub[] = $frmdata1;
    
                        }
                    }
                }
                else
                {
                    exit("没有找到相关订单数据");
                }
            }

            // 活动点击签到
            if ($operation=='signin' && !empty($id) || $operation=='signin' && !empty($checkcode))
            {
                $userid = $this->userinfo['idmember'];
                if(empty($userid) || $userid<1)
                {
                    exit(json_encode(array("state"=>2,"msg"=>"管理员账号不存在，请确认后重新签到。")));
                }
        
                if($msg=="")
                {
                    $userinfo=db("member")->where(array("idmember"=>$userid,'idsite'=>$idsite))->find();
                }

                if(empty($userinfo))
                {
                    exit(json_encode(array("state"=>2,"msg"=>"管理员账号不存在，请确认后重新签到！！")));
                }
                if($userinfo['ismanage']!=1)
                {
                    exit(json_encode(array("state"=>2,"msg"=>"你不是管理，不能为用户签到！")));
                }
    
                $arr=[];
                $arr["issign"]="1";
                $arr["singntype"]= !empty($id) ? 1 : 2;//1扫码签到，2输码签到，3电脑签到
                $arr["signuserid"]=$userinfo['idmember'];
                $arr["signusername"]=$userinfo['nickname'];
                $arr["dtsigntime"]=date("Y-m-d H:i:s",time());
                $map = [
                    'idsite'=>$idsite,
                ];
                if($id){
                    $map['ordersn'] = $id;
                }else{
                    $map['checkcode'] = $checkcode;
                }
                $result = db('order')->where($map)->update($arr);
                if($result)
                {
                    //获取订单信息
                    $order = db('order')->where($map)->find();
                    $replace = [];
                    //给客户和商务发短信通知    类型：10--签到
                    sysSendMsg($idsite, 10, $order, $replace);
                    exit(json_encode(array("state"=>1,"msg"=>"签到成功！")));
                }
                else
                {
                    exit(json_encode(array("state"=>2,"msg"=>"签到失败！")));
                }
            }
            $roottpl = 'template/modules/';
            $template_url = $roottpl.'/mine/ajax_signin.html';
        }else if($type == 'subscribe'){
            // 预约签到数据加载
            if(empty($operation) && !empty($id) || empty($operation) && !empty($checkcode))
            {
                if(empty($checkcode))
                {
                    $subscriberecord = db('subscribe_record')->where(array('id'=>$id,'siteid'=>$idsite))->find();
                }
                else
                {
                    $subscriberecord = db('subscribe_record')->where(array('checkcode'=>$checkcode,'siteid'=>$idsite))->find();
                }
    
                if(!$subscriberecord)
                {
                    exit("没有找到相关预约数据");
                }
            }
            // 预约点击签到
            if ($operation=='subscribe' && !empty($id) || $operation=='subscribe' && !empty($checkcode))
            {
                $userid = $this->userinfo['idmember'];
                if(empty($userid) || $userid<1)
                {
                    $msg = "管理员账号不存在，请确认后重新签到。";
                }
        
                if($msg=="")
                {
                    $userinfo=db("member")->where(array("idmember"=>$userid,'idsite'=>$idsite))->find();
                }

                if(empty($userinfo))
                {
                    exit(json_encode(array("state"=>2,"msg"=>"管理员账号不存在，请确认后重新签到！！")));
                }
                if($userinfo['ismanage']!=1)
                {
                    exit(json_encode(array("state"=>2,"msg"=>"你不是管理，不能为用户签到！")));
                }
    
                $arr=[];
                $arr["is_signin"] = 1;
                $arr["signin_way"] = !empty($id) ? 1 : 2;//1扫码签到，2输码签到，3电脑签到
                $arr["signin_member_id"] = $userinfo['idmember'];
                $arr["signin_member_nickname"] = $userinfo['nickname'];
                $arr["signin_time"] = time();
                $map = [
                    'siteid'=>$idsite,
                ];
                if($id){
                    $map['id'] = $id;
                }else{
                    $map['checkcode'] = $checkcode;
                }
                $result = db('subscribe_record')->where($map)->update($arr);
                if($result)
                {
                    $subscribe_record = db('subscribe_record')->where($map)->find();
                    $mobile = db('subscribe_member_cart')->where('id',$subscribe_record['member_cart_id'])->value('mobile');
                    $week = isset($subscribe_record['week']) ? $subscribe_record['week'] : '';
                    $period = isset($subscribe_record['week']) ? $subscribe_record['period'] : '';
                    $place = isset($subscribe_record['place']) ? $subscribe_record['place'] : '';
                    $replace = [
                        '{title}' => $subscribe_record['subscribe_object_name'].$week.$period.$place,
                        '{name}' => $subscribe_record['member_nickanme'] ?: '',
                    ];
                    sysSendMsg($idsite, 13, [], $replace, $mobile);
                    exit(json_encode(array("state"=>1,"msg"=>"签到成功！")));
                }
                else
                {
                    exit(json_encode(array("state"=>2,"msg"=>"签到失败！")));
                }
            }
            $roottpl = 'template/modules/';
            $template_url = $roottpl.'/subscribe/ajaxsubscribesignin.html';
        }

        $this->assign('checkcode',$checkcode);
        $this->assign('signintype',$type);
        $this->assign('url',$url);
        $this->assign('sitecode',$sitecode);
        $this->assign('orderinfo',$row);
        $this->assign('frmdatasub',$frmdatasub);
        $this->assign('frmdata',$frmdata);
        $this->assign('subscriberecord',$subscriberecord);
        $this->assign('order_state',config('order_state'));
        $this->assign('order_paytype1',config('order_paytype1'));
        return $this->fetch($template_url);
    }

    public function usermodi()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];

        $config=$this->wxConfig;
        $idsite=$config['id'];
        $roottpl = 'template/modules/';
        $url = $roottpl.'/mine/usermodi.html';

        $userid=$this->userinfo['idmember'];
        if (Request::instance()->isPost())
        {
            $data=[];
            $data['chraccount']=$request['chraccount'];
            $data['chrname']=$request['chrname'];
            $data['nickname']=$request['nickname'];
            $data['chrtel']=$request['chrtel'];
            $data['chrmail']=$request['chrmail'];
            $bool=db('member')->where(array('idmember'=>$userid,'idsite'=>$idsite))->update($data);
            if($bool)
                echo "1";
            else
                echo "0";
            exit();
        }

        $row=db('member')->where(array('idmember'=>$userid,'idsite'=>$idsite))->find();

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('userinfo',$row);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',1);
        return $this->fetch($url);

    }

    // 机构二维码
    public function siteqrcode(){
        $request = Request::instance()->param();
        $sitecode = $request['sitecode'];
        $config = $this->wxConfig;
        $idsite = $config['id'];
        $roottpl = 'template/modules/';

        $api = new \think\wx\Api([
            'appId' => trim($config['appid']),
            'appSecret'    => trim($config['appsecret']),
        ]);

        // 生成二维码
        $site_qrcode_url = cache("site_".$idsite."_qrcode_url");
        if(!$site_qrcode_url){
            $qrocde  = $api->create_qrcode($idsite)[1];
            if($qrocde){
                $ticket = $qrocde->ticket;
                $qrocde_url = $api->get_qrcode_url($ticket);
                cache("site_".$idsite."_qrcode_url",$qrocde_url);
            }
        }
        
        $url = $roottpl.'/mine/siteqrcode.html';
        $this->assign("site_qrocde_url", $site_qrcode_url);
        return $this->fetch($url);
    }

    //内容列表页面
    public function lists(){
        $request = Request::instance()->param();
        //检测是否需要登录才能浏览
        //if(strstr($node_info['option'],'3')){
        //    return "请登录";
        //}
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        if(isset($request['p'])){
            $ipage = $request['p'];

        }else{
            $ipage = 1;
        }
        $pagesize = 10;
        $this->assign("ipage",$ipage);


        $node_info = db('node')->where('idsite='.$idsite.' and nodeid='.$request['nodeid'])->find();
        if(empty($node_info))
        {
            header("location:/error.php?msg=".urlencode("栏目不存在，有疑问请和管理联系！")."&url=".urlencode("/".$sitecode));
            exit();
        }

        $obj = new \app\admin\module\activity($idsite);

        $zxbq=$obj->getDic("zxbq");
        $bq=[];
        foreach($zxbq as $v){
            $bq[$v['code']]=$v['name'];
        }
        $this->assign('zxbq',$bq);


        //获得栏目列表模版路径
        $roottpl = 'template/modules/';
        if(empty($node_info['templateofnodelist'])){
            $url =  $roottpl.'/'.GetConfigVal("weboption","columnlist",$idsite); //模版路径
        }else{
            $url =  $roottpl.'/'.$node_info['templateofnodelist'];
        }

        if (Request::instance()->isPost() && isset($request['ajax'])) {
            // echo json_encode($request);exit;
            $url = $roottpl . '/node/ajax_index_list.html';
        }
        $this->assign('roottpl','/'.$roottpl);
        $this->assign('nodeid',$request['nodeid']);
        $this->assign('node_info',$node_info);
        $this->assign('pageSize',$pagesize);
        $this->assign('idsite',$idsite);
        $this->assign('pageIndex',$ipage);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',1);
        return $this->fetch($url);
    }

    //活动
    public function activity(){
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];

        $config=$this->wxConfig;
        $idsite=$config['id'];
        $nodeid=$request['nodeid'];
        $typeid=isset($request['typeid'])?$request['typeid']:"";
        $tagid=isset($request['tagid'])?$request['tagid']:"";

        $intflag=isset($request['intflag'])?$request['intflag']:"1";

        if(isset($request['p'])){
            $ipage = $request['p'];
        }else{
            $ipage = 1;
        }
        $pagesize = 10;

        $node_info = db('node')->where('idsite='.$idsite.' and nodeid='.$request['nodeid'])->find();
        if(empty($node_info))
        {
            header("location:/error.php?msg=".urlencode("栏目不存在，有疑问请和管理联系！")."&url=".urlencode("/".$sitecode));
            exit();
        }

        $search=[];
        $search['siteid']= $idsite;
        $search['chkdown']=array('neq',1);
        $search['intflag'] = 2;
        $search['nodeid'] = $nodeid;

        if(!empty($typeid)) $search['fidtype']=$typeid;
        if(!empty($tagid)) $search['chrtags']= array('like', "%,".$tagid.",%");
        if($intflag=="1")
        {
            $search['dtsignetime']=array('>',date('Y-m-d H:i:s',time()));
        }
        else if($intflag=="2")
        {
            $search['dtsignetime']=array('<',date('Y-m-d H:i:s',time()));
        }
        $offset = ($ipage - 1) * $pagesize;
        $show_field="idactivity,chrtitle,chrimg_m,chrimg,chrurl,chrsummary,dtstart,dtpublishtime,hits,s.is_receive_cashed,a.usertype,a.idactivity";
        $result = db('activity')->alias('a')->join('activity_cashed_card_set s','a.idactivity=s.activity_id','left')->where($search)->order("chkcontentlev desc,contentlevtime desc,dtpublishtime desc")->field($show_field)->limit($offset,$pagesize)->select();
        //dump($result);
        //获得栏目列表模版路径
        $roottpl = 'template/modules/';
        $url =  $roottpl.'/activity/index.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            // echo json_encode($result);exit;
            $url = $roottpl . '/activity/ajax_index_list.html';
        }

        $obj = new \app\admin\module\activity($idsite);

        $hdfl=$obj->getDic("hdfl");
        $this->assign('hdfl',$hdfl);
        $hdbq=$obj->getDic("hdbq");
        $this->assign('hdbq',$hdbq);
        $this->assign('roottpl','/'.$roottpl);
        $this->assign('typeid',$typeid);
        $this->assign('tagid',$tagid);
        $this->assign('intflag',$intflag);
        $this->assign('pageSize',$pagesize);
        $this->assign('node_info',$node_info);
        $this->assign('idsite',$idsite);
        $this->assign('result_data',$result);
        $this->assign('pageIndex',$ipage);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',2);
        $this->assign('nodeid',$nodeid);
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));



        return $this->fetch($url);
    }

    //活动详情页面
    public function detail(){
        $request = Request::instance()->param();
        $id = $request['id']; // 当前内容id
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $userid=$this->userinfo['idmember'];
        $link_url='';
        $link_img='';

        if(empty( $request['type'])) {

        }
        //检测它的父节点是否需要登录才能浏览
        //$content_info = db('activity')->where('idactivity='.$id)->field('siteid')->find();

        //$comment_list = db('comment')->where('id='.$id.' and intlock=1')->select();
        $roottpl = 'template/modules/';

        $url=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api( array(
            'appId' => trim($config['appid']),
            'appSecret'    => trim($config['appsecret']),
        ));

        $signPackage=$api->get_jsapi_config($url);
        $this->assign('signPackage',$signPackage);
        $bmflag=0;
            // if(!empty( $request['type'])) {
            $activity = $datainfo=db("activity")->field("chkissubscribe, idactivity,usertype,chrimg,is_distribution,chrimg_m")->where(array('idactivity'=>$id))->find();
            if($datainfo["chkissubscribe"]==1)      //需要关注
            {
                if(empty($userid))
                {
                    $bmflag=1;
                }else
                {
                    $datainfo=db("member")->field("intstate")->where(array('idmember'=>$userid,'intstate'=>1))->find();
                    if(empty($datainfo))
                    {
                        $bmflag=2;
                    }
                }
            }
            //查询该活动的现金券设置信息
        $activity_cashed = db("activity_cashed_card_set")->where(array('activity_id'=>$id,'is_receive_cashed'=>1))->find();

        // 查询活动中的拼团
        $packages = db('package')->where([
                'activity_id' => $activity['idactivity'],
                'expire_at'=>['gt',time()]
            ])
            ->field([
                'package_id',
                'member_price',
                'concat_ws(" ", keyword1, keyword2) package_name'
            ])
            ->select();
        $groupBuys = [];
        $groupBuyOrders = [];
        $now = time();
        // 已成团数量
        foreach ($packages as $key => $package)
        {
            $tmpGroupBuys = db('group_buy')->where([
                    'package_id' => $package['package_id'],
                    'state' => 1,
                    'start_at' => ['elt', $now],
                    'end_at' => ['egt', $now],
                ])
                ->field([
                    'group_buy_id',
                    'group_num',
                    'group_buy_price',
                    'end_at - ' . $now . ' expiration',
                    '\'' . $package['member_price'] . '\'' . ' member_price',
                    '\'' . $package['package_name'] . '\'' . ' package_name'
                ])
                ->select();
            $groupBuys = array_merge($groupBuys, $tmpGroupBuys);

            // 获取已开的拼团
            $groupBuyIds = array_column($tmpGroupBuys, 'group_buy_id');
            if(!$groupBuyIds)
            {
                continue;
            }

            $now1=time();
            $query = new Query;
            $tmpGroupBuyOrders = db('group_buy_order')->where([
                    'group_buy_id' => ['in', $groupBuyIds],
                    'state' => 1,
                    'group_num' => ['gt', $query->raw('sold')],
                    'expire_at' => ['egt', time()]
                ])
                ->field([
                    'group_num - sold left_num',
                    'group_buy_order_id',
                    'group_buy_id',
                    '\'' . $package['package_name'] . '\'' . ' package_name',
                    "expire_at - $now1 expiration"
                ])
                ->select();
            // 获取团长信息
            foreach ($tmpGroupBuyOrders as $key => $tmpGroupBuyOrder)
            {
                $firstOrder = db('order')->where([
                        'group_buy_order_id' => $tmpGroupBuyOrder['group_buy_order_id'],
                        // 4.已报名 已支付，
                        // 5.已报名 退款中，
                        // 6已部分退款 继续服务，
                        // 7已退款 继续服务，
                        // 8.已报名 退款不通过，
                        'state' => ['in', [4,5,6,7,8]]
                    ])
                    ->field(['fiduser','state'])
                    ->order('id asc')
                    ->find();
                if(empty($firstOrder)){
                    unset($tmpGroupBuyOrders[$key]);
                    continue;
                }
                //如果第二个待支付的人未付款，第三个却付款了，团长如何改变？
                    $user = db('member')->where(['idmember' => $firstOrder['fiduser']])->field(['userimg', 'nickname'])->find();
                    $tmpGroupBuyOrder['userimg'] = $user['userimg'];
                    $tmpGroupBuyOrder['username'] = $user['nickname'];
                    $groupBuyOrders[] = $tmpGroupBuyOrder;
            }

        }

        $completeGroupNum = db('group_buy_order')->where([
                'group_buy_id' => ['in', array_column($groupBuys, 'group_buy_id')],
                'state' => 2
            ])
            ->count();

        $visitflag=0;
        if($userid>0)
        {
            $visitinfo=db("collection")->where(array('dataid'=>$id,'userid'=>$userid,'flag'=>2))->find();
            if($visitinfo)
                $visitflag=1;

        }

        //判断用户是否有权限可以查看此详情页

        if(!empty($activity['usertype'])){
            //.获取用户分类
            $userid=$this->userinfo['idmember'];
            $usertype=db('member')->where(['idmember'=>$userid])->column('categoryid');
            $usertype=$usertype[0];
            //获取活动的用户权限
            $activityusertype=$activity['usertype'];
            //获取分类的名字
            $obj = new \app\admin\module\activity($idsite);
            $hyfl=$obj->getDic("hyfl");
            $type=[];
            foreach($hyfl as $v){
                $type[$v['id']]=$v['name'];
            }
            $usertypename='';
            foreach (explode(',',trim($activityusertype,',')) as $v){
                $usertypename=$usertypename.$type[$v].',';
            }
            $usertypename=rtrim($usertypename,',');
            if(strpos($activityusertype,','.$usertype.',') == false){
                $usertypeflag=1;
                $this->assign('usertypeflag',$usertypeflag);
                $this->assign('usertype',$usertypename);
            }
        }

        
        //获得栏目列表模版路径
        $url =$roottpl.'/activity/detail.html';

        $user_info=db("member")->field("intstate",true)->where(array('idmember'=>$userid))->find();

        //查询该用户对该活动的领取情况
        $user_receive_info = db('cashed_card_receive')->field('id')->where(['receive_member_id'=>$userid,'cashed_type'=>2,'receive_activity_id'=>$id,'site_id'=>$idsite])->find();

        $share_id = 0;

        //判断链接进来的人是不是代言人并且开启了分销
        if(checkedMarketingPackage($idsite,'distribution')){
            //如果是代言人并且该活动开启了活动代言
            if($user_info['spokesman_grade'] != 0 && $activity['is_distribution'] == 1){
                $link_url = ROOTURL."/{$sitecode}/detail/{$id}?share_id={$userid}";
                //分享图片为分享人的头像
//                $link_img = $user_info['userimg'];
                //2019年8月26号将用户的头像换成了固定的图片
                $link_img = ROOTURL.'/static/images/share_postman.jpg';
                if(array_key_exists('share_id',$request)){
                    $share_id = $request['share_id'];
                }
                //普通人进来
            }else{
                //当前页面
                $link_url = ROOTURL.$_SERVER['REQUEST_URI'];
                //分享图片为活动的小图片
                $link_img = ROOTURL."{$activity['chrimg_m']}";
                if(array_key_exists('share_id',$request)){
                    $share_id = $request['share_id'];
                }
            }
            //默认正常的活动分享
        }else{
            //当前页面
            $link_url = ROOTURL.$_SERVER['REQUEST_URI'];
            //分享图片为活动的小图片
            $link_img = ROOTURL."{$activity['chrimg_m']}";
        }
        $a = 0;
        //看是否有通过海报二维码进来的
        if(array_key_exists('a',$request)){
            $a = $request['a'];
        }

        $this->assign('roottpl','/'.$roottpl);
        //$this->assign('comment_list',$comment_list);
        $this->assign('bmflag',$bmflag);
        $this->assign('qrcodeurl',$this->qrcodeurl());
        $this->assign('idsite',$idsite);
        $this->assign('visitflag',$visitflag);
        $this->assign('id',$id);
        $this->assign('groupBuys',$groupBuys);
        $this->assign('groupBuyOrders',$groupBuyOrders);
        $this->assign('completeGroupNum',$completeGroupNum);
        $this->assign('sitecode',$this->getsitecode($idsite));
        $this->assign('activity_cashed',$activity_cashed);
        $this->assign('SelectFooterTab',2);
        $this->assign('user_info',$user_info);
        $this->assign('link_url',$link_url);
        $this->assign('link_img',$link_img);
        $this->assign('share_id',$share_id);//分销的用户id
        $this->assign('a',$a);//二维码的用户id
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        $this->assign('is_distribution',checkedMarketingPackage($idsite,'distribution'));
        $this->assign('user_receive_info',$user_receive_info);
        return $this->fetch($url);
    }

    //活动详情领取优惠券的页面(因为改过授权的继承,这里是将这个ajax请求还原在index处)
    public function receive_cashed(){
        $request = Request::instance()->param();
        $id = $request['id']; // 当前活动id
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        //判断是否开启了现金券营销包
        if(!checkedMarketingPackage($idsite,'cashed')){
            return json(['success'=>false,'message'=>'优惠券功能还没开通！']);
        }
        $roottpl = 'template/modules/';

        $url=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api( array(
            'appId' => trim($config['appid']),
            'appSecret'    => trim($config['appsecret']),
        ));

        $signPackage=$api->get_jsapi_config($url);
        $this->assign('signPackage',$signPackage);
        $bmflag=0;
        $userid=$this->userinfo['idmember'];
        //先查询活动的信息
        $activity_info=db("activity")->field('chrcontent',true)->where(array('idactivity'=>$id,'siteid'=>$idsite))->find();
        if(!$activity_info){
            return json(['success'=>false,'message'=>'该活动信息丢失']);
        }
        //查询该活动的现金券设置信息
        $activity_cashed = db("activity_cashed_card_set")->where(array('activity_id'=>$id,'is_receive_cashed'=>1))->find();
        if(!$activity_cashed){
            return json(['success'=>false,'message'=>'该活动的现金券设置信息丢失']);
        }
        //查询用户的信息
        $user_info = db("member")->field("dtbirthday",true)->where(array('idmember'=>$userid))->find();
        //看可领券的系统用户类型设置
        if($activity_cashed['receive_activity_cashed_intstate_user']){
            $receive_activity_cashed_intstate_user = explode(',',$activity_cashed['receive_activity_cashed_intstate_user']);
            //看用户的状态
            if(!in_array($user_info['intstate'],$receive_activity_cashed_intstate_user)){
                return json(['success'=>false,'message'=>'抱歉，您不符合领取条件']);
            }
        }
        //看可领券的自定义用户分类设置
        if($activity_cashed['receive_activity_cashed_categoryid']){
            $receive_activity_cashed_categoryid = explode(',',$activity_cashed['receive_activity_cashed_categoryid']);
            if(!in_array($user_info['categoryid'],$receive_activity_cashed_categoryid)){
                return json(['success'=>false,'message'=>'抱歉，您不符合领取条件']);
            }
        }
        //查询该用户对该活动的领取情况
        $user_receive_info = db('cashed_card_receive')->field('id')->where(['receive_member_id'=>$userid,'cashed_type'=>2,'receive_activity_id'=>$id,'site_id'=>$idsite])->find();
        if($user_receive_info){
            return json(['success'=>false,'message'=>'您好，您已经领取该现金券，本现金券每个用户只能领取一次，谢谢！']);
        }
        //进行封装添加领取记录的数据
        $add_receive_param['create_time'] = date('Y-m-d H:i:s',time());//领取时间
        $add_receive_param['receive_activity_id'] = $id;//领取活动id
        // 保证不会有重复领取编号存在
        while (true) {
            $receive_no = date('YmdHis') . rand(100000, 999999); // 订单编号
            $receive_no_count = db('cashed_card_receive')->where("receive_no = '$receive_no'")->count();
            if ($receive_no_count == 0)
                break;
        }
        $add_receive_param['receive_no'] = $receive_no;//领取编号
        $add_receive_param['cashed_type'] = 2;//现金券类型
        $add_receive_param['cashed_amount'] = $activity_cashed['activity_cashed_amount'];//现金券金额
        $add_receive_param['cashed_validity_time'] = date('Y-m-d H:i:s',strtotime(" + {$activity_cashed['activity_cashed_validity']} day",time()));//有效期时间
        $add_receive_param['cashed_validity_day'] = $activity_cashed['activity_cashed_validity'];//有效期天数
        $add_receive_param['receive_cashed_name'] = '活动专用现金券';//领取的现金券标题
        $add_receive_param['receive_activity_name'] = $activity_info['chrtitle'];//领取来源（活动名称）
        $add_receive_param['receive_member_id'] = $userid;//领取人会员id（用户）
        $add_receive_param['receive_nick_name'] = $user_info['nickname'];//领取人的昵称
        $add_receive_param['receive_header_image'] = $user_info['userimg'];//领取人的头像
        $add_receive_param['receive_source'] = 1;//领取渠道
        $add_receive_param['used_status'] = 1;//使用状态
        $add_receive_param['site_id'] = $idsite;//站点id
        //执行插入数据
        $bool = db('cashed_card_receive')->insert($add_receive_param);
        if($bool){
            return json(['success'=>true,'message'=>'领取成功，可前往报名页面直接使用']);
        }else{
            return json(['success'=>false,'message'=>'领取失败']);
        }
    }


    /**
     * 手动取消订单
     * @return \think\response\Json
     * @throws \think\exception\PDOException
     */
    public function cancel_order(){
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $userID=$this->userinfo['idmember'];
        $err_arr = [];
        //查询该用户的待支付订单
        $expiredOrders = db('order')->where(
            [
                'state' => 12,
                'stock_locked' => 1,
                'fiduser' => $userID,
                'id' => $request['id'],
            ]
        )
            ->field(
                [
                    'id',
                    'package_id',
                    'paynum',
                    'receive_cashed_id',
                    'group_buy_order_id',
                ]
            )
            ->find();
        if(!$expiredOrders){
            return json(['code'=>0,'msg'=>'未找到该用户的有效订单']);
        }

        try
        {
            $query = new Query;
            $query->startTrans();
            //判断是否为团购活动，
            if($expiredOrders['group_buy_order_id'] != '' && $expiredOrders['group_buy_order_id'] != 0)
            {
                // 拼团订单，释放库存路径不同
                $groupBuyOrder = new GroupBuyOrder;
                $res = $groupBuyOrder->releaseGroupBuyOrderStock($expiredOrders['group_buy_order_id'], $expiredOrders['paynum']);
            }else
            {
                $res = changeStock($expiredOrders['package_id'], $expiredOrders['paynum'], false);
            }
            //$res = changeStock($expiredOrders['package_id'], $expiredOrders['paynum'], false);
            if($res)
            {
                db('order')->where(['id' => $expiredOrders['id']])->update(['stock_locked' => 0,'state'=>10]);//改为终止服务
            }
            //判断该订单是否使用了现金券
            if($expiredOrders['receive_cashed_id'] != ''){
                $receive_cashed_id_arr = explode(',',$expiredOrders['receive_cashed_id']);
                foreach ($receive_cashed_id_arr as $value){
                    //将现金券进行释放(修改为未使用)
                    db('cashed_card_receive')->where(['id'=>$value])->update(['used_status'=>1,'release_time'=>date('Y-m-d H:i:s',time())]);
                }
            }
            $query->commit();
        }catch(Exception $e)
        {
            Log::error('释放未支付订单库存失败，订单号为' . $expiredOrders['id']);
            $query->rollBack();
        }
        return json(['code'=>1,'msg'=>'取消成功']);

    }

    /**
     * 再一次修改(提交)订单
     * @return   html
     */
    public function again_order()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $userID=$this->userinfo['idmember'];
        $order_id=$request['id'];

        $userinfo=db('member')->where(array('idmember'=>$userID,'intstate'=>['neq',2]))->find();

        $config=$this->wxConfig;
        $idsite=$config['id'];
        $activity_cashed = [];
        $cashed_list_count = [];
        $cashed_list = [];
        $err_arr = [];//错误信息
        $total = 0;
        //查询订单信息
        $order_info = db('order')->where(['id' => $order_id,'fiduser'=>$userID])->find();

        $groupBuyId = '';
        $groupBuyOrderId = '';
        if(!empty($order_info['group_buy_order_id']) && $order_info['group_buy_order_id']!=0)
        {
            $groupBuyOrderId = $order_info['group_buy_order_id'];
            $groupinfo=db('group_buy_order')->where(['group_buy_order_id' => $groupBuyOrderId])->field(['group_buy_id','state','group_num'])->find();
            $groupBuyId = $groupinfo['group_buy_id'];
            $groupBuyOrderState=$groupinfo['state'];
            if($groupBuyOrderState ==0){
                //开团
                $this->assign('groupjoin',0);
                $this->assign('group_num',$groupinfo['group_num']);
//                dump($groupjoin);
            }elseif($groupBuyOrderState ==1){
                $this->assign('groupjoin',1);
//                dump($groupjoin);
            }
        }
        if(!$order_info){
            $err_arr = ['err'=>'未找到该用户的订单'];
        }else{
            $time = date('Y-m-d H:i:s',time());
            //查询该订单购买的活动信息(已上架并且开启报名)
            $activity_info = db('activity')->where(['idactivity'=>$order_info['dataid'],'intflag'=>2,'chksignup'=>1])->find();
            if(!$activity_info){
                $err_arr = ['err'=>'该活动不处于已上架状态或者未开启报名'];
            }else{
                //判断活动是否还处于可以报名
                if(time() < strtotime($activity_info['dtstart']) || time() > strtotime($activity_info['dtend'])){
                    $err_arr = ['err'=>'抱歉，该活动已结束'];
                }
                if(time() < strtotime($activity_info['dtsignstime']) || time() > strtotime($activity_info['dtsignetime'])){
                    $err_arr = ['err'=>'抱歉，该活动未处于允许的下单时间内'];
                }else{
                    //查询该活动的设置可用券的情况
                    $activity_cashed = db("activity_cashed_card_set")->where(array('activity_id'=>$order_info['dataid'],'is_use_cashed'=>1))->find();
                    if($activity_cashed){
                        //查询用户的可用现金券的列表
                        $where['site_id'] = ['=',$idsite];
                        $where['receive_member_id'] = ['=',$userID];
                        $where['cashed_validity_time'] = ['>=',$time];
                        $where_str = "(cashed_type = 2 and receive_activity_id = {$order_info['dataid']} ) or (cashed_type in(1,3,4) and used_status = 1)";
                        if($order_info['receive_cashed_id']){
                            //2019年7月25修改为  将该订单冻结的现金券也展示出来
                            $where_str .= "or (id in({$order_info['receive_cashed_id']}) and used_status = 10)";
                        }
                        $cashed_list = db('cashed_card_receive')->field('freeze_time',true)->where($where)->where($where_str)->order('create_time desc')->select();
//                        die($cashed_list);
                        $cashed_list_count = db('cashed_card_receive')->where($where)->where($where_str)->count();
                    }else{
                        $cashed_list = [];
                        $cashed_list_count = 0;
                    }
                }
            }
            //总表单
            $frmdata=[];

            if($order_info && !empty($order_info['txtdata']))
            {
                //处理总表单的字段和值
                $row2= explode("☆", $order_info['txtfield']);//字段
                $row1= explode("☆", $order_info['txtdata']);//值
                foreach($row1 as $k=>$vo) {
                    $arr = explode("∫", $row2[$k]);
                    $datatype = 1;
                    $datafield = $arr[0];
                    if (count($arr) > 1) {
                        $datatype = $arr[1];
                    }
                    $frmdata[$datafield]=$vo;

                }
            }
            //子表单
            $frmdatasub=[];

            if($order_info && !empty($order_info['txtdata1']))
            {
                //分割子表单字段
                $row2= explode("☆", $order_info['txtfield1']);
                //分割子表单的值  一个子表单字段会存在多个的情况
                $frmdatasubRow=explode("§", $order_info['txtdata1']);

                foreach ($frmdatasubRow as $k1=>$vo)
                {
                    //分割每一个子表单字段的值
                    $row1= explode("☆", $vo);
                    $frmdata1=[];
                    foreach($row1 as $k=>$vo) {
                        $arr = explode("∫", $row2[$k]);
                        $datatype = 1;
                        $datafield = $arr[0];
                        if (count($arr) > 1) {
                            $datatype = $arr[1];
                        }
                        $frmdata1[$datafield]=$vo;
                    }
                    $frmdatasub[]=$frmdata1;

                }

            }
            $total = count($frmdatasub);
        }

        if(!empty($order_info['group_buy_order_id']) && $order_info['group_buy_order_id']!=0)
        {
            $activity_cashed = [];
        }

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径
        $url =$roottpl.'/order/again_order.html';

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('userinfo',$userinfo);
        $this->assign('sitecode',$sitecode);
        $this->assign('err_arr',$err_arr);//错误信息
        $this->assign('id', $order_info['dataid']);//活动id
        $this->assign('activity_cashed',$activity_cashed);
        $this->assign('cashed_list_count',$cashed_list_count);//现金券条数
        $this->assign('cashed_list',$cashed_list);//现金券列表
        $this->assign('frmdatasub',$frmdatasub);//子表单
        $this->assign('frmdata',$frmdata);//总表单
        $this->assign('total',$total);//总表单
        $this->assign('order_id',$order_id);//订单id
        $this->assign('order_info',$order_info);//订单信息
        $this->assign('groupBuyOrderId',$groupBuyOrderId);//订单信息
        $this->assign('groupBuyId',$groupBuyId);//订单信息
//        var_dump($frmdatasub);exit;
        $this->assign('SelectFooterTab',2);
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        return $this->fetch($url);
    }

    public function waiter(){
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径
        $url =$roottpl.'/activity/waiter.html';
        $flag=empty($request['flag'])?0:$request['flag'];
        $id=empty($request['id'])?0:$request['id'];

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('flag',$flag);
        $this->assign('id',$id);
        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',2);
        return $this->fetch($url);
    }


    /**
     * 报名表单页面？？？
     * @return   html                   
     */
    public function signup()
    {
        $userID=$this->userinfo['idmember'];
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];

        $groupBuyId = isset($request['group_buy_id']) ? $request['group_buy_id'] : '';
        $groupBuyOrderId = isset($request['group_buy_order_id']) ? $request['group_buy_order_id'] : '';


        // 页面跳转 已开团或参团，TODO 跳转到拼团详情页
        if(!empty($groupBuyId))
        {
            $existGroupBuyOrderIds = db('group_buy_order')->where([
                    'group_buy_id' => $groupBuyId
                ])
                ->column('group_buy_order_id');
            $hadOrder = db('order')->where([
                    'group_buy_order_id' => ['in', $existGroupBuyOrderIds],
                    // 4.已报名 已支付，
                    // 5.已报名 退款中，
                    // 6已部分退款 继续服务，
                    // 7已退款 继续服务，
                    // 8.已报名 退款不通过，
                    // 12.已报名 待支付，
                    'state' => ['in', [4,5,6,7,8,12]],
                    'fiduser' => $userID
                ])
                ->value('id');
            // var_dump($hadOrder);die;
            // 已有拼团订单，不允许开团或参团
            if($hadOrder)
            {
                // header("location:/error.php?msg=".urlencode("不允许重复参团")."&url=".urlencode("/".$sitecode));
                // exit();
            }
        }


        $userinfo=db('member')->where(array('idmember'=>$userID,'intstate'=>['neq',2]))->find();

        $config=$this->wxConfig;
        $idsite=$config['id'];

        $id = $request['id']; //id
        $content_info = db('activity')
            ->where(
                [
                    'idactivity' => $request['id'],
                ]
            )
            ->field('siteid')
            ->find();
        $idsite=$content_info['siteid'];
        $time = date('Y-m-d H:i:s',time());
        //查询该活动的设置可用券的情况
        $groupBuy = db('group_buy')->find($groupBuyId);
        if($groupBuy && $groupBuy['allow_coupon'] == 0)
        {
            $activity_cashed = [];
        }else
        {
            $activity_cashed = db("activity_cashed_card_set")->where(array('activity_id'=>$id,'is_use_cashed'=>1))->find();
        }
        if($activity_cashed){
            //查询用户的可用现金券的列表
            $where['site_id'] = ['=',$idsite];
            $where['receive_member_id'] = ['=',$userID];
            $where['cashed_validity_time'] = ['>=',$time];
            $where['used_status'] = ['=',1];
            $cashed_list = db('cashed_card_receive')->field('freeze_time',true)->where($where)->where("(cashed_type = 2 and receive_activity_id = {$request['id']} ) or cashed_type in(1,3,4)")->order('create_time desc')->select();
            $cashed_list_count = db('cashed_card_receive')->where($where)->where("(cashed_type = 2 and receive_activity_id = {$request['id']} ) or cashed_type in(1,3,4)")->count();
        }else{
            $cashed_list = [];
            $cashed_list_count = 0;
        }
        $roottpl = 'template/modules/';
        //获得栏目列表模版路径
        $url =$roottpl.'/order/signup.html';
        $share_id = 0;
        //看是否有通过海报二维码进来的
        if(array_key_exists('a',$request) && !empty($request['a'])){
            $share_id = intval($request['a']);
        }
        //看是否是通过分享链接过来的
        if(array_key_exists('share_id',$request) && !empty($request['share_id'])){
            $share_id = intval($request['share_id']);
        }
        //如果两个都不为空的话,那么就是当扫码进来的,取扫码的id
        if(array_key_exists('a',$request) && !empty($request['a']) && array_key_exists('share_id',$request) && !empty($request['share_id'])){
            $share_id = intval($request['a']);
        }

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('id', $request['id']);
        $this->assign('userinfo',$userinfo);
        $this->assign('sitecode',$sitecode);
        $this->assign('SelectFooterTab',2);
        $this->assign('activity_cashed',$activity_cashed);
        $this->assign('cashed_list_count',$cashed_list_count);//现金券条数
        $this->assign('cashed_list',$cashed_list);//现金券列表
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        $this->assign('groupBuyId',$groupBuyId);//拼团
        $this->assign('groupBuyOrderId',$groupBuyOrderId);//现金券列表
        $this->assign('share_id',$share_id);//现金券列表
        return $this->fetch($url);
    }

    /**
     * 订单支付回调
     * @author Hlt
     * @DateTime 2019-04-23T16:41:37+0800
     * @return   string                   success|fail
     */
    public function signup_post1()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        //$config=$this->wxConfig;
        $input= file_get_contents("php://input");
        $xml='';
       // file_put_contents(__ROOT__.'\test.txt',$input);
       //Log::info('支付回调参数:' . print_r($input, true));
        if($input){
            /*
             <xml><appid><![CDATA[wxd79730a60b28b7b4]]></appid>
                <bank_type><![CDATA[CFT]]></bank_type>
                <cash_fee><![CDATA[1]]></cash_fee>
                <fee_type><![CDATA[CNY]]></fee_type>
                <is_subscribe><![CDATA[Y]]></is_subscribe>
                <mch_id><![CDATA[1511368881]]></mch_id>
                <nonce_str><![CDATA[X5Sgl3rVGgpANheBlCjoPRMBlkvrm3r2]]></nonce_str>
                <openid><![CDATA[oZS4v1aiMfreRinDgG-uWZFEDpnk]]></openid>
                <out_trade_no><![CDATA[1534125205]]></out_trade_no>
                <result_code><![CDATA[SUCCESS]]></result_code>
                <return_code><![CDATA[SUCCESS]]></return_code>
                <sign><![CDATA[E49A339E327F7E3054EFC786E0177DC4]]></sign>
                <time_end><![CDATA[20180813095333]]></time_end>
                <total_fee>1</total_fee>
                <trade_type><![CDATA[JSAPI]]></trade_type>
                <transaction_id><![CDATA[4200000161201808135093928210]]></transaction_id>
                </xml>
             * */
            $xml = simplexml_load_string($input);
            //$money = (string)$xml->total_fee;
            $return_code = (string)$xml->return_code;
            //$result_code = (string)$xml->result_code;
            //$attach = (string)$xml->attach;
            $out_trade_no = (string)$xml->out_trade_no;
        }

//        $sitecode='tongxiang2';
//        $return_code='SUCCESS';
//        $out_trade_no='20190731164929933644';

       // Log::info('支付回调数据：' . print_r($xml, true));
        if($return_code=='SUCCESS'){
            //业务处理　　//修改订单/用户状态
                $arr=[];
                $arr['state']=4;
                $arr['intflag']=5;
                $arr['paytype1']=1;

                $tmp_Result= db('order')->where(array('transaction_id'=>$out_trade_no))->find();
                if(empty($tmp_Result)) {
                    Log::info('支付回订单不存在，订单流水号为：' . $out_trade_no);
                    echo "SUCCESS";
                    exit();
                }
                if($tmp_Result['state']==4)
                {
                    echo "SUCCESS";
                    exit();
                }

                $bool=db('order')->where(array('transaction_id'=>$out_trade_no))->update($arr);
                $tmp_Result['state']=4;
                $tmp_Result['intflag']=5;
                $tmp_Result['paytype1']=1;



                $idsite=$tmp_Result['idsite'];
                SetUserPayCount($tmp_Result['fiduser']);

                // 拼团业务
                //Log::info('拼团业务判断结果：' . print_r([!empty($tmp_Result['group_buy_order_id']), $tmp_Result['group_buy_order_id']], true));
                if(!empty($tmp_Result['group_buy_order_id']) && $tmp_Result['group_buy_order_id']!=0){
                    $groupBuyOrderModel = new GroupBuyOrder;
                    $res = $groupBuyOrderModel->afterStart($tmp_Result);
                    Log::info('支付后拼团操作 函数参数为：' . print_r([$tmp_Result,$res], true));
                }

                $integral_rule_config = db('integral_rule_config')->where(['idsite'=>$idsite])->find();
                $is_signup = 0;
                if(checkedMarketingPackage($idsite,'integral')){
                    $is_signup = $integral_rule_config['is_signup'];
                }
                // 是否已经开启，报名增加积分
                if($is_signup == 1){
                    $integral_rate = isset($integral_rule_config['signup_integral']) ? $integral_rule_config['signup_integral'] : 1;

                    // 报名增加积分记录
                    $integral = intval($tmp_Result['price'] -  $tmp_Result['price1'] - $tmp_Result['price2']) * $integral_rate;
                    $member = db('member')->where('idmember',$tmp_Result['fiduser'])->find();
                    // 如果积分大于0，才增加冻结积分
                    if($integral > 0){
                        db('member_integral_record')->insert([
                            'siteid' => $idsite,
                            'member_id' => $tmp_Result['fiduser'],
                            'userimg' => $member['userimg'],
                            'chrname' => $member['chrname'],
                            'nickname' => $member['nickname'],
                            'order_id' => $tmp_Result['id'],
                            'category_id' => 2,
                            'integral' => $integral,
                            'integral_rmark' => '',
                            'is_freeze' => 1,
                            'create_time' => time(),
                        ]);

                        // 发送客服消息
                        $msg = '报名活动成功，你获取到【'.$integral.'积分】<a href=\"'.request()->domain().'/'.$sitecode.'/integralrecord\">【查看详情】</a>';
                        send_ordinary_msg($sitecode, $member['openid'], $msg);

                    }
                }

                //判断该订单是否使用了现金券
                if($tmp_Result['receive_cashed_id']){
                    //将现金券使用id分割为数组
                    $receive_cashed_id_arr = explode(',',$tmp_Result['receive_cashed_id']);
                    $update_param['used_activity_id'] = $tmp_Result['dataid'];//使用活动标识id
                    $update_param['used_activity_name'] = $tmp_Result['chrtitle'];//使用活动名称
                    $update_param['used_time'] = date('Y-m-d H:i:s',time());//使用现金券时间
                    $update_param['used_order_id'] = $tmp_Result['id'];//使用订单id
                    $update_param['used_status'] = 5;//改为已使用
                    foreach ($receive_cashed_id_arr as $value){
                        db('cashed_card_receive')->where(['id'=>$value])->update($update_param);
                    }
                }
                //判断该订单是否是分销订单并且要产生对应的订单数据
                if($tmp_Result['source'] == '代言人订单' && $tmp_Result['spokesman_user_id3']){
                    $this->after_distribution($tmp_Result,$idsite);
                }

                if($bool)
                {
                    // 发送支付成功微信消息
                    template_bm($tmp_Result['id']);
                    //发短信
                    $replace = [];
                    //给客户和商务发短信通知  类型：2--下单成功
                    //Log::debug(date('Y-m-d H:i:s') . ' 收费活动付款成功,订单信息:$order=' . print_r($tmp_Result, true));
                    sysSendMsg($idsite, 2, $tmp_Result, $replace);

                }
            ob_start();
            echo "SUCCESS";
           // echo exit('<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>');
                //return sprintf("<xml><return_code><![CDATA[SUCCESS]]></return_code><return_msg><![CDATA[OK]]></return_msg></xml>");
            }

        else
        {
            echo 'fail';
        }
    }


    /**
     * 免费|收费活动报名
     * ---------------------------------------------------------
     * 职责
     * ---------------------------------------------------------
     * 验证登录状态
     * 创建|查询订单（收集报名表单数据并保存、校验）(校验活动限制)
     * 判断活动限制（关注、手机号、身份证，收费）
     * 扣除库存
     * 发起支付
     * ---------------------------------------------------------
     * @DateTime 2019-04-23T17:18:24+0800
     * @return   [type]                   [description]
     */
    public function signup_post_bak()
    {
        //获取传入的参数及初始化各种变量
        $request = Request::instance()->param();
//        var_dump($request);exit;
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $dataID =$request['id']; //id
        $userID=$this->userinfo['idmember'];
        $errmsg="";
        $flag=1;
        $txtdata="";
        $txtfield="";
        $txtdata1="";
        $txtfield1="";
        $arrfield=[];
        $arrdata=[];
        $chkissubscribe=0;
        $Tid=0;
        $err_arr = [];
        $result_order=null;


        if($userID=="")
        {
            $userID = 55;
            // $flag=2;
            // $errmsg="用户信息错误！";
        }

        if(empty($request['txtpaynum']) || empty($request['txtpaynum'])){
            $this->redirect(url('/'.$sitecode.'/detail/'.$dataID));
        }

        if($flag==1)
        {
            $arr['idmember']=$userID;
            $row=db('member')->where($arr)->find();

            $wxID=$row['openid'];
            $UserName=$row['nickname'];
            $price=0;
            $intstate=$row['intstate'];//会员状态（1关注 2取消关注 3游客）',
            $paynum=$request['txtpaynum'];
            $payname=$request['payname'];

            //chkissubscribe //是否需要关注 1为需要关注
            //ischarge：是否收费
            //chkismobile：   同一手机号只能报名一次（报名表单中必须有手机类型框）
            //chkisidcard： 同一身份证号只能报名一次（报名表单中必须有身份证类型框）
            //intmaxpaynum：  单次最大购买数量，0表示不限
            //intmaxmobilepaynum：  单个手机号累计购买上限，0表示不限（报名表单中必须有手机类型框）
            //intmaxidcardpaynum：  单个身份证累计购买上限，0表示不限（报名表单中必须有身份证类型框）
            $content_info = db('activity')->where(['idactivity' => $dataID])->field('is_distribution,share_time,chkissubscribe,ischarge,chkismobile,chkisidcard,intmaxpaynum,intmaxmobilepaynum,intmaxidcardpaynum,chrtitle,selsignfrom')->find();

            $Tid=$content_info['selsignfrom'];

            $chkissubscribe=$content_info['chkismobile']; //是否需要关注 1为需要关注
            $chkismobile=$content_info['chkismobile'];//   同一手机号只能报名一次（报名表单中必须有手机类型框）
            $chkisidcard=$content_info['chkisidcard'];// 同一身份证号只能报名一次（报名表单中必须有身份证类型框）
            $intmaxpaynum=$content_info['intmaxpaynum'];//  单次最大购买数量，0表示不限
            $intmaxmobilepaynum=$content_info['intmaxmobilepaynum'];//  单个手机号累计购买上限，0表示不限（报名表单中必须有手机类型框）
            $intmaxidcardpaynum=$content_info['intmaxidcardpaynum'];//  单个身份证累计购买上限，0表示不限（报名表单中必须有身份证类型框）
            $chkismobile_flag=false;
            $chkisidcard_flag=false;
            if($chkismobile==1)
            {
                $chkismobile_flag=true;
            }
            if($chkisidcard==1)
            {
                $chkisidcard_flag=true;
            }
            if($intmaxpaynum>0 && $paynum>$intmaxpaynum)
            {
                $flag=2;
                $errmsg="单次最大购买数量不能大于".$intmaxpaynum;
            }
        }

        if($chkissubscribe==1 && $flag==1)
        {
            if(empty($userID) || $userID<1 || $intstate!=1)
            {
                $config=$this->wxConfig;
                $api = new \think\wx\Api( array(
                    'appId' => trim($config['appid']),
                    'appSecret'    => trim($config['appsecret']),
                ));

                $imgurl= $api->get_qrcode_url();
                $template_url="template/weixin.html";
                $this->assign('msg',"本活动要求关注后才能报名<br>请扫下面二维码关注");
                $this->assign('imgurl',$imgurl);
                return $this->fetch($template_url);

            }
        }


        if($Tid>0 && $flag==1)
        {
            //表单字段
            $T_result=db('signup_template_sub')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            foreach ($T_result as $k=>$vo)
            {
                $arrfield[]=$vo['title'].'∫'.$vo['chrtype'];
                $filekey='feild_'.$vo['id'];
                if($vo['chrtype']==7)
                {
                    //如果没有图片
                    if ($_FILES[$filekey]["error"] > 0)
                    {
                        //如果存在旧的图片  那么就用旧的图片
                        if(array_key_exists("old_file_{$vo['id']}",$request)){
                            $arrdata[]=$request["old_file_{$vo['id']}"];
                        }else{
                            $arrdata[]='';
                        }
                    }
                    else
                    {
                        $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                        $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                        $filepath="order/".date('Y').'/'.date('m-d').'/';
                        $filepath= $idsite.'/'. $filepath;
                        $filepath='public/uploads/'.$filepath;

                        if(!is_dir($filepath)){
                            mkdir($filepath, 0777,true);
                        }

                        $filepath=$filepath."/".$newfilename;
                        move_uploaded_file($tmp_file_paht, $filepath);
                        $arrdata[]="/".$filepath;
                    }
                }
                else
                {
                    $datavalue=empty($request[$filekey])?"":$request[$filekey];

                    if(($vo['chrtype']==3 || $vo['chrtype']==10) && ($chkismobile==1 || $intmaxmobilepaynum>0))  // 同一手机号
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="手机号码不能为空";
                            break;
                        }
                        $chkismobile_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==3 || $arr[1]==10) && $datavalue==$row1[$k2])
                                    {
                                        if($chkismobile==1)
                                        {
                                            $errmsg="每个电话号码只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxmobilepaynum && $intmaxmobilepaynum>0)
                        {
                            $errmsg="单个手机号累计只能购买".$intmaxmobilepaynum."份";
                            break;
                        }

                    }

                    if(($vo['chrtype']==8 || $vo['chrtype']==13) && ($chkisidcard==1 || $intmaxidcardpaynum>0))  //  同一身份证
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="身份证不能为空";
                            break;
                        }
                        $chkisidcard_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==8 || $arr[1]==13) && $datavalue==$row1[$k2])
                                    {
                                        if($chkisidcard==1)
                                        {
                                            $errmsg="身份证只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxidcardpaynum && $intmaxidcardpaynum>0)
                        {
                            $errmsg="单个身份证累计累计只能购买".$intmaxidcardpaynum."份";
                            break;
                        }

                    }
                    $arrdata[]=$datavalue;
                }
            }

            $txtfield=implode('☆',$arrfield);
            $txtdata=implode('☆',$arrdata);

            //子表单
            $T_result=db('signup_template_sub1')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            $subindex=empty($request['subindex'])?0:$request['subindex'];
            if($subindex>0)
            {
                $arrfield1=[];
                $arrdata1=[];
                foreach ($T_result as $k=>$vo) {
                    $arrfield1[] = $vo['title'] . '∫' . $vo['chrtype'];
                }
                $txtfield1=implode('☆',$arrfield1);

                for($ix=0;$ix<$subindex;$ix++)
                {
                    $isnullflag=true;
                    $_data=[];
                    foreach ($T_result as $k=>$vo)
                    {
                        $filekey='feild_sub_'.$vo['id']."_".($ix+1);

                        if($k==0 && empty($request[$filekey]))
                        {
                            $isnullflag=false;
                            break;
                        }

                        if($vo['chrtype']==7)
                        {
                            if ($_FILES[$filekey]["error"] > 0)
                            {
                                //如果存在旧的图片  那么就用旧的图片
                                if(array_key_exists("old_file_{$vo['id']}",$request)){
                                    $arrdata[]=$request["old_file_{$vo['id']}"];
                                }else{
                                    $arrdata[]='';
                                }
                            }
                            else
                            {
                                $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                                $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                                $filepath="order/".date('Y').'/'.date('m-d').'/';
                                $filepath= $idsite.'/'. $filepath;
                                $filepath='public/uploads/'.$filepath;

                                if(!is_dir($filepath)){
                                    mkdir($filepath, 0777,true);
                                }

                                $filepath=$filepath."/".$newfilename;
                                move_uploaded_file($tmp_file_paht, $filepath);
                                $arrdata[]="/".$filepath;
                            }
                        }
                        else
                        {
                            $datavalue=empty($request[$filekey])?"":$request[$filekey];
                            $_data[]=$datavalue;
                        }
                    }
                    if($isnullflag)
                    {
                        $arrdata1[]=implode('☆',$_data);
                    }

                }
                $txtdata1=implode('§',$arrdata1);

            }
        }



        $ischarge=1;//是否收费 1:免费 2收费

        $ordersn = "";

        if($errmsg!="")
        {
            $flag=2;
        }
        else
        {

            if($chkismobile_flag)
            {
                $errmsg="没有设置手机字段，请联系管理员";
            }
            if($chkisidcard_flag)
            {
                $errmsg="没有设置身份证字段，请联系管理员";
            }


            //$payname 实际存储package_id
            $package = [];
            if(empty($payname))
            {
                $flag=2;
                $errmsg="报名失败，数据错误！";
            }else
            {
                $packageObj = new Package;
                $package = $packageObj->getPackage($payname);
                if($package)
                {
                    $payname = $package['keyword1'] . ' ' . $package['keyword2'] . '(' . $package['member_price'] . '元)' ;
                    $price = $package['member_price'] * $paynum;
                    // 是否是拼团订单
                    // var_dump($request);die;
                    if(isset($request['group_buy_id']) && !empty($request['group_buy_id']))
                    {
                        // TODO 验证拼团有效期
                        $groupBuy = db('group_buy')->find($request['group_buy_id']);
                        $price = $groupBuy['group_buy_price'] * $paynum;
                        if(!isset($request['group_buy_order_id']) || $request['group_buy_order_id'] ==0 )
                        {
                            // TODO 验证拼团启用状态
                            // 开团购买数量小于等于拼团数量限制 拼团数量小于等于套餐剩余库存
                            if($groupBuy['group_num'] >= $paynum && $package['stock'] >= $groupBuy['group_num'])
                            {
                                $flag = 1;
                            }else
                            {
                                $flag = 2;
                                $errmsg = '报名失败，库存不足！';
                            }
                        }else
                        {
                            $groupBuyOrder = db('group_buy_order')->find($request['group_buy_order_id']);
                            //如果是参团的，要先减掉原来占用的库存
                                if(isset($request['groupjoin']) && $request['groupjoin']==1){
                                     $paynum_be=db('order')->where('id',$request['order_id'])->value('paynum');
                                    $stock=$groupBuyOrder['group_num']-$groupBuyOrder['sold']+$paynum_be;
                                }else{
                                    $stock = $groupBuyOrder['group_num'] - $groupBuyOrder['sold'];
                                 }

                            if($stock >= $paynum)
                            {
                                $flag = 1;
                            }else
                            {
                                $flag = 2;
                                $errmsg = '报名失败，库存不足！';
                            }
                        }
                    }else
                    {

                        if($package['stock'] >= $paynum)
                        {
                            $flag = 1;
                        }else
                        {
                            $flag = 2;
                            $errmsg = '报名失败，库存不足！';
                        }
                    }
                }else
                {
                    $flag = 2;
                    $errmsg = '报名失败，套餐不存在或已过期！';
                }
            }


            if($flag == 1)
            {

                if($content_info)
                {
                    $ischarge=$content_info['ischarge'];
                }

                //事务，添加订单、锁定库存
//                Db::startTrans();
//                try
//                {
                    //创建新连接，专用于事务操作
//                    $query = new Query;
//                    $query->startTrans();
                    $order_info = [];
                    $activity_cashed_set = [];
                    $spokesman_order = [];//代言人订单相关数据
                    //查询出活动的信息
                    $activity_info = db('activity')->field('chrkeyword',true)->where(['idactivity'=>$dataID,'siteid'=>$idsite])->find();
                    //查看是否是分销商品
                    if($activity_info['is_distribution'] == 1){
                        #region    判断购买代言活动的时候  是否需要生成已代言活动的数据
                        $spokesman_activity = ['default'=>1];
                        $parent_spokesman_activity = ['default'=>1];
                        //查询购买人的信息
                        $buy_user_info = db('member')->field('idmodel',true)->where(['idmember'=>$userID,'idsite'=>$idsite])->find();
                        $request['share_id'] = array_key_exists('share_id',$request)?$request['share_id']:'';
                        //判断是否有分享用户id
                        if($request['share_id']){
                            //查询出该代言人的用户信息
                            $share_info = db('member')->field('idmodel',true)->where(['idmember'=>$request['share_id'],'idsite'=>$idsite])->find();
                            if($share_info){
                                //查询出是否具有生成已代言的活动信息
                                $spokesman_activity = db('spokesman_activity')->field('site_id',true)->where(['activity_id'=>$dataID,'site_id'=>$idsite,'spokesman_user_id'=>$request['share_id']])->find();
                                //插入的数据
                                $spokesman_user_id = $request['share_id'];
                                $spokesman_nick_name = $share_info['nickname'];
                                $spokesman_name = $share_info['u_chrname'];
                                //看有没有上级
                                if($share_info['parent_user_id']){
                                    //查询出上级是否具有生成已代言的活动信息
                                    $parent_spokesman_activity = db('spokesman_activity')->field('site_id',true)->where(['activity_id'=>$dataID,'site_id'=>$idsite,'spokesman_user_id'=>$share_info['parent_user_id']])->find();
                                    $parent_spokesman_user_id = $share_info['parent_user_id'];
                                    $parent_spokesman_nick_name = $share_info['parent_nick_name'];
                                    $parent_spokesman_name = $share_info['parent_u_chrname'];
                                }
                            }
                        }else{
                            //判断购买人是否是代言人,如果是的话
                            if($buy_user_info['spokesman_grade'] != 0) {
                                //看有没有上级
                                if ($buy_user_info['parent_user_id']) {
                                    //查询出上级是否具有生成已代言的活动信息
                                    $parent_spokesman_activity = db('spokesman_activity')->field('site_id', true)->where(['activity_id' => $dataID, 'site_id' => $idsite, 'spokesman_user_id' => $buy_user_info['parent_user_id']])->find();
                                    $parent_spokesman_user_id = $buy_user_info['parent_user_id'];
                                    $parent_spokesman_nick_name = $buy_user_info['parent_nick_name'];
                                    $parent_spokesman_name = $buy_user_info['parent_u_chrname'];
                                }
                                $spokesman_user_id = $userID;
                                $spokesman_nick_name = $buy_user_info['nickname'];
                                $spokesman_name = $buy_user_info['u_chrname'];
                                //查询出是否具有生成已代言的活动信息
                                $spokesman_activity = db('spokesman_activity')->field('site_id', true)->where(['activity_id' => $dataID, 'site_id' => $idsite, 'spokesman_user_id' => $userID])->find();
                                //否则就是用户购买,如果有分享id(这时候可能就是用户直接通过海报二维码下单)
                            }
                        }
                        //如果没有代言过,没有代言数据
                        if(!$spokesman_activity){
                            //进行数据库的插入
                            db("spokesman_activity")->insert([
                                'activity_id'=>$dataID,
                                'chrtitle'=>$activity_info['chrtitle'],
                                'chrimg'=>$activity_info['chrimg_m'],
                                'dtstart'=>$activity_info['dtstart'],
                                'dtend'=>$activity_info['dtend'],
                                'dtsignstime'=>$activity_info['dtsignstime'],
                                'dtsignetime'=>$activity_info['dtsignetime'],
                                'spokesman_time'=>date('Y-m-d H:i:s',time()),
                                'spokesman_user_id'=>$spokesman_user_id,
                                'spokesman_nick_name'=>$spokesman_nick_name,
                                'spokesman_name'=>$spokesman_name,
                                'get_commission'=>0,
                                'site_id'=>$idsite,
                            ]);
                            //进行修改用户的活动代言个数
                            db('member')->where(['idmember'=>$spokesman_user_id,'idsite'=>$idsite])->setInc('spokesman_activity_num',1);
                        }
                        //上级代言
                        if(!$parent_spokesman_activity){
                            //进行数据库的插入
                            db("spokesman_activity")->insert([
                                'activity_id'=>$dataID,
                                'chrtitle'=>$activity_info['chrtitle'],
                                'chrimg'=>$activity_info['chrimg_m'],
                                'dtstart'=>$activity_info['dtstart'],
                                'dtend'=>$activity_info['dtend'],
                                'dtsignstime'=>$activity_info['dtsignstime'],
                                'dtsignetime'=>$activity_info['dtsignetime'],
                                'spokesman_time'=>date('Y-m-d H:i:s',time()),
                                'spokesman_user_id'=>$parent_spokesman_user_id,
                                'spokesman_nick_name'=>$parent_spokesman_nick_name,
                                'spokesman_name'=>$parent_spokesman_name,
                                'get_commission'=>0,
                                'site_id'=>$idsite,
                            ]);
                            //进行修改用户的活动代言个数
                            db('member')->where(['idmember'=>$parent_spokesman_user_id,'idsite'=>$idsite])->setInc('spokesman_activity_num',1);
                        }
                        #endregion

                        #region判断是否有分销的分享用户id
                        if($request['share_id']){
                            $share_id = $request['share_id'];
                            //查询出该代言人的用户信息
                            $share_info = db('member')->field('idmodel',true)->where(['idmember'=>$share_id,'idsite'=>$idsite])->find();
                            if($share_info){
                                #region  判断分享人是否有上级
                                if($share_info['parent_user_id']){
                                    //代言人获得销售佣金
                                    $spokesman_order['spokesman_user_id3'] = $share_id;
                                    $spokesman_order['spokesman_name3'] = $share_info['u_chrname'];
                                    $spokesman_order['spokesman_nick_name3'] = $share_info['nickname'];
                                    $spokesman_order['sell_commission'] = $paynum * $package['sell_commission'];//获得的佣金是销售佣金
                                    //上级获得奖励金
                                    $spokesman_order['spokesman_user_id2'] = $share_info['parent_user_id'];
                                    $spokesman_order['spokesman_name2'] = $share_info['parent_u_chrname'];
                                    $spokesman_order['spokesman_nick_name2'] = $share_info['parent_nick_name'];
                                    $spokesman_order['bounty_commission2'] = $paynum * $package['bounty_commission'];//获得的佣金是奖励金
                                }else{
                                    $spokesman_order['spokesman_user_id3'] = $share_id;
                                    $spokesman_order['spokesman_name3'] = $share_info['u_chrname'];
                                    $spokesman_order['spokesman_nick_name3'] = $share_info['nickname'];
                                    $spokesman_order['sell_commission'] = $paynum * ($package['sell_commission'] + $package['bounty_commission']);//代言人获得的佣金是销售佣金和奖励金
                                }
                                #endregion
                            }
                        }else{
                            //判断购买人是否是代言人,如果是的话
                            if($buy_user_info['spokesman_grade'] != 0) {
                                //没有分享id,那么就是自己购买,判断有没有上级,有的话,那么就是自己只得销售金,没有的话,就是得销售金和奖励金
                                if ($buy_user_info['parent_user_id']) {
                                    //代言人获得销售佣金
                                    $spokesman_order['spokesman_user_id3'] = $userID;
                                    $spokesman_order['spokesman_name3'] = $buy_user_info['u_chrname'];
                                    $spokesman_order['spokesman_nick_name3'] = $buy_user_info['nickname'];
                                    $spokesman_order['sell_commission'] = $paynum * $package['sell_commission'];//代言人获得的佣金是销售佣金
                                    //上级获得奖励金
                                    $spokesman_order['spokesman_user_id2'] = $buy_user_info['parent_user_id'];
                                    $spokesman_order['spokesman_name2'] = $buy_user_info['parent_u_chrname'];
                                    $spokesman_order['spokesman_nick_name2'] = $buy_user_info['parent_nick_name'];
                                    $spokesman_order['bounty_commission2'] = $paynum * $package['bounty_commission'];//获得的佣金是奖励金
                                }
                                //否则  那么就没有上级的话  是一级代言人自己购买
                                $spokesman_order['spokesman_user_id3'] = $userID;
                                $spokesman_order['spokesman_name3'] = $buy_user_info['u_chrname'];
                                $spokesman_order['spokesman_nick_name3'] = $buy_user_info['nickname'];
                                $spokesman_order['sell_commission'] = $paynum * ($package['sell_commission'] + $package['bounty_commission']);//代言人获得的佣金是销售佣金和奖励金
                            }
                        }
                        #endregion
                    }
                    if(isset($request['group_buy_id']) && !empty($request['group_buy_id']))
                    {

                        $groupBuyOrderModel = new GroupBuyOrder;
                        if(isset($request['group_buy_order_id']) && !empty($request['group_buy_order_id']) && $request['group_buy_order_id'] !=0)
                        {
                            $groupBuyOrderId=$request['group_buy_order_id'];
                            //如果post请求就是参团，需要锁定本次订单库存
                            //如果是get请求，修改团购表，修改order表
                            if(isset($_GET['group_buy_order_id']) && array_key_exists('order_id',$request) && !array_key_exists('groupjoin',$request)){
                                $orderid=$request['order_id'];
                                 //修改拼团order
                                $paynum_before=db('order')->where(['id'=>$orderid])->value('paynum');
                                if($paynum != $paynum_before){
                                    $res=db('group_buy_order')->update(['sold'=>$paynum,'group_buy_order_id'=>$groupBuyOrderId]);
                                }else{
                                    $res=1;
                                }
                                //修改order
                                $transaction_id=getOrderSn();
                                $obj = new \app\admin\module\Order();
                                $ordersn = $obj->updateOrder($idsite,
                                    $userID,
                                    $wxID,
                                    $UserName,
                                    $dataID,
                                    $package['package_id'],
                                    $txtfield,
                                    $txtdata,
                                    $payname,
                                    $price,
                                    $paynum,
                                    $ordersn,
                                    0, //$cashed_amount,
                                    '', //$receive_cashed_id,
                                    '', //$share_plan_id,
                                    $txtfield1,
                                    $txtdata1,
                                    $ischarge,
                                    $transaction_id,
                                    $request['group_buy_order_id'],
                                    $request['order_id']//订单id
                                );
                                $ajaxdate['order_id']=$request['order_id'];
                                $ajaxdate['group_buy_order_id']=$request['group_buy_order_id'];

                                if(!$ordersn)
                                {
                                    throw new Exception('订单创建失败');
                                }


                            }else{
                                $groupBuyOrderId=$request['group_buy_order_id'];

                                //用户参与拼团
                                //第一次拉起支付
                                if(isset($_POST['group_buy_order_id']) && !array_key_exists('order_id',$request) && !array_key_exists('groupjoin',$request)){
                                    $groupBuyOrderId = $request['group_buy_order_id'];
                                    $res = $groupBuyOrderModel->join($groupBuyOrderId, $paynum);
                                    $ordersn = getOrderSn();
                                    // TODO 整合添加订单功能
                                    $obj = new \app\admin\module\Order();
                                    $ordersn = $obj->addOrder($idsite,
                                        $userID,
                                        $wxID,
                                        $UserName,
                                        $dataID,
                                        $package['package_id'],
                                        $txtfield,
                                        $txtdata,
                                        $payname,
                                        $price,
                                        $paynum,
                                        $ordersn,
                                        0, //$cashed_amount,
                                        '', //$receive_cashed_id,
                                        '', //$share_plan_id,
                                        $txtfield1,
                                        $txtdata1,
                                        $ischarge,
                                        $ordersn,
                                        $groupBuyOrderId,
                                        $spokesman_order
                                    );
                                    $order_id = db('order')->where(['ordersn'=>$ordersn])->value('id');
                                    $ajaxdate['order_id']=$order_id;
                                    $transaction_id=$ordersn;


                                }elseif($_GET['group_buy_order_id'] && array_key_exists('order_id',$request) && $request['groupjoin']==1){
                                    //更新
                                    //更新团购order
                                    $orderid=$request['order_id'];
                                    $paynum_before=db('order')->where(['id'=>$orderid])->value('paynum');
                                    if($paynum != $paynum_before){
                                        $res=db('group_buy_order')->where(['group_buy_order_id'=>$groupBuyOrderId])->setInc('sold',$paynum-$paynum_before);
                                    }else{
                                        $res=1;
                                    }
                                    //更新order
                                    $transaction_id=getOrderSn();
                                    $obj = new \app\admin\module\Order();
                                    $ordersn = $obj->updateOrder($idsite,
                                        $userID,
                                        $wxID,
                                        $UserName,
                                        $dataID,
                                        $package['package_id'],
                                        $txtfield,
                                        $txtdata,
                                        $payname,
                                        $price,
                                        $paynum,
                                        $ordersn,
                                        0, //$cashed_amount,
                                        '', //$receive_cashed_id,
                                        '', //$share_plan_id,
                                        $txtfield1,
                                        $txtdata1,
                                        $ischarge,
                                        $transaction_id,
                                        $request['group_buy_order_id'],
                                        $request['order_id']//订单id
                                    );
                                    $order_id = db('order')->where(['ordersn'=>$ordersn])->value('id');
                                    $ajaxdate['order_id']=$order_id;
                                    if(!$ordersn)
                                    {
                                        throw new Exception('订单创建失败');
                                    }

                                }

                                $ajaxdate['group_buy_order_id']=$groupBuyOrderId;
                                $ajaxdate['groupjoin']=1;

                            }

                        } else
                        {
                            //新增拼团
                            $res = $groupBuyOrderId = $groupBuyOrderModel->start($request['group_buy_id'], $paynum, $package['stock'], $idsite, $content_info['chrtitle'],$payname,$this->userinfo['nickname'],$this->userinfo['idmember']);

                            $ordersn = getOrderSn();
                            // TODO 整合添加订单功能
                            $obj = new \app\admin\module\Order();
                            $ordersn = $obj->addOrder($idsite,
                                $userID,
                                $wxID,
                                $UserName,
                                $dataID,
                                $package['package_id'],
                                $txtfield,
                                $txtdata,
                                $payname,
                                $price,
                                $paynum,
                                $ordersn,
                                0, //$cashed_amount,
                                '', //$receive_cashed_id,
                                '', //$share_plan_id,
                                $txtfield1,
                                $txtdata1,
                                $ischarge,
                                $ordersn,
                                $groupBuyOrderId,
                                $spokesman_order
                            );
                            $order_id = db('order')->where(['ordersn'=>$ordersn])->value('id');
                            $ajaxdate['order_id']=$order_id;
                            $ajaxdate['group_buy_order_id']=$groupBuyOrderId;
                            $transaction_id=$ordersn;
                        }

                        if(!$res)
                        {
                            throw new Exception('已售完');
                        }

                    }else
                    {
                        //非拼团订单 拼团订单id为空
                        $groupBuyOrderId = '';
                        $obj = new \app\admin\module\Order();
                        $ordersn = getOrderSn();
                        $cashed_amount = 0;//使用优惠券金额
                        $receive_cashed_id = '';//使用优惠券的领取现金券id
                        //查询该活动是否可以分享优惠券
                        $activity_cashed_set = db('activity_cashed_card_set')->field('cashed_plan_id,is_share_cashed,activity_id')->where(['activity_id'=>$dataID,'is_share_cashed'=>1])->find();
                        //判断使用了优惠券相关的信息
                        if($request['hidvolumeid'] && $request['hidvolumeprice'] > 0){
                            //去除优惠券id左右两边的逗号
                            $receive_cashed_id = trim($request['hidvolumeid'],',');
                            //如果抵用的优惠券大于订单的金额,那么就支付一分钱
                            if($request['hidvolumeprice'] >= $price){
                                $price = 0.00;
                            }else{
                                $price = round($price-$request['hidvolumeprice'],2);//订单的金额减去使用优惠券的金额
                            }
                            $cashed_amount = $request['hidvolumeprice'];
                        }
                        //分享现金券的计划id
                        $share_plan_id = $activity_cashed_set?$activity_cashed_set['cashed_plan_id']:'';
                        //如果有订单状态参数和订单id   那么就是终止服务再次下单   或者默认下单没有订单id时就是新增数据
                        $ajaxdate['request']=$request;
                        if((!array_key_exists('order_state',$request) && !array_key_exists('order_id',$request)) || (array_key_exists('order_state',$request) && array_key_exists('order_id',$request))){
                            $ordersn = $obj->addOrder($idsite,
                                $userID,
                                $wxID,
                                $UserName,
                                $dataID,
                                $package['package_id'],
                                $txtfield,
                                $txtdata,
                                $payname,
                                $price,
                                $paynum,
                                $ordersn,
                                $cashed_amount,
                                $receive_cashed_id,
                                $share_plan_id,
                                $txtfield1,
                                $txtdata1,
                                $ischarge,
                                $ordersn,
                                $groupBuyOrderId,
                                $spokesman_order
                            );
                            $transaction_id=$ordersn;
                            //获取订单id
                            $order_id = db('order')->where(['ordersn'=>$ordersn])->value('id');
                            $ajaxdate['order_id']=$order_id;
                            $res = true;
                            $stockLocked = db('order')->field('stock_locked')->find($order_id);
                            if($stockLocked['stock_locked'] == 1)
                            {
                                //减库存
                                $res = changeStock($package['package_id'], $paynum);
                            }
                            if(!$res)
                            {
                                throw new Exception('商品库存不足');
                            }
                            //那么就是修改订单的数据
                        }elseif(!array_key_exists('order_state',$request) && array_key_exists('order_id',$request)){
                            $res = true;
                            $add=true;
                            $stockLocked = db('order')->field('stock_locked,paynum')->find($request['order_id']);
                            if($stockLocked['stock_locked'] == 1)
                            {
                                //先释放原来的库存
                                $add=changeStock($package['package_id'], $stockLocked['paynum'],false);
                                //减库存
                                $res = changeStock($package['package_id'], $paynum);
                            }
                            if(!$res && !$add)
                            {
                                throw new Exception('商品库存不足');
                            }
                            $transaction_id=getOrderSn();
                            $ordersn = $obj->updateOrder($idsite,
                                $userID,
                                $wxID,
                                $UserName,
                                $dataID,
                                $package['package_id'],
                                $txtfield,
                                $txtdata,
                                $payname,
                                $price,
                                $paynum,
                                $ordersn,
                                $cashed_amount,
                                $receive_cashed_id,
                                $share_plan_id,
                                $txtfield1,
                                $txtdata1,
                                $ischarge,
                                $transaction_id,
                                $groupBuyOrderId,
                                $request['order_id']//订单id
                            );
                            $ajaxdate['order_id']=$request['order_id'];

                        }
//                        halt($ordersn);
                        if(!$ordersn)
                        {
                            throw new Exception('订单创建失败');
                        }

                        //此时提交事务,是为了下面能查到该订单
                        //Db::commit();
                        //生成订单后开始将使用掉的现金券修改状态和增加使用对象
                        $order_info = db('order')->where(['ordersn'=>$ordersn])->find();


                        if($order_info){
                            //判断该订单原来是否具有使用现金券
                            if(array_key_exists('former_receive_cashed_id',$request) && !empty($request['former_receive_cashed_id'])){
                                $where_update_cashed['id'] = ['in',$request['former_receive_cashed_id']];
                                //将冻结的现金券释放
                                db('cashed_card_receive')->where($where_update_cashed)->update(['used_status'=>1,'release_time'=>date('Y-m-d H:i:s',time())]);
                            }
                            if($receive_cashed_id){
                                //将现金券使用id分割为数组
                                $receive_cashed_id_arr = explode(',',$receive_cashed_id);
                                //封装要修改领取现金券信息的数据
                                $update_param['used_status'] = 10;//使用状态改为冻结
                                $update_param['freeze_time'] = date('Y-m-d H:i:s',time());//冻结时间
                                foreach ($receive_cashed_id_arr as $value){
                                    //查询出其领取的现金券是否过期
                                    $receive_cashed_info = db('cashed_card_receive')->where(['id'=>$value])->where('cashed_validity_time','<',date('Y-m-d H:i:s',time()))->find();
                                    if($receive_cashed_info){
                                        array_push($err_arr,['err'=>'该订单存在过期的现金券']);
//                                        var_dump($err_arr);exit;
                                        $flag = 2;
                                    }else{
                                        //执行修改
                                        db('cashed_card_receive')->where(['id'=>$value])->update($update_param);
                                    }
                                }
                                //如果没有错误信息,并且支付金额为0的话
                                if(!$err_arr && $price == 0){
                                    //将现金券使用id分割为数组
                                    $receive_cashed_id_arr = explode(',',$receive_cashed_id);
                                    $order_update['state']=4;
                                    $order_update['intflag']=5;
                                    $order_update['paytype1']=1;
                                    //将订单变为已支付
                                    db('order')->where(['ordersn'=>$ordersn])->update($order_update);
                                    $update_param['used_activity_id'] = $order_info['dataid'];//使用活动标识id
                                    $update_param['used_activity_name'] = $order_info['chrtitle'];//使用活动名称
                                    $update_param['used_time'] = date('Y-m-d H:i:s',time());//使用现金券时间
                                    $update_param['used_order_id'] = $order_info['id'];//使用订单id
                                    $update_param['used_status'] = 5;//改为已使用
                                    foreach ($receive_cashed_id_arr as $value){
                                        db('cashed_card_receive')->where(['id'=>$value])->update($update_param);
                                    }
                                }
                            }
                        }
                    }
                    // 不要删，兼容现金券代码 若没有运行到现金券部分，则整个事务必须提交，若要删掉这行代码，必须考虑合并本方法中的三个addOrder调用
                  //  Db::commit();;

                    //处理短信及微信预下单操作
                    if($ischarge==2 && $price > 0)    //付费活动
                    {
                        // api模块 - 包含各种系统主动发起的功能
                        $api = new \think\wx\Api(
                            array(
                                'appId' => trim($config['appid']),
                                'appSecret'    => trim($config['appsecret']),
                                'mchId'    => trim($config['mchid']),
                                'key'    => trim($config['paykey'])
                            )
                        );

                        $data=$this->wechatpay($api,$transaction_id,$content_info['chrtitle'].'['. $payname.']',$price,$dataID);
                        $config=$api->get_jsapi_config();
                        $ajaxdate['data']=$data;
                        $ajaxdate['config']=$config;
                        $ajaxdate['activity_cashed_set']=$activity_cashed_set;
//                        $this->assign('data',$data);
//                        $this->assign('config',$config);
//                        $this->assign('activity_cashed_set',$activity_cashed_set);//活动现金券的设置
                        if($order_info){
                            //修改成异步拉起微信支付
                            //$order_id=$order_info['id'];
                           $ajaxdate['order_id']=$order_info['id'];
//                            $this->assign('order_id',$order_info['id']);//订单id
                        }else{
                            $order_id='';
                        }
                        Log::debug(date('Y-m-d H:i:s') . ' 收费活动报名成功');
                    }else   //免费活动，发短信
                    {
                        //获取订单信息
                        $order = db('order')->where(['ordersn' => $ordersn])->find();
                        $replace = [];
                        Log::debug(date('Y-m-d H:i:s') . ' 免费活动报名成功,订单信息:$order=' . print_r($order, true));
                        //给客户和商务发短信通知  类型：7--免费活动报名成功
                        sysSendMsg($idsite, 7, $order, $replace);
                    }
//                }catch (Exception $e)
//                {
//                    Db::rollBack();
//                    Log::error('下单及扣除库存失败。[ SQL ] ' . Db::getLastSql());
//                    $errmsg ='下单及扣除库存失败';//
//                    $flag = 2;
//                    dump($e->getMessage());
//                    // throw $e;
//                    dump($e->getLine());
//                }
            }
        }
// var_dump($data);die;
        $roottpl = 'template/modules/';
        $url =$roottpl.'/order/signuppost.html';

//        $this->assign('flag',$flag);
//        $this->assign('price',$price);
//        $this->assign('errmsg',$errmsg);
//        $this->assign('err_arr',$err_arr);
//        $this->assign('roottpl','/'.$roottpl);
//        $this->assign('sitecode',$sitecode);
//        $this->assign('dataID',$dataID);
//        $this->assign('ischarge',$ischarge);
//        $this->assign('ordersn',$ordersn);
//        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        // var_dump($flag, $errmsg)
//
        $ajaxdate['res']=1;
        $ajaxdate['flag']=$flag;
        $ajaxdate['price']=$price;
        $ajaxdate['errmsg']=$errmsg;
        $ajaxdate['err_arr']=$err_arr;
        $ajaxdate['roottpl']='/'.$roottpl;
        $ajaxdate['sitecode']=$sitecode;
        $ajaxdate['ischarge']=$ischarge;
        $ajaxdate['ordersn']=$ordersn;
        $ajaxdate['dataID']=$dataID;
        $ajaxdate['is_cashed']=checkedMarketingPackage($idsite,'cashed');


        $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
      // return $this->fetch($url);
      return $ajaxdate;
    }


   //分销
   private function distribution($userID,$share_id,$paynum,$content_info,$package)
   {
       $activity_cashed_set = [];
       $spokesman_order = [];//代言人订单相关数据

       #region    判断购买代言活动的时候  是否需要生成已代言活动的数据
       $idsite=$content_info['siteid'];
       $dataID=$content_info['idactivity'];
       $spokesman_activity = ['default'=>1];
       $parent_spokesman_activity = ['default'=>1];
       //查询购买人的信息
       $buy_user_info = db('member')->field('idmodel',true)->where(['idmember'=>$userID,'idsite'=>$idsite])->find();


       //判断是否有分享用户id,如果有
       if($share_id){
           //查询出该代言人的用户信息
           $share_info = db('member')->field('idmodel',true)->where(['idmember'=>$share_id,'idsite'=>$idsite])->find();
           if($share_info){
               //查询出是否具有生成已代言的活动信息
               $spokesman_activity = db('spokesman_activity')->field('site_id',true)->where(['activity_id'=>$content_info['idactivity'],'site_id'=>$idsite,'spokesman_user_id'=>$share_id])->find();
               //插入的数据
               $spokesman_user_id = $share_id;
               $spokesman_nick_name = $share_info['nickname'];
               $spokesman_name = $share_info['u_chrname'];
               //看有没有上级
               if($share_info['parent_user_id']){
                   //查询出上级是否具有生成已代言的活动信息
                   $parent_spokesman_activity = db('spokesman_activity')->field('site_id',true)->where(['activity_id'=>$content_info['idactivity'],'site_id'=>$idsite,'spokesman_user_id'=>$share_info['parent_user_id']])->find();
                   $parent_spokesman_user_id = $share_info['parent_user_id'];
                   $parent_spokesman_nick_name = $share_info['parent_nick_name'];
                   $parent_spokesman_name = $share_info['parent_u_chrname'];
               }
           }
       }else{
           //判断购买人是否是代言人,如果是的话
           if($buy_user_info['spokesman_grade'] != 0) {
               //看有没有上级
               if ($buy_user_info['parent_user_id']) {
                   //查询出上级是否具有生成已代言的活动信息
                   $parent_spokesman_activity = db('spokesman_activity')->field('site_id', true)->where(['activity_id' => $dataID, 'site_id' => $idsite, 'spokesman_user_id' => $buy_user_info['parent_user_id']])->find();
                   $parent_spokesman_user_id = $buy_user_info['parent_user_id'];
                   $parent_spokesman_nick_name = $buy_user_info['parent_nick_name'];
                   $parent_spokesman_name = $buy_user_info['parent_u_chrname'];
               }
               $spokesman_user_id = $userID;
               $spokesman_nick_name = $buy_user_info['nickname'];
               $spokesman_name = $buy_user_info['u_chrname'];
               //查询出是否具有生成已代言的活动信息
               $spokesman_activity = db('spokesman_activity')->field('site_id', true)->where(['activity_id' => $dataID, 'site_id' => $idsite, 'spokesman_user_id' => $userID])->find();
               //否则就是用户购买,如果有分享id(这时候可能就是用户直接通过海报二维码下单)
           }
       }
       //如果没有代言过,没有代言数据
       if(!$spokesman_activity){
           //进行数据库的插入
           db("spokesman_activity")->insert([
               'activity_id'=>$dataID,
               'chrtitle'=>$content_info['chrtitle'],
               'chrimg'=>$content_info['chrimg_m'],
               'dtstart'=>$content_info['dtstart'],
               'dtend'=>$content_info['dtend'],
               'dtsignstime'=>$content_info['dtsignstime'],
               'dtsignetime'=>$content_info['dtsignetime'],
               'spokesman_time'=>date('Y-m-d H:i:s',time()),
               'spokesman_user_id'=>$spokesman_user_id,
               'spokesman_nick_name'=>$spokesman_nick_name,
               'spokesman_name'=>$spokesman_name,
               'get_commission'=>0,
               'site_id'=>$idsite,
           ]);
           //进行修改用户的活动代言个数
           db('member')->where(['idmember'=>$spokesman_user_id,'idsite'=>$idsite])->setInc('spokesman_activity_num',1);
       }
       //上级代言
       if(!$parent_spokesman_activity){
           //进行数据库的插入
           db("spokesman_activity")->insert([
               'activity_id'=>$dataID,
               'chrtitle'=>$content_info['chrtitle'],
               'chrimg'=>$content_info['chrimg_m'],
               'dtstart'=>$content_info['dtstart'],
               'dtend'=>$content_info['dtend'],
               'dtsignstime'=>$content_info['dtsignstime'],
               'dtsignetime'=>$content_info['dtsignetime'],
               'spokesman_time'=>date('Y-m-d H:i:s',time()),
               'spokesman_user_id'=>$parent_spokesman_user_id,
               'spokesman_nick_name'=>$parent_spokesman_nick_name,
               'spokesman_name'=>$parent_spokesman_name,
               'get_commission'=>0,
               'site_id'=>$idsite,
           ]);
           //进行修改用户的活动代言个数
           db('member')->where(['idmember'=>$parent_spokesman_user_id,'idsite'=>$idsite])->setInc('spokesman_activity_num',1);
       }
       #endregion

       #region判断是否有分销的分享用户id
       if($share_id>0){
           //查询出该代言人的用户信息
           $share_info = db('member')->field('idmodel',true)->where(['idmember'=>$share_id,'idsite'=>$idsite])->find();
           if($share_info){
               #region  判断分享人是否有上级
               if($share_info['parent_user_id']){
                   //代言人获得销售佣金
                   $spokesman_order['spokesman_user_id3'] = $share_id;
                   $spokesman_order['spokesman_name3'] = $share_info['u_chrname'];
                   $spokesman_order['spokesman_nick_name3'] = $share_info['nickname'];
                   $spokesman_order['sell_commission'] = $paynum * $package['sell_commission'];//获得的佣金是销售佣金
                   //上级获得奖励金
                   $spokesman_order['spokesman_user_id2'] = $share_info['parent_user_id'];
                   $spokesman_order['spokesman_name2'] = $share_info['parent_u_chrname'];
                   $spokesman_order['spokesman_nick_name2'] = $share_info['parent_nick_name'];
                   $spokesman_order['bounty_commission2'] = $paynum * $package['bounty_commission'];//获得的佣金是奖励金
               }else{
                   $spokesman_order['spokesman_user_id3'] = $share_id;
                   $spokesman_order['spokesman_name3'] = $share_info['u_chrname'];
                   $spokesman_order['spokesman_nick_name3'] = $share_info['nickname'];
                   $spokesman_order['sell_commission'] = $paynum * ($package['sell_commission'] + $package['bounty_commission']);//代言人获得的佣金是销售佣金和奖励金
               }
               #endregion
           }
       }else{
           //判断购买人是否是代言人,如果是的话
           if($buy_user_info['spokesman_grade'] != 0) {
               //没有分享id,那么就是自己购买,判断有没有上级,有的话,那么就是自己只得销售金,没有的话,就是得销售金和奖励金
               if ($buy_user_info['parent_user_id']) {
                   //代言人获得销售佣金
                   $spokesman_order['spokesman_user_id3'] = $userID;
                   $spokesman_order['spokesman_name3'] = $buy_user_info['u_chrname'];
                   $spokesman_order['spokesman_nick_name3'] = $buy_user_info['nickname'];
                   $spokesman_order['sell_commission'] = $paynum * $package['sell_commission'];//代言人获得的佣金是销售佣金
                   //上级获得奖励金
                   $spokesman_order['spokesman_user_id2'] = $buy_user_info['parent_user_id'];
                   $spokesman_order['spokesman_name2'] = $buy_user_info['parent_u_chrname'];
                   $spokesman_order['spokesman_nick_name2'] = $buy_user_info['parent_nick_name'];
                   $spokesman_order['bounty_commission2'] = $paynum * $package['bounty_commission'];//获得的佣金是奖励金
               }else{
                   //否则  那么就没有上级的话  是一级代言人自己购买
                   $spokesman_order['spokesman_user_id3'] = $userID;
                   $spokesman_order['spokesman_name3'] = $buy_user_info['u_chrname'];
                   $spokesman_order['spokesman_nick_name3'] = $buy_user_info['nickname'];
                   $spokesman_order['sell_commission'] = $paynum * ($package['sell_commission'] + $package['bounty_commission']);//代言人获得的佣金是销售佣金和奖励金
               }
           }
       }

       #endregion

       return $spokesman_order;
   }

   private  function after_distribution($tmp_Result,$idsite){

           //将用户得到的对应的佣金分配到该用户的冻结账户中
           if($tmp_Result['spokesman_user_id3']){
               $commission = $tmp_Result['sell_commission'];
               $user_id = $tmp_Result['spokesman_user_id3'];
               $member = db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->find();
               //修改代言人的数据
               db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->setInc(['total_commission'=>$member['total_commission'] + $commission,'freeze_commission'=>$member['freeze_commission'] + $commission,'spokesman_pay_num'=>$member['spokesman_pay_num'] + 1]);
               //修改活动代言表中的支付订单数
               db('spokesman_activity')->where(['activity_id'=>$tmp_Result['dataid'],'spokesman_user_id'=>$user_id,'site_id'=>$idsite])->setInc('spokesman_pay_num',1);
           }
           //如果上级代言人有
           if($tmp_Result['spokesman_user_id2']){
               $commission = $tmp_Result['bounty_commission2'];
               $user_id = $tmp_Result['spokesman_user_id2'];
               $member = db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->find();
               //修改代言人的数据
               db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->setInc(['total_commission'=>$member['total_commission'] + $commission,'freeze_commission'=>$member['freeze_commission'] + $commission,'spokesman_pay_num'=>$member['spokesman_pay_num'] + 1]);
               //修改活动代言表中的支付订单数
               db('spokesman_activity')->where(['activity_id'=>$tmp_Result['dataid'],'spokesman_user_id'=>$user_id,'site_id'=>$idsite])->setInc('spokesman_pay_num',1);
           }
           //如果上上级代言人有
           if($tmp_Result['spokesman_user_id1']){
               $commission = $tmp_Result['bounty_commission1'];
               $user_id = $tmp_Result['spokesman_user_id1'];
               $member = db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->find();
               //修改代言人的数据
               db('member')->where(['idmember'=>$user_id,'idsite'=>$idsite])->setInc(['total_commission'=>$member['total_commission'] + $commission,'freeze_commission'=>$member['freeze_commission'] + $commission,'spokesman_pay_num'=>$member['spokesman_pay_num'] + 1]);
               //修改活动代言表中的支付订单数
               db('spokesman_activity')->where(['activity_id'=>$tmp_Result['dataid'],'spokesman_user_id'=>$user_id,'site_id'=>$idsite])->setInc('spokesman_pay_num',1);
           }
           //发送分销支付后的模板消息
       if($tmp_Result['spokesman_user_id3'] != $tmp_Result['fiduser'])
           template_bm_commission(0,$tmp_Result['ordersn']);

   }

    /**
     * 免费|收费活动报名
     * ---------------------------------------------------------
     * 职责
     * ---------------------------------------------------------
     * 验证登录状态
     * 创建|查询订单（收集报名表单数据并保存、校验）(校验活动限制)
     * 判断活动限制（关注、手机号、身份证，收费）
     * 扣除库存
     * 发起支付
     * ---------------------------------------------------------
     * @DateTime 2019-04-23T17:18:24+0800
     * @return   [type]                   [description]
     */
    //验证个人信息，返回关注状态
    private function verification_user($userID,$idsite){
        if($userID=="")
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="信息获取错误！";
            return $ajaxdate;
        }

        $arr['idmember']=$userID;
        $arr['idsite']=$idsite;
        $row=db('member')->where($arr)->find();
        if(empty($row))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="用户信息不存在！";
            return $ajaxdate;
        }
        return $row;
    }
    //验证活动信息和表单字段
    private  function verification_activity($userID,$content_info,$paynum,$intstate,$request,$idsite,$dataID,$orderid){
        $txtdata="";
        $txtfield="";
        $txtdata1="";
        $txtfield1="";
        $arrfield=[];
        $arrdata=[];
        $errmsg='';
        $payname=$request['payname'];
        if(empty($content_info))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="活动已下架！";
            return  $ajaxdate;
        }
        $Tid=$content_info['selsignfrom'];  //报名表单ID
        $chkissubscribe=$content_info['chkissubscribe']; //是否需要关注 1为需要关注
        $chkismobile=$content_info['chkismobile'];//   同一手机号只能报名一次（报名表单中必须有手机类型框）
        $chkisidcard=$content_info['chkisidcard'];// 同一身份证号只能报名一次（报名表单中必须有身份证类型框）
        $intmaxpaynum=$content_info['intmaxpaynum'];//  单次最大购买数量，0表示不限
        $intmaxmobilepaynum=$content_info['intmaxmobilepaynum'];//  单个手机号累计购买上限，0表示不限（报名表单中必须有手机类型框）
        $intmaxidcardpaynum=$content_info['intmaxidcardpaynum'];//  单个身份证累计购买上限，0表示不限（报名表单中必须有身份证类型框）
        $chkismobile_flag=false;
        $chkisidcard_flag=false;
        if($chkismobile==1)
        {
            $chkismobile_flag=true;
        }
        if($chkisidcard==1)
        {
            $chkisidcard_flag=true;
        }
        if($intmaxpaynum>0 && $paynum>$intmaxpaynum)
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="单次最大购买数量不能大于".$intmaxpaynum;
            return $ajaxdate;
        }

        //关注才能下单
        if($chkissubscribe==1)
        {

            if(empty($userID) || $userID<1 || $intstate!=1)
            {
                $imgurl= $this->qrcodeurl();
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="<div style=\"text-align: center\"><img style=\"width: 150px;height: 150px\" src=\"{$imgurl}\" /><br>没有关注或没有登陆，请先关注后才能报名</div>";
                return $ajaxdate;
            }
        }
        //处理报名表单
        if($Tid>0)
        {
            //表单字段
            $T_result=db('signup_template_sub')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            foreach ($T_result as $k=>$vo)
            {
                $arrfield[]=$vo['title'].'∫'.$vo['chrtype'];
                $filekey='feild_'.$vo['id'];
                if($vo['chrtype']==7)
                {
                    //如果没有图片
                    if ($_FILES[$filekey]["error"] > 0)
                    {
                        //如果存在旧的图片  那么就用旧的图片
                        if(array_key_exists("old_file_{$vo['id']}",$request)){
                            $arrdata[]=$request["old_file_{$vo['id']}"];
                        }else{
                            $arrdata[]='';
                        }
                    }
                    else
                    {
                        $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                        $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                        $filepath="order/".date('Y').'/'.date('m-d').'/';
                        $filepath= $idsite.'/'. $filepath;
                        $filepath='public/uploads/'.$filepath;

                        if(!is_dir($filepath)){
                            mkdir($filepath, 0777,true);
                        }

                        $filepath=$filepath."/".$newfilename;
                        move_uploaded_file($tmp_file_paht, $filepath);
                        $arrdata[]="/".$filepath;
                    }
                }
                else
                {
                    $datavalue=empty($request[$filekey])?"":$request[$filekey];

                    if(($vo['chrtype']==3 || $vo['chrtype']==10) && ($chkismobile==1 || $intmaxmobilepaynum>0))  // 同一手机号
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="手机号码不能为空";
                            break;
                        }
                        $chkismobile_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==3 || $arr[1]==10) && $datavalue==$row1[$k2])
                                    {
                                        if($chkismobile==1 && $vo1['id'] != $orderid)
                                        {
                                            $errmsg="单个手机号码只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxmobilepaynum && $intmaxmobilepaynum>0)
                        {
                            $errmsg="单个手机号码累计只能购买".$intmaxmobilepaynum."份";
                            break;
                        }

                    }

                    if(($vo['chrtype']==8 || $vo['chrtype']==13) && ($chkisidcard==1 || $intmaxidcardpaynum>0))  //  同一身份证
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="身份证不能为空";
                            break;
                        }
                        $chkisidcard_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==8 || $arr[1]==13) && $datavalue==$row1[$k2])
                                    {
                                        if($chkisidcard==1 && $vo1['id'] != $orderid)
                                        {
                                            $errmsg="单个身份证只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxidcardpaynum && $intmaxidcardpaynum>0)
                        {
                            $errmsg="单个身份证累计只能购买".$intmaxidcardpaynum."份";
                            break;
                        }

                    }
                    $arrdata[]=$datavalue;
                }
            }

            $txtfield=implode('☆',$arrfield);
            $txtdata=implode('☆',$arrdata);

            //子表单
            $T_result=db('signup_template_sub1')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            $subindex=empty($request['subindex'])?0:$request['subindex'];
            if($subindex>0)
            {
                $arrfield1=[];
                $arrdata1=[];
                foreach ($T_result as $k=>$vo) {
                    $arrfield1[] = $vo['title'] . '∫' . $vo['chrtype'];
                }
                $txtfield1=implode('☆',$arrfield1);

                for($ix=0;$ix<$subindex;$ix++)
                {
                    $isnullflag=true;
                    $_data=[];
                    foreach ($T_result as $k=>$vo)
                    {
                        $filekey='feild_sub_'.$vo['id']."_".($ix+1);

                        if($k==0 && empty($request[$filekey]))
                        {
                            $isnullflag=false;
                            break;
                        }

                        if($vo['chrtype']==7)
                        {
                            if ($_FILES[$filekey]["error"] > 0)
                            {
                                //如果存在旧的图片  那么就用旧的图片
                                if(array_key_exists("old_file_{$vo['id']}",$request)){
                                    $arrdata[]=$request["old_file_{$vo['id']}"];
                                }else{
                                    $arrdata[]='';
                                }
                            }
                            else
                            {
                                $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                                $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                                $filepath="order/".date('Y').'/'.date('m-d').'/';
                                $filepath= $idsite.'/'. $filepath;
                                $filepath='public/uploads/'.$filepath;

                                if(!is_dir($filepath)){
                                    mkdir($filepath, 0777,true);
                                }

                                $filepath=$filepath."/".$newfilename;
                                move_uploaded_file($tmp_file_paht, $filepath);
                                $arrdata[]="/".$filepath;
                            }
                        }
                        else
                        {
                            $datavalue=empty($request[$filekey])?"":$request[$filekey];
                            $_data[]=$datavalue;
                        }
                    }
                    if($isnullflag)
                    {
                        $arrdata1[]=implode('☆',$_data);
                    }

                }
                $txtdata1=implode('§',$arrdata1);

            }
        }
        if($chkismobile_flag)
        {
            $errmsg="没有设置手机字段，请联系管理员";
        }
        if($chkisidcard_flag)
        {
            $errmsg="没有设置身份证字段，请联系管理员";
        }

        if(empty($payname))
        {
            $errmsg="报名失败，数据错误！";
        }

        if($errmsg!="")
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']=$errmsg;
            return $ajaxdate;
        }

        $result['txtfield']=$txtfield;
        $result['txtdata']=$txtdata;
        $result['txtfield1']=$txtfield1;
        $result['txtdata1']=$txtdata1;
        return $result;

    }
    //验证套餐库存
    private function verification_package($package,$paynum,$group_buy_id,$request,$order_info){
        if(empty($package))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']='报名失败，套餐不存在或已过期！';;
            return $ajaxdate;
        }

        $payname = $package['keyword1'] . ' ' . $package['keyword2'] . '(' . $package['member_price'] . '元)' ;
        $price = $package['member_price'] * $paynum;
        // 是否是拼团订单
        // var_dump($request);die;
        if($group_buy_id!=0)
        {
            // TODO 验证拼团有效期
            $groupBuy = db('group_buy')->find($request['group_buy_id']);
            if(empty($groupBuy))
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团不存在！';;
                return $ajaxdate;
            }

            if($groupBuy['end_at'] < time()){
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团已结束！';;
                return $ajaxdate;
            }

            if($groupBuy['state'] == 0){
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团已下架！';;
                return $ajaxdate;
            }

            $price = $groupBuy['group_buy_price'] * $paynum;
            if(!isset($request['group_buy_order_id']) || $request['group_buy_order_id'] ==0 )
            {
                // TODO 验证拼团启用状态
                // 开团购买数量小于等于拼团数量限制 拼团数量小于等于套餐剩余库存
                if($groupBuy['group_num']< $paynum)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，购买数量不能超过成团所需数量！';
                    return $ajaxdate;
                }

                if($package['stock'] < $groupBuy['group_num']){
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，库存不足！';;
                    return $ajaxdate;
                }
            }
            else
            {
                $groupBuyOrder = db('group_buy_order')->find($request['group_buy_order_id']);
                //先判断是否过期
                if($groupBuyOrder['state'] == 4 || (!empty($groupBuyOrder['expire_at']) &&  $groupBuyOrder['expire_at']< time()) ){
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，该拼团已失效！';
                    return $ajaxdate;
                }
                $paynum_be=0;
                if($order_info)
                {
                    $paynum_be=$order_info['paynum'];
                }

                $stock=$groupBuyOrder['group_num']-$groupBuyOrder['sold']+$paynum_be;
                if($stock < $paynum)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='拼团报名失败，库存不足！';;
                    return $ajaxdate;
                }
            }
        }else
        {
            if($package['stock'] < $paynum)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='报名失败，库存不足！';;
                return $ajaxdate;
            }
        }
        $result['price']=$price;
        $result['payname']=$payname;
        return $result;
    }
    //验证拼团
    private  function groupOrder($groupBuyOrderId,$request,$package,$idsite,$content_info,$payname,$spokesman_order,$price,$_data,$orderid,$ordersn,$paynum,$dataID,$userID,$order_info){
        $obj = new \app\home\model\Order();
        $groupBuyOrderModel = new GroupBuyOrder;
        //新增拼团
        if($groupBuyOrderId<1) {
            $groupBuyOrderId = $groupBuyOrderModel->start($request['group_buy_id'], 0, $package['stock'], $idsite, $content_info['chrtitle'], $payname, $this->userinfo['nickname'], $this->userinfo['idmember']);
            if(!$groupBuyOrderId)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="开团失败";
                return $ajaxdate;
            }
            $ajaxdate['group_buy_order_id']=$groupBuyOrderId;
        }

        if(isset($_POST['group_buy_order_id']) && $_POST['group_buy_order_id'] !=0 && $_POST['group_buy_order_id'] !='')
        {
            $ajaxdate['groupjoin']=1;
        }

        //如果有分销数据
        if($spokesman_order && $price > 0){
            $spokesman_order['source'] = '代言人订单';
            $_data=array_merge($_data,$spokesman_order);
        }
        //用户参与拼团
        //第一次拉起支付
        if($orderid<1){
            // TODO 整合添加订单功能
            $_data['ordersn']=$ordersn; //订单号//
            $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
            $groupBuyOrderModel->join($groupBuyOrderId, $paynum);
            $ordersn = $obj->updateOrder($_data,$dataID,0,$userID,$idsite);
            $orderid = db('order')->where(['ordersn'=>$ordersn])->value('id');
            $ajaxdate['order_id']=$orderid;
        }
        else
        {
            //更新
            //更新团购库存
            $paynum_before=$order_info['paynum'];
            if($paynum != $paynum_before){
                $res= $groupBuyOrderModel->join($groupBuyOrderId, $paynum-$paynum_before);
                if($res==false)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']="已超过团购数量";
                    return $ajaxdate;
                }
            }

            //更新order
            $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
            $ordersn = $obj->updateOrder($_data,$dataID,$orderid,$userID,$idsite);
            if(!$ordersn)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="订单创建失败";
                return $ajaxdate;
            }
        }

        $ajaxdate['group_buy_order_id']=$groupBuyOrderId;

        return $ajaxdate;

    }

    public function signup_post()
    {
        //获取传入的参数及初始化各种变量
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $group_buy_id=empty($request['group_buy_id'])?"0":$request['group_buy_id'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $dataID =$request['id']; //id
        $userID=$this->userinfo['idmember'];
        $errmsg="";
        $flag=1;
        $result_order=null;
        $order_info = [];
        $ajaxdate=[];
        $orderid=isset($request['order_id'])?$request['order_id']:0;//订单ID
        if($orderid>0)
        {
            $order_info=db('order')->where(['id'=>$orderid])->find();
        }

        if(empty($request['txtpaynum']) || empty($request['txtpaynum'])){
            $this->redirect(url('/'.$sitecode.'/detail/'.$dataID));
        }

        $row=$this->verification_user($userID,$idsite);
        if(isset($row['flag']))
            return json_encode($row, JSON_UNESCAPED_UNICODE);

        $intstate=$row['intstate'];//会员状态（1关注 2取消关注 3游客）',
        $paynum=$request['txtpaynum'];
        $payname=$request['payname'];

        $content_info = db('activity')->where(['idactivity' => $dataID])->field('chrkeyword,is_distribution,share_time,chkissubscribe,ischarge,chkismobile,chkisidcard,intmaxpaynum,intmaxmobilepaynum,intmaxidcardpaynum,chrtitle,selsignfrom,chrimg_m,dtstart,dtend,dtsignstime,dtsignetime,siteid,idactivity')->find();

        //活动
        $res_activity=$this->verification_activity($userID,$content_info,$paynum,$intstate,$request,$idsite,$dataID,$orderid);
        if(isset($res_activity['errmsg']))
            return json_encode($res_activity, JSON_UNESCAPED_UNICODE);

        $packageObj = new Package;
        $package = $packageObj->getPackage($payname);

        //套餐
        $res_pacakge=$this->verification_package($package,$paynum,$group_buy_id,$request,$order_info);
        if(isset($res_pacakge['errmsg'])){
            return json_encode($res_pacakge, JSON_UNESCAPED_UNICODE);
        }else{
            $payname=$res_pacakge['payname'];
            $price=$res_pacakge['price'];
        }

        //是否收费 1:免费 2收费
        $ischarge=$content_info['ischarge'];
        $activity_cashed_set = [];
        $spokesman_order = [];//代言人订单相关数据

        $request['share_id'] = array_key_exists('share_id',$request)?$request['share_id']:'';
        //查看是否是分销商品
        if($content_info['is_distribution'] == 1){
            $spokesman_order=$this->distribution($userID, $request["share_id"],$paynum,$content_info,$package);
        }

        $group_buy_id=isset($request['group_buy_id'])?$request['group_buy_id']:0;                   //拼团信息ID
        $groupBuyOrderId=isset($request['group_buy_order_id'])?$request['group_buy_order_id']:"";    //开团信息ID
        if(empty($groupBuyOrderId)) $groupBuyOrderId=isset($_GET['group_buy_order_id'])?$_GET['group_buy_order_id']:0;    //开团信息ID
        $order_state=isset($request['order_state'])?$request['order_state']:0;                      //0正常订单，大于0为从原订时间复一个新订单
        $ordersn=getOrderSn();
        $transaction_id=getOrderSn();                                                                //支付流水ID

        if($orderid>0){
            if($order_info){
                $ordersn=$order_info['ordersn'];
            }
        }

        $_data=[];
        $_data['package_id']=$package['package_id']; //套餐id//
        $_data['paynum']=$paynum; //购买数量//
        $_data['payname']=$payname; //购买的套餐名称//
        $_data['price']=$price; //订单总价格//
        $_data['txtfield']=$res_activity['txtfield']; //模版字段，多个字段用“☆”分开//
        $_data['txtdata']=$res_activity['txtdata']; //模版数据，多个字段用“☆”分开//
        $_data['txtfield1']=$res_activity['txtfield1']; //子表单字段，多个字段用“☆”分开//
        $_data['txtdata1']=$res_activity['txtdata1']; //子表单数据，多个字段用“☆”分开，多数据用“§”分开//
        $_data['transaction_id']=$transaction_id; //支付流水ID//


            $obj = new \app\home\model\Order();
            if($group_buy_id>0)
            {
                $res_group=$this->groupOrder($groupBuyOrderId,$request,$package,$idsite,$content_info,$payname,$spokesman_order,$price,$_data,$orderid,$ordersn,$paynum,$dataID,$userID,$order_info);
                if(isset($res_group['errmsg'])){
                    return json_encode($res_group, JSON_UNESCAPED_UNICODE);
                }else{
                    $ajaxdate=array_merge($ajaxdate,$res_group);
                    if(isset($ajaxdate['order_id']))
                        $orderid=$ajaxdate['order_id'];
                }

            }else
            {
                //非拼团订单 拼团订单id为空
                $groupBuyOrderId = '';
                $cashed_amount = 0;//使用优惠券金额
                $receive_cashed_id = '';//使用优惠券的领取现金券id
                //查询该活动是否可以分享优惠券
                $activity_cashed_set = db('activity_cashed_card_set')->field('cashed_plan_id,is_share_cashed,activity_id')->where(['activity_id'=>$dataID,'is_share_cashed'=>1])->find();
                //判断使用了优惠券相关的信息
                if($request['hidvolumeid'] && $request['hidvolumeprice'] > 0){
                    //去除优惠券id左右两边的逗号
                    $receive_cashed_id = trim($request['hidvolumeid'],',');
                    //如果抵用的优惠券大于订单的金额,那么就支付一分钱
                    if($request['hidvolumeprice'] >= $price){
                        $price = 0.00;
                    }else{
                        $price = round($price-$request['hidvolumeprice'],2);//订单的金额减去使用优惠券的金额
                    }
                    $cashed_amount = $request['hidvolumeprice'];
                }
                $_data['cashed_amount'] = $cashed_amount;//抵用现金券金额
                $_data['price']=$price;
                $_data['receive_cashed_id'] = $receive_cashed_id;//使用的领取现金券id,多个券用逗号隔开

                //分享现金券的计划id
                $share_plan_id = $activity_cashed_set?$activity_cashed_set['cashed_plan_id']:'';
                $_data['share_plan_id'] = $share_plan_id;//分享现金券的计划id

                $_paynum=$paynum;   //要减的库存
                $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
                //如果有分销数据
                if($spokesman_order){
                    $spokesman_order['source'] = '代言人订单';
                }
                $_data=array_merge($_data,$spokesman_order);

                //判断该订单原来是否具有使用现金券
                if(array_key_exists('former_receive_cashed_id',$request) && !empty($request['former_receive_cashed_id'])){
                    $where_update_cashed['id'] = ['in',$request['former_receive_cashed_id']];
                    //将冻结的现金券释放
                    db('cashed_card_receive')->where($where_update_cashed)->update(['used_status'=>1,'release_time'=>date('Y-m-d H:i:s',time())]);
                }

                //0-未占用库存，1-占用库存'
                if($orderid>0 && $order_state<1) {
                    if ($order_info["stock_locked"] == 1) {
                        $_paynum = $_paynum - $order_info["paynum"];
                    }
                }
                //减库存
                $res=true;
                if($_paynum!=0)
                {
                    $res = changeStock($package['package_id'], $_paynum);
                }
                if(!$res)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']="库存不足";
                    return json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                }

                if($orderid<1 || $order_state>0)
                {
                    $ordersn=getOrderSn();
                    $_data['ordersn']=$ordersn; //订单号//
                    $ordersn = $obj->updateOrder($_data,$dataID,0,$userID,$idsite,$receive_cashed_id);
                    if(isset($ordersn['errmsg'])){
                        return json_encode($ordersn, JSON_UNESCAPED_UNICODE);
                    }
                    $order_info= db('order')->where(['ordersn'=>$ordersn])->find();
                    $orderid =$order_info['id'];
                }
                else
                {
                    $ordersn = $obj->updateOrder($_data,$dataID,$orderid,$userID,$idsite,$receive_cashed_id);
                    if(isset($ordersn['errmsg'])){
                        return json_encode($ordersn, JSON_UNESCAPED_UNICODE);
                    }
                }
                if(!$ordersn)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']="订单创建失败".$ordersn;
                    return json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                }
            }


        //处理短信及微信预下单操作
        if($ischarge==2 && $price > 0)    //付费活动
        {
            // api模块 - 包含各种系统主动发起的功能
            $api = new \think\wx\Api(
                array(
                    'appId' => trim($config['appid']),
                    'appSecret'    => trim($config['appsecret']),
                    'mchId'    => trim($config['mchid']),
                    'key'    => trim($config['paykey'])
                )
            );
            $data=$this->wechatpay($api,$transaction_id,$content_info['chrtitle'].'['. $payname.']',$price,$dataID);
            $config=$api->get_jsapi_config();
            $ajaxdate['data']=$data;
            $ajaxdate['config']=$config;
            $ajaxdate['activity_cashed_set']=$activity_cashed_set; ////活动现金券的设置
            Log::debug(date('Y-m-d H:i:s') . ' 收费活动报名成功');
        }elseif($ischarge==2 && $price == 0){
            Log::debug(date('Y-m-d H:i:s') . ' 收费活动使用现金券，全部抵扣报名成功');

        }else   //免费活动，发短信
        {
            //获取订单信息
            $order = db('order')->where(['ordersn' => $ordersn])->find();
            $replace = [];
            Log::debug(date('Y-m-d H:i:s') . ' 免费活动报名成功,订单信息:$order=' . print_r($order, true));
            //给客户和商务发短信通知  类型：7--免费活动报名成功
            sysSendMsg($idsite, 7, $order, $replace);
        }
        $ajaxdate['userid']=$userID;
        $roottpl = 'template/'.GetConfigVal("weboption","rootdir",$idsite);
        $ajaxdate['order_id']=$orderid;
        $ajaxdate['flag']=$flag;
        $ajaxdate['price']=$price;
        $ajaxdate['errmsg']=$errmsg;
        $ajaxdate['roottpl']='/'.$roottpl;
        $ajaxdate['sitecode']=$sitecode;
        $ajaxdate['ischarge']=$ischarge;
        $ajaxdate['ordersn']=$ordersn;
        $ajaxdate['dataID']=$dataID;
        $ajaxdate['is_cashed']=checkedMarketingPackage($idsite,'cashed');
        return json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);

    }

    public function signup_post_bak2()
    {
        //获取传入的参数及初始化各种变量
        $request = Request::instance()->param();
//        var_dump($request);exit;
        $sitecode=$request['sitecode'];
        $group_buy_id=empty($request['group_buy_id'])?"0":$request['group_buy_id'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $dataID =$request['id']; //id
        $userID=$this->userinfo['idmember'];
        $errmsg="";
        $flag=1;
        $txtdata="";
        $txtfield="";
        $txtdata1="";
        $txtfield1="";
        $arrfield=[];
        $arrdata=[];
        $result_order=null;
        $order_info = [];


        $orderid=isset($request['order_id'])?$request['order_id']:0;                                //订单ID
        if($orderid>0)
        {
            $order_info=db('order')->where(['id'=>$orderid])->find();
        }


        #region 数据验证
        if($userID=="")
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="信息获取错误！";
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }

        if(empty($request['txtpaynum']) || empty($request['txtpaynum'])){
            $this->redirect(url('/'.$sitecode.'/detail/'.$dataID));
        }


        $arr['idmember']=$userID;
        $arr['idsite']=$idsite;
        $row=db('member')->where($arr)->find();
        if(empty($row))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="用户信息不存在！";
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }


        $wxID=$row['openid'];
        $UserName=$row['nickname'];
        $price=0;
        $intstate=$row['intstate'];//会员状态（1关注 2取消关注 3游客）',
        $paynum=$request['txtpaynum'];
        $payname=$request['payname'];


        //chkissubscribe //是否需要关注 1为需要关注
        //ischarge：是否收费
        //chkismobile：   同一手机号只能报名一次（报名表单中必须有手机类型框）
        //chkisidcard： 同一身份证号只能报名一次（报名表单中必须有身份证类型框）
        //intmaxpaynum：  单次最大购买数量，0表示不限
        //intmaxmobilepaynum：  单个手机号累计购买上限，0表示不限（报名表单中必须有手机类型框）
        //intmaxidcardpaynum：  单个身份证累计购买上限，0表示不限（报名表单中必须有身份证类型框）
        $content_info = db('activity')->where(['idactivity' => $dataID])->field('chrkeyword,is_distribution,share_time,chkissubscribe,ischarge,chkismobile,chkisidcard,intmaxpaynum,intmaxmobilepaynum,intmaxidcardpaynum,chrtitle,selsignfrom,chrimg_m,dtstart,dtend,dtsignstime,dtsignetime,siteid,idactivity')->find();

        if(empty($content_info))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="活动已下架！";
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }

        $Tid=$content_info['selsignfrom'];  //报名表单ID
        $chkissubscribe=$content_info['chkissubscribe']; //是否需要关注 1为需要关注
        $chkismobile=$content_info['chkismobile'];//   同一手机号只能报名一次（报名表单中必须有手机类型框）
        $chkisidcard=$content_info['chkisidcard'];// 同一身份证号只能报名一次（报名表单中必须有身份证类型框）
        $intmaxpaynum=$content_info['intmaxpaynum'];//  单次最大购买数量，0表示不限
        $intmaxmobilepaynum=$content_info['intmaxmobilepaynum'];//  单个手机号累计购买上限，0表示不限（报名表单中必须有手机类型框）
        $intmaxidcardpaynum=$content_info['intmaxidcardpaynum'];//  单个身份证累计购买上限，0表示不限（报名表单中必须有身份证类型框）
        $chkismobile_flag=false;
        $chkisidcard_flag=false;
        if($chkismobile==1)
        {
            $chkismobile_flag=true;
        }
        if($chkisidcard==1)
        {
            $chkisidcard_flag=true;
        }
        if($intmaxpaynum>0 && $paynum>$intmaxpaynum)
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']="单次最大购买数量不能大于".$intmaxpaynum;
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }

        //关注才能下单
        if($chkissubscribe==1)
        {
            if(empty($userID) || $userID<1 || $intstate!=1)
            {
                $imgurl= $this->qrcodeurl();
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="<div style=\"text-align: center\"><img style=\"width: 150px;height: 150px\" src=\"{$imgurl}\" /><br>没有关注或没有登陆，请先关注后才能报名</div>";
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }
        }


        //处理报名表单
        if($Tid>0)
        {
            //表单字段
            $T_result=db('signup_template_sub')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            foreach ($T_result as $k=>$vo)
            {
                $arrfield[]=$vo['title'].'∫'.$vo['chrtype'];
                $filekey='feild_'.$vo['id'];
                if($vo['chrtype']==7)
                {
                    //如果没有图片
                    if ($_FILES[$filekey]["error"] > 0)
                    {
                        //如果存在旧的图片  那么就用旧的图片
                        if(array_key_exists("old_file_{$vo['id']}",$request)){
                            $arrdata[]=$request["old_file_{$vo['id']}"];
                        }else{
                            $arrdata[]='';
                        }
                    }
                    else
                    {
                        $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                        $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                        $filepath="order/".date('Y').'/'.date('m-d').'/';
                        $filepath= $idsite.'/'. $filepath;
                        $filepath='public/uploads/'.$filepath;

                        if(!is_dir($filepath)){
                            mkdir($filepath, 0777,true);
                        }

                        $filepath=$filepath."/".$newfilename;
                        move_uploaded_file($tmp_file_paht, $filepath);
                        $arrdata[]="/".$filepath;
                    }
                }
                else
                {
                    $datavalue=empty($request[$filekey])?"":$request[$filekey];

                    if(($vo['chrtype']==3 || $vo['chrtype']==10) && ($chkismobile==1 || $intmaxmobilepaynum>0))  // 同一手机号
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="手机号码不能为空";
                            break;
                        }
                        $chkismobile_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==3 || $arr[1]==10) && $datavalue==$row1[$k2])
                                    {
                                        if($chkismobile==1 && $vo1['id'] != $orderid)
                                        {
                                            $errmsg="单个手机号码只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxmobilepaynum && $intmaxmobilepaynum>0)
                        {
                            $errmsg="单个手机号码累计只能购买".$intmaxmobilepaynum."份";
                            break;
                        }

                    }

                    if(($vo['chrtype']==8 || $vo['chrtype']==13) && ($chkisidcard==1 || $intmaxidcardpaynum>0))  //  同一身份证
                    {
                        $tmp_paynum=$paynum;
                        if($datavalue=="")
                        {
                            $errmsg="身份证不能为空";
                            break;
                        }
                        $chkisidcard_flag=false;
                        $tmpResult= db('order')->where(" dataid=".$dataID." and txtdata like '%".$datavalue."%'")->select();
                        if($tmpResult)
                        {
                            foreach ($tmpResult as $k1=>$vo1) {
                                $row2= explode("☆", $vo1['txtfield']);
                                $row1= explode("☆", $vo1['txtdata']);
                                foreach($row1 as $k2=>$vo2){
                                    $arr= explode("∫", $row2[$k2]);
                                    if(count($arr)>1 && ($arr[1]==8 || $arr[1]==13) && $datavalue==$row1[$k2])
                                    {
                                        if($chkisidcard==1 && $vo1['id'] != $orderid)
                                        {
                                            $errmsg="单个身份证只能订购一次";
                                            break;
                                        }
                                        $tmp_paynum=$tmp_paynum+$vo1['paynum'];
                                    }
                                }
                                if($errmsg!="")
                                {
                                    break;
                                }
                            }
                        }

                        if($tmp_paynum>$intmaxidcardpaynum && $intmaxidcardpaynum>0)
                        {
                            $errmsg="单个身份证累计只能购买".$intmaxidcardpaynum."份";
                            break;
                        }

                    }
                    $arrdata[]=$datavalue;
                }
            }

            $txtfield=implode('☆',$arrfield);
            $txtdata=implode('☆',$arrdata);

            //子表单
            $T_result=db('signup_template_sub1')->where('pid='.$Tid)->order("sn asc,id asc")->select();
            $subindex=empty($request['subindex'])?0:$request['subindex'];
            if($subindex>0)
            {
                $arrfield1=[];
                $arrdata1=[];
                foreach ($T_result as $k=>$vo) {
                    $arrfield1[] = $vo['title'] . '∫' . $vo['chrtype'];
                }
                $txtfield1=implode('☆',$arrfield1);

                for($ix=0;$ix<$subindex;$ix++)
                {
                    $isnullflag=true;
                    $_data=[];
                    foreach ($T_result as $k=>$vo)
                    {
                        $filekey='feild_sub_'.$vo['id']."_".($ix+1);

                        if($k==0 && empty($request[$filekey]))
                        {
                            $isnullflag=false;
                            break;
                        }

                        if($vo['chrtype']==7)
                        {
                            if ($_FILES[$filekey]["error"] > 0)
                            {
                                //如果存在旧的图片  那么就用旧的图片
                                if(array_key_exists("old_file_{$vo['id']}",$request)){
                                    $arrdata[]=$request["old_file_{$vo['id']}"];
                                }else{
                                    $arrdata[]='';
                                }
                            }
                            else
                            {
                                $tmp_file_paht= $_FILES[$filekey]["tmp_name"];
                                $newfilename =getNumber(). strrchr($_FILES[$filekey]["name"],'.');
                                $filepath="order/".date('Y').'/'.date('m-d').'/';
                                $filepath= $idsite.'/'. $filepath;
                                $filepath='public/uploads/'.$filepath;

                                if(!is_dir($filepath)){
                                    mkdir($filepath, 0777,true);
                                }

                                $filepath=$filepath."/".$newfilename;
                                move_uploaded_file($tmp_file_paht, $filepath);
                                $arrdata[]="/".$filepath;
                            }
                        }
                        else
                        {
                            $datavalue=empty($request[$filekey])?"":$request[$filekey];
                            $_data[]=$datavalue;
                        }
                    }
                    if($isnullflag)
                    {
                        $arrdata1[]=implode('☆',$_data);
                    }

                }
                $txtdata1=implode('§',$arrdata1);

            }
        }

        if($chkismobile_flag)
        {
            $errmsg="没有设置手机字段，请联系管理员";
        }
        if($chkisidcard_flag)
        {
            $errmsg="没有设置身份证字段，请联系管理员";
        }

        if(empty($payname))
        {
            $errmsg="报名失败，数据错误！";
        }

        if($errmsg!="")
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']=$errmsg;
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }


        $ordersn = "";



        $packageObj = new Package;
        $package = $packageObj->getPackage($payname);
        if(empty($package))
        {
            $ajaxdate['flag']=2;
            $ajaxdate['errmsg']='报名失败，套餐不存在或已过期！';;
            $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
            return $ajaxdate;
        }

        $payname = $package['keyword1'] . ' ' . $package['keyword2'] . '(' . $package['member_price'] . '元)' ;
        $price = $package['member_price'] * $paynum;
        // 是否是拼团订单
        // var_dump($request);die;
        if($group_buy_id!=0)
        {
            // TODO 验证拼团有效期
            $groupBuy = db('group_buy')->find($request['group_buy_id']);
            if(empty($groupBuy))
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团不存在！';;
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }

            if($groupBuy['end_at'] < time()){
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团已结束！';;
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }

            if($groupBuy['state'] == 0){
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='拼团已下架！';;
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }

            $price = $groupBuy['group_buy_price'] * $paynum;
            if(!isset($request['group_buy_order_id']) || $request['group_buy_order_id'] ==0 )
            {
                // TODO 验证拼团启用状态
                // 开团购买数量小于等于拼团数量限制 拼团数量小于等于套餐剩余库存
                if($groupBuy['group_num']< $paynum)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，购买数量不能超过成团所需数量！';
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }

                if($package['stock'] < $groupBuy['group_num']){
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，库存不足！';;
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }
            }
            else
            {
                $groupBuyOrder = db('group_buy_order')->find($request['group_buy_order_id']);
                //先判断是否过期
                if($groupBuyOrder['state'] == 4 || (!empty($groupBuyOrder['expire_at']) &&  $groupBuyOrder['expire_at']< time()) ){
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='报名失败，该拼团已失效！';
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }

                $paynum_be=0;
                if($order_info)
                {
                    $paynum_be=$order_info['paynum'];
                }

               $stock=$groupBuyOrder['group_num']-$groupBuyOrder['sold']+$paynum_be;

                if($stock < $paynum)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']='拼团报名失败，库存不足！';;
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }
            }
        }else
        {
            if($package['stock'] < $paynum)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']='报名失败，库存不足！';;
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }
        }




        //是否收费 1:免费 2收费
        $ischarge=$content_info['ischarge'];


        //事务，添加订单、锁定库存
//                Db::startTrans();
//                try
//                {
        //创建新连接，专用于事务操作
//                    $query = new Query;
//                    $query->startTrans();


        $activity_cashed_set = [];
        $spokesman_order = [];//代言人订单相关数据


        #endregion

        $request['share_id'] = array_key_exists('share_id',$request)?$request['share_id']:'';
        //查看是否是分销商品
        if($content_info['is_distribution'] == 1){
            $spokesman_order=$this->distribution($userID, $request["share_id"],$paynum,$content_info,$package);
        }

        $group_buy_id=isset($request['group_buy_id'])?$request['group_buy_id']:0;                   //拼团信息ID
        $groupBuyOrderId=isset($request['group_buy_order_id'])?$request['group_buy_order_id']:"";    //开团信息ID
        if(empty($groupBuyOrderId)) $groupBuyOrderId=isset($_GET['group_buy_order_id'])?$_GET['group_buy_order_id']:0;    //开团信息ID
        $order_state=isset($request['order_state'])?$request['order_state']:0;                      //0正常订单，大于0为从原订时间复一个新订单
        $ordersn=getOrderSn();
        $transaction_id=getOrderSn();                                                                //支付流水ID

        if($orderid>0)
        {
              if($order_info)
            {
                $ordersn=$order_info['ordersn'];
            }
        }

        $_data=[];
        $_data['package_id']=$package['package_id']; //套餐id//
        $_data['paynum']=$paynum; //购买数量//
        $_data['payname']=$payname; //购买的套餐名称//
        $_data['price']=$price; //订单总价格//
        $_data['txtfield']=$txtfield; //模版字段，多个字段用“☆”分开//
        $_data['txtdata']=$txtdata; //模版数据，多个字段用“☆”分开//
        $_data['txtfield1']=$txtfield1; //子表单字段，多个字段用“☆”分开//
        $_data['txtdata1']=$txtdata1; //子表单数据，多个字段用“☆”分开，多数据用“§”分开//
        $_data['transaction_id']=$transaction_id; //支付流水ID//

//        $_data['group_buy_order_id']=$group_buy_order_id; //关联拼团订单id//
//        $_data['issettlement']=0; //是否已结算 1:是//
//        $_data['cashed_amount'] = $cashed_amount;//抵用现金券金额
//        $_data['receive_cashed_id'] = $receive_cashed_id;//使用的领取现金券id,多个券用逗号隔开
//        $_data['share_plan_id'] = $share_plan_id;//分享现金券的计划id



        $obj = new \app\home\model\Order();
        if($group_buy_id>0)
        {
            $groupBuyOrderModel = new GroupBuyOrder;
            //新增拼团
            if($groupBuyOrderId<1) {
                $groupBuyOrderId = $groupBuyOrderModel->start($request['group_buy_id'], 0, $package['stock'], $idsite, $content_info['chrtitle'], $payname, $this->userinfo['nickname'], $this->userinfo['idmember']);
                if(!$groupBuyOrderId)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']="开团失败";
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }
                $ajaxdate['group_buy_order_id']=$groupBuyOrderId;
            }

            if(isset($_POST['group_buy_order_id']) && $_POST['group_buy_order_id'] !=0 && $_POST['group_buy_order_id'] !='')
            {
                $ajaxdate['groupjoin']=1;
            }

            //如果有分销数据
            if($spokesman_order && $price > 0){
                $spokesman_order['source'] = '代言人订单';
                $_data=array_merge($_data,$spokesman_order);
            }
            //用户参与拼团
            //第一次拉起支付
            if($orderid<1){
                // TODO 整合添加订单功能
                $_data['ordersn']=$ordersn; //订单号//
                $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
                $groupBuyOrderModel->join($groupBuyOrderId, $paynum);
                $ordersn = $obj->updateOrder($_data,$dataID,0,$userID,$idsite);
                $orderid = db('order')->where(['ordersn'=>$ordersn])->value('id');
            }
            else
            {
                //更新
                //更新团购库存
                $paynum_before=$order_info['paynum'];
                if($paynum != $paynum_before){
                   $res= $groupBuyOrderModel->join($groupBuyOrderId, $paynum-$paynum_before);
                   if($res==false)
                   {
                       $ajaxdate['flag']=2;
                       $ajaxdate['errmsg']="已超过团购数量";
                       $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                       return $ajaxdate;
                   }
                }

                //更新order
                $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
                $ordersn = $obj->updateOrder($_data,$dataID,$orderid,$userID,$idsite);
                if(!$ordersn)
                {
                    $ajaxdate['flag']=2;
                    $ajaxdate['errmsg']="订单创建失败";
                    $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                    return $ajaxdate;
                }
            }

            $ajaxdate['group_buy_order_id']=$groupBuyOrderId;

        }else
        {
            //非拼团订单 拼团订单id为空
            $groupBuyOrderId = '';
            $cashed_amount = 0;//使用优惠券金额
            $receive_cashed_id = '';//使用优惠券的领取现金券id
            //查询该活动是否可以分享优惠券
            $activity_cashed_set = db('activity_cashed_card_set')->field('cashed_plan_id,is_share_cashed,activity_id')->where(['activity_id'=>$dataID,'is_share_cashed'=>1])->find();
            //判断使用了优惠券相关的信息
            if($request['hidvolumeid'] && $request['hidvolumeprice'] > 0){
                //去除优惠券id左右两边的逗号
                $receive_cashed_id = trim($request['hidvolumeid'],',');
                //如果抵用的优惠券大于订单的金额,那么就支付一分钱
                if($request['hidvolumeprice'] >= $price){
                    $price = 0.00;
                }else{
                    $price = round($price-$request['hidvolumeprice'],2);//订单的金额减去使用优惠券的金额
                }
                $cashed_amount = $request['hidvolumeprice'];
            }
            $_data['cashed_amount'] = $cashed_amount;//抵用现金券金额
            $_data['price']=$price;
            $_data['receive_cashed_id'] = $receive_cashed_id;//使用的领取现金券id,多个券用逗号隔开

            //分享现金券的计划id
            $share_plan_id = $activity_cashed_set?$activity_cashed_set['cashed_plan_id']:'';
            $_data['share_plan_id'] = $share_plan_id;//分享现金券的计划id

            //如果有订单状态参数和订单id   那么就是终止服务再次下单   或者默认下单没有订单id时就是新增数据
            $ajaxdate['request']=$request;

            $_paynum=$paynum;   //要减的库存
            $_data['group_buy_order_id']=$groupBuyOrderId; //关联拼团订单id//
            //如果有分销数据
            if($spokesman_order && $price > 0){
                $spokesman_order['source'] = '代言人订单';
            }

            $_data=array_merge($_data,$spokesman_order);


            //0-未占用库存，1-占用库存'
            if($orderid>0 && $order_state<1) {
                if ($order_info["stock_locked"] == 1) {
                    $_paynum = $_paynum - $order_info["paynum"];
                }
            }
            //减库存
            $res=true;
            if($_paynum!=0)
            {
                $res = changeStock($package['package_id'], $_paynum);
            }

            if(!$res)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="库存不足";
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }

            if($orderid<1 || $order_state>0)
            {
                $ordersn=getOrderSn();
                $_data['ordersn']=$ordersn; //订单号//
                $ordersn = $obj->updateOrder($_data,$dataID,0,$userID,$idsite,$receive_cashed_id);
                $order_info= db('order')->where(['ordersn'=>$ordersn])->find();
                $orderid =$order_info['id'];
            }
            else
            {
                $ordersn = $obj->updateOrder($_data,$dataID,$orderid,$userID,$idsite,$receive_cashed_id);
            }

            if(!$ordersn)
            {
                $ajaxdate['flag']=2;
                $ajaxdate['errmsg']="订单创建失败1".$ordersn;
                $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);
                return $ajaxdate;
            }


            //判断该订单原来是否具有使用现金券
            if(array_key_exists('former_receive_cashed_id',$request) && !empty($request['former_receive_cashed_id'])){
                $where_update_cashed['id'] = ['in',$request['former_receive_cashed_id']];
                //将冻结的现金券释放
                db('cashed_card_receive')->where($where_update_cashed)->update(['used_status'=>1,'release_time'=>date('Y-m-d H:i:s',time())]);
            }
            if($receive_cashed_id){
                //将现金券使用id分割为数组
                $receive_cashed_id_arr = explode(',',$receive_cashed_id);
                //封装要修改领取现金券信息的数据
                $update_param['used_status'] = 10;//使用状态改为冻结
                $update_param['freeze_time'] = date('Y-m-d H:i:s',time());//冻结时间
                foreach ($receive_cashed_id_arr as $value){
                    //查询出其领取的现金券是否过期
                    $receive_cashed_info = db('cashed_card_receive')->where(['id'=>$value])->where('cashed_validity_time','<',date('Y-m-d H:i:s',time()))->find();
                    if($receive_cashed_info){
                        $errmsg='该订单存在过期的现金券';
                        $flag = 2;
                    }else{
                        //执行修改
                        db('cashed_card_receive')->where(['id'=>$value])->update($update_param);
                    }
                }

                //如果没有错误信息,并且支付金额为0的话
                if($flag==1 && $price == 0){
                    //将现金券使用id分割为数组
                    $receive_cashed_id_arr = explode(',',$receive_cashed_id);
                    $order_update['state']=4;
                    $order_update['intflag']=5;
                    $order_update['paytype1']=1;
                    //将订单变为已支付
                    db('order')->where(['ordersn'=>$ordersn])->update($order_update);
                    $update_param['used_activity_id'] = $order_info['dataid'];//使用活动标识id
                    $update_param['used_activity_name'] = $order_info['chrtitle'];//使用活动名称
                    $update_param['used_time'] = date('Y-m-d H:i:s',time());//使用现金券时间
                    $update_param['used_order_id'] = $order_info['id'];//使用订单id
                    $update_param['used_status'] = 5;//改为已使用
                    foreach ($receive_cashed_id_arr as $value){
                        db('cashed_card_receive')->where(['id'=>$value])->update($update_param);
                    }
                    //发送报名成功提示消息
                    template_bm($order_info['id']);
                }
            }

        }

        // 不要删，兼容现金券代码 若没有运行到现金券部分，则整个事务必须提交，若要删掉这行代码，必须考虑合并本方法中的三个addOrder调用
        //  Db::commit();;

        //处理短信及微信预下单操作
        if($ischarge==2 && $price > 0)    //付费活动
        {
            // api模块 - 包含各种系统主动发起的功能
            $api = new \think\wx\Api(
                array(
                    'appId' => trim($config['appid']),
                    'appSecret'    => trim($config['appsecret']),
                    'mchId'    => trim($config['mchid']),
                    'key'    => trim($config['paykey'])
                )
            );

            $data=$this->wechatpay($api,$transaction_id,$content_info['chrtitle'].'['. $payname.']',$price,$dataID);
            $config=$api->get_jsapi_config();
            $ajaxdate['data']=$data;
            $ajaxdate['config']=$config;
            $ajaxdate['activity_cashed_set']=$activity_cashed_set; ////活动现金券的设置

            if($order_info){
                //修改成异步拉起微信支付
                $ajaxdate['order_id']=$order_info['id'];
            }
            Log::debug(date('Y-m-d H:i:s') . ' 收费活动报名成功');
        }else   //免费活动，发短信
        {
            //获取订单信息
            $order = db('order')->where(['ordersn' => $ordersn])->find();
            $replace = [];
            Log::debug(date('Y-m-d H:i:s') . ' 免费活动报名成功,订单信息:$order=' . print_r($order, true));
            //给客户和商务发短信通知  类型：7--免费活动报名成功
            sysSendMsg($idsite, 7, $order, $replace);
        }

        // var_dump($data);die;
        $roottpl = 'template/modules/';

        // var_dump($flag, $errmsg)
        $ajaxdate['order_id']=$orderid;
        $ajaxdate['res']=1;
        $ajaxdate['flag']=$flag;
        $ajaxdate['price']=$price;
        $ajaxdate['errmsg']=$errmsg;
        $ajaxdate['roottpl']='/'.$roottpl;
        $ajaxdate['sitecode']=$sitecode;
        $ajaxdate['ischarge']=$ischarge;
        $ajaxdate['ordersn']=$ordersn;
        $ajaxdate['dataID']=$dataID;
        $ajaxdate['is_cashed']=checkedMarketingPackage($idsite,'cashed');
        $ajaxdate=json_encode($ajaxdate, JSON_UNESCAPED_UNICODE);

        return $ajaxdate;
    }

    //个人信息
    public function mine(){
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;

        $userid=$this->userinfo['idmember'];
        //确认用户已登陆
        if($userid<1)
        {
            echo "请联系管理，配置好公众号和平台绑定";
            exit();
        }


        $userRow=[];//个人信息
        //$collection=[];//我的收藏
        // $comment=[];//我的评论
        // $signup=[];//我的报名

        $idsite=$config['id'];


        $userid=$this->userinfo['idmember'];

        $userRow = db('member')->where('idsite='.$idsite.' and  idmember='.$userid)->find();
        $ismanage=$userRow['ismanage'];
        //判断session中的值是否跟数据库保持一致，如果不是的话，那么就重新设置session
        if($ismanage != $this->userinfo['ismanage']){
            session("UserInfo_".$sitecode."_ismanage",empty($userRow['ismanage'])?0:1);
        }


        //cache('config'.$request['idsite']);
        $roottpl = 'template/modules/';
        $url = $roottpl.'/mine/index.html';

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('userinfo',$userRow);
        $this->assign('ismanage',$ismanage);
        $this->assign('is_integral',checkedMarketingPackage($idsite,'integral'));
        $this->assign('is_subscribe',checkedMarketingPackage($idsite,'subscribe'));
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));
        $this->assign('is_distribution',checkedMarketingPackage($idsite,'distribution'));//是否具有分销功能营销包
        // $this->assign('comment',$comment);
        // $this->assign('signup',$signup);

        $this->assign('SelectFooterTab',1);
        return $this->fetch($url);
    }

    public function signuplist()
    {

        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $userid=$this->userinfo['idmember'];
        $ipage=empty($request['ipage'])?0:$request['ipage'];
        $state=0;
        if(!empty($request['state']))
            $state=$request['state'];

        $where_arr=[];
        $where_arr['idsite']=$idsite;
        $where_arr['fiduser']=$userid;

        if($state==100)
        {
            $where_arr['dtstart']=array('>',date('Y-m-d H:i:s')) ;
        }
        elseif($state==200)
        {
            $where_arr['dtend']=array('<',date('Y-m-d H:i:s')) ;
        }
        elseif($state>0)
        {
            $where_arr['state']=$state;
        }

        //$where_arr['state']=$state;

        $result = db('order')->where($where_arr)->order("id desc")->limit($ipage*$this->PageSize,$this->PageSize)->select();
        // 查询拼团订单状态
        $map = [
            0 => '开启拼团未支付',
            1 => '拼团中',
            2 => '拼团成功',
            3 => '拼团到期',
            4 => '拼团取消'
        ];
        foreach ($result as $key => $value)
        {
            if(empty($value['group_buy_order_id']))
            {
                $result[$key]['group_buy_order_state'] = '';
            }else
            {
                $groupBuyOrder = db('group_buy_order')->where([
                        'group_buy_order_id' => $value['group_buy_order_id']
                    ])
                    ->field(['state', 'group_buy_id'])
                    ->find();
                $groupBuyOrder['state'] = $groupBuyOrder['state'] ? : 0;
                $result[$key]['group_buy_order_state_name'] = $map[$groupBuyOrder['state']];
                $result[$key]['group_buy_order_state'] = $groupBuyOrder['state'];

                if($result[$key]['state']==11){
                    $result[$key]['group_buy_order_state_name'] = '拼团失败';
                    $result[$key]['group_buy_order_state'] = 4;
                }

                $groupBuy = db('group_buy')->field('allow_refund')->find($groupBuyOrder['group_buy_id']);
                $result[$key]['isrefund'] = $groupBuy['allow_refund'];
            }
        }

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径
        $url =$roottpl.'/mine/order_list.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            $url = $roottpl . '/mine/ajax_mine_order_list.html';
        }

        //dump($result);

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('sitecode',$sitecode);
        $this->assign('list',$result);
        $this->assign('idsite',$idsite);
        $this->assign('userid',$userid);
        $this->assign('SelectFooterTab',1);
        $this->assign('order_state',config('order_state'));
        $this->assign('state',$state);
        $this->assign('order_paytype1',config('order_paytype1'));
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));

        return $this->fetch($url);

    }

    public function signupmanagelist()
    {

        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $userid=$this->userinfo['idmember'];
        $state=0;
        $ipage=empty($request['ipage'])?0:$request['ipage'];
        if(!empty($request['state']))
            $state=$request['state'];

        $txtkey=isset($request["txtkey"])?trim($request["txtkey"]):"";

        $where_arr=[];

        if($this->userinfo['ismanage']!=1)
        {
            //echo "你没有权限操作！";
            //exit();
        }

        $where_arr['idsite']=$idsite;

        if($state==100)
        {
            $where_arr['dtstart']=array('>',date('Y-m-d H:i:s')) ;
        }
        elseif($state==200)
        {
            $where_arr['dtend']=array('<',date('Y-m-d H:i:s')) ;
        }
        elseif($state>0)
        {
            $where_arr['state']=$state;
        }
        if(!empty($txtkey))
        {
            $where_arr["txtdata"]=array('like','%'.$txtkey.'%');
        }

        $result = db('order')->where($where_arr)->order("id desc")->limit($ipage*$this->PageSize,$this->PageSize)->select();
        // 查询拼团订单状态
        $map = [
            0 => '开启拼团未支付',
            1 => '拼团中',
            2 => '拼团成功',
            3 => '拼团到期',
            4 => '拼团取消'
        ];
        foreach ($result as $key => $value)
        {
            if(empty($value['group_buy_order_id']))
            {
                $result[$key]['group_buy_order_state'] = '';
            }else
            {
                $state = db('group_buy_order')->where([
                        'group_buy_order_id' => $value['group_buy_order_id']
                    ])
                    ->value('state');

                $result[$key]['group_buy_order_state'] = $map[$state];
            }
        }

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径

        $url = $roottpl . '/mine/ordermanage_list.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            $url = $roottpl . '/mine/ajax_order_list.html';
        }

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('txtkey',$txtkey);
        $this->assign('sitecode',$sitecode);
        $this->assign('state',$state);
        $this->assign('list',$result);
        $this->assign('idsite',$idsite);
        $this->assign('SelectFooterTab',1);
        $this->assign('order_state',config('order_state'));
        $this->assign('order_paytype1',config('order_paytype1'));

        return $this->fetch($url);

    }

    /**
     * 退款申请
     * @return   [type]                   [description]
     */
    public function refund()
    {
        if(Request::instance()->isPost()==false)
        {
            exit(json_encode(array( 'state'=>0,'msg'=>'非法操作')));
        }

        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        $orderid=$request["orderid"];
        $content=$request["content"];
        $upfile="";


        $datainfo=db("order")->where(array('id'=>$orderid,'idsite'=>$idsite))->find();
        if(empty($datainfo))
        {
            exit(json_encode(array( 'state'=>0,'msg'=>'报名订单不存在')));
        }
        if(!empty($datainfo['group_buy_order_id']))
        {
            $groupBuyOrder = db('group_buy_order')->find($datainfo['group_buy_order_id']);
            $groupBuy = db('group_buy')->find($groupBuyOrder['group_buy_id']);
            if($groupBuy['allow_refund'] != 1)
            {
                exit(json_encode(array( 'state'=>0,'msg'=>'该报名订单不允许退款')));
            }
        }elseif($datainfo['isrefund']!=1)
        {
            exit(json_encode(array( 'state'=>0,'msg'=>'该报名订单不允许退款')));
        }

        //处理文件
        if(!empty($_FILES['image']) && !empty($_FILES['image']['name']))
        {
            $file_name=$_FILES['image']['name'];//文件名字
            //$file_type=$_FILES['image']['type'];//文件类型
            //$file_site=$_FILES['image']['size'];//文件大小
            //
            $ext=substr($file_name, strrpos($file_name, '.'));
            $upfile='/public/uploads/'.$idsite ."/order/".date('Y',time())."/".date("m-d",time());
            $filepath= __ROOT__ ."/public". $upfile;
            $newfilename=date("YmdHis",time()).rand(10000,99999).$ext;
            if(is_dir($filepath)==false)
            {
                mkdir($filepath,0777,true);
            }
            $file_tmp_name= $_FILES['image']['tmp_name'];//上传文件路径
            $upfile=$upfile."/".$newfilename;
            move_uploaded_file($file_tmp_name,$filepath."/".$newfilename);//把图片移到服务器目录
        }

        $arr=[];
        if(empty($result['refundsn']))
        {
            $arr['refundremark']=$content;//退款原因
            $arr['refundpic']=$upfile;//退款上传图片
        }else
        {
            $arr['refundmsg2']=$content;//退款原因
            $arr['refundpic2']=$upfile;//退款上传图片
        }
        $arr['dtrefundtime']=date("Y-m-d H:i:s");
        $arr['state']=5;
        $arr['intflag']=6;


        if(db("order")->where(array('id'=>$orderid,'idsite'=>$idsite))->update($arr))
        {
            //替换信息
            $replace = [];
            //给客户和商务发短信通知    类型：3--申请退款
            sysSendMsg($idsite, 3, array_merge($datainfo, $arr), $replace);
            template_tg($orderid);
            exit(json_encode(array( 'state'=>1,'msg'=>'退款申请已提交成功')));
        }else
        {
            exit(json_encode(array( 'state'=>0,'msg'=>'退款申请已提交失改')));
        }
    }


    public function orderdetail()
    {

        $request = Request::instance()->param();
        $id=$request['id'];
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        $row = db('order')->where(array('id'=>$id))->find();

        if($row && $row['group_buy_order_id'])
        {
            $package = db('package')->find($row['package_id']);
            $row['payname'] = $package['keyword1'] . ' ' . $package['keyword2'] . ' 拼团价' . $row['price'] / $row['paynum'] . ' (原价 ' . $package['member_price'] . ')';
        }

        $frmdata=[];

        if($row && !empty($row['txtdata']))
        {

            $row2= explode("☆", $row['txtfield']);
            $row1= explode("☆", $row['txtdata']);
            foreach($row1 as $k=>$vo) {
                $arr = explode("∫", $row2[$k]);
                $datatype = 1;
                $datafield = $arr[0];
                if (count($arr) > 1) {
                    $datatype = $arr[1];
                }
                if($datatype==7)
                {
                    $frmdata[$datafield]='<img src="'.$vo.'" style="border: 0px;height: 50px;padding: 1px;"  />';
                }
                else
                {
                    $frmdata[$datafield]=$vo;
                }

            }
        }

        $frmdatasub=[];

        if($row && !empty($row['txtdata1']))
        {

            $row2= explode("☆", $row['txtfield1']);

            $frmdatasubRow=explode("§", $row['txtdata1']);

            foreach ($frmdatasubRow as $k1=>$vo)
            {
                $row1= explode("☆", $vo);
                $frmdata1=[];
                foreach($row1 as $k=>$vo) {
                    $arr = explode("∫", $row2[$k]);
                    $datatype = 1;
                    $datafield = $arr[0];
                    if (count($arr) > 1) {
                        $datatype = $arr[1];
                    }
                    if($datatype==7)
                    {
                        $frmdata1[$datafield]='<img src="'.$vo.'" style="border: 0px;height: 50px;padding: 1px;"  />';
                    }
                    else
                    {
                        $frmdata1[$datafield]=$vo;
                    }
                }
                $frmdatasub[]=$frmdata1;

            }

        }

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径
        $url =$roottpl.'/mine/order_detail.html';

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('sitecode',$sitecode);
        $this->assign('orderinfo',$row);
        $this->assign('frmdatasub',$frmdatasub);
        $this->assign('frmdata',$frmdata);
        $this->assign('idsite',$idsite);
        $this->assign('order_state',config('order_state'));
        $this->assign('order_paytype1',config('order_paytype1'));
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));

        return $this->fetch($url);

    }

    public function ordermanagedetail()
    {

        $request = Request::instance()->param();
        $id=$request['id'];
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        if($this->userinfo['ismanage']!=1)
        {
            echo "你没有权限操作！";
            exit();
        }

        //审核通过|不通过
        if (Request::instance()->isPost()) {
            ob_end_clean();
            $flag=$request['flag'];
            if(empty($flag) || !in_array($flag, [2, 3]))
            {
                echo "0";
                exit();
            }

            $arr=[];
            $arr['state']= $flag;

            db('order')->where(array('id'=>$id))->update($arr);

            $tmp_Result= db('order')->where(array('id'=>$id))->find();
            if($tmp_Result)
            {
                SetUserPayCount($tmp_Result['fiduser']);
            }
            template_bm($id);

            $obj = new \app\admin\module\Order;
            Log::debug('前端审核，参数是' . print_r([$id, $flag], true));
            $obj->signInNotice($id, $idsite);

            echo "1";
            exit();

        }


        $row = db('order')->where(array('id'=>$id))->find();
        if($row && $row['group_buy_order_id'])
        {
            $package = db('package')->find($row['package_id']);
            $row['payname'] = $package['keyword1'] . ' ' . $package['keyword2'] . ' 拼团价' . $row['price'] / $row['paynum'] . ' (原价 ' . $package['member_price'] . ')';
        }

        $frmdata=[];

        if($row && !empty($row['txtdata']))
        {
            $row2= explode("☆", $row['txtfield']);
            $row1= explode("☆", $row['txtdata']);
            foreach($row1 as $k=>$vo) {
                $arr = explode("∫", $row2[$k]);
                $datatype = 1;
                $datafield = $arr[0];
                if (count($arr) > 1) {
                    $datatype = $arr[1];
                }
                if($datatype==7)
                {
                    $frmdata[$datafield]='<img src="'.$vo.'" style="border: 0px;height: 50px;padding: 1px;"  />';
                }
                else
                {
                    $frmdata[$datafield]=$vo;
                }

            }
        }

        $roottpl = 'template/modules/';
        //获得栏目列表模版路径


        $url =$roottpl.'/mine/ordermanage_detail.html';

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('sitecode',$sitecode);
        $this->assign('orderinfo',$row);
        $this->assign('frmdata',$frmdata);
        $this->assign('idsite',$idsite);
        $this->assign('order_state',config('order_state'));
        $this->assign('order_paytype1',config('order_paytype1'));

        return $this->fetch($url);

    }

    public function collection()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];

        $userid=$this->userinfo['idmember'];
        $ipage=empty($request['ipage'])?0:$request['ipage'];
        $page_size = 10;
        $collection = db('collection')->where('idsite='.$idsite.' and  userid='.$userid)->limit($ipage*$page_size,$page_size)->select();

        //cache('config'.$request['idsite']);
        $roottpl = 'template/modules/';
        $url = $roottpl.'/mine/collection.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            $url = $roottpl . '/mine/ajax_collection.html';
        }

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('collection',$collection);
        return $this->fetch($url);

    }
    function addcomment(){
        $request = Request::instance()->param();

        $userinfo=db('member')->where(array('idmember'=>$this->userinfo['idmember']))->find();

        $flag=empty($request['flag'])?1:$request['flag'];
        $arr=[];
        $arr['iduser']=$this->userinfo['idmember'];
        $arr['username']=$userinfo['nickname'];
        $arr['userimg']=$userinfo['userimg'];
        $arr['idsite']=$request['idsite'];
        $arr['dataid']=$request['dataid'];
        $arr['chrtitle']=$request['chrtitle'];
        $arr['content']=$request['content'];
        $arr['flag']=$flag;
        $arr['createtime']=time();
        $arr['intstate']=2;
        $arr['show']=0;
        //print_r($arr);
        $bool=db('comment')->insert($arr);
        //评论添加成功
        //TODO 新增评论短信提醒
        // if($bool)
        // {
        //     $activity = db('activity')
        //         ->field([
        //             'short_title',
        //             'intselmarket'
        //         ])
        //         ->where([
        //             'idactivity' => $request['dataid']
        //         ])
        //         ->find();
        //     $order = [];
        //     $replace = [
        //         '{name}' => $arr['username'],
        //         '{title}' => $activity['short_title'],
        //     ];
        //     //给客户和商务发短信通知    类型：12--回复评论
        //     sysSendMsg($idsite, 12, $order, $replace, $activity['intselmarket']);
        // }
        echo "1";
        exit();

    }
    public function comment()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $key=empty($request['key'])?'':$request['key'];
        $idsite=$config['id'];
        $flag=I('flag',0);
        $userid=$this->userinfo['idmember'];
        $ipage=empty($request['ipage'])?0:$request['ipage'];
        $page_size = 10;
        $arr=[];
        $arr['idsite']=$idsite;
        $arr['iduser']=$userid;
        if($flag>0)
        {
            $arr['flag']=$flag;
        }

        if($key!='')
        {
            $arr['content']=array('like',"%".$key."%");
        }

        $comment = db('comment')->where($arr)->limit($ipage*$page_size,$page_size)->select();
        //cache('config'.$request['idsite']);
        $roottpl = 'template/modules/';
        $url = $roottpl.'/mine/comment.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            $url = $roottpl . '/mine/ajax_comment.html';
        }

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('list',$comment);
        $this->assign('SelectFooterTab',1);
        $this->assign('flag',$flag);
        return $this->fetch($url);

    }


    public function commentmanage()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $key=empty($request['key'])?'':$request['key'];
        $idsite=$config['id'];
        $flag=I('flag',0);
        $userid=$this->userinfo['idmember'];
        $ipage=empty($request['ipage'])?0:$request['ipage'];
        $page_size = 10;

        if (Request::instance()->isPost())
        {
            $id=$request['dataid'];

            $comment = db('comment')
                ->field('id')
                ->where([
                    'id' => $id,
                    'idsite' => $idsite,
                    'intstate' => 4,
                    'recontent' => $request['content'], 
                ])
                ->find();
            if($comment)
            {
                echo '1';
                exit();
            }
            $comment = db('comment')
                ->field([
                    'dataid',
                    'iduser',
                ])
                ->where([
                    'id' => $id,
                    'idsite' => $idsite,
                ])
                ->find();


            $data=[];
            $data['intstate']=4;
            $data['retime']=time();
            $data['recontent']=$request['content'];
            $data['reid']=$this->userinfo['idmember'];
            $data['rename']=$this->userinfo['nickname'];
            $bool=db('comment')->where(array('id'=>$id,'idsite'=>$idsite))->update($data);
            if($bool)
            {
                Log::debug('微信前端回复评论后发短信 ' . print_r($comment, true));
                $obj = new \app\admin\module\Comment;
                $obj->replyCommentNotice($comment['dataid'], $comment['iduser'], $idsite);
            }else
            {
                echo "0";
            }
            exit();
        }


        $arr=[];
        $arr['idsite']=$idsite;
        if($flag>0)
        {
            $arr['flag']=$flag;
        }

        if($key!='')
        {
            $arr['content']=array('like',"%".$key."%");
        }

        $comment = db('comment')->where($arr)->order("intstate asc,id desc")->limit($ipage*$page_size,$page_size)->select();
        //cache('config'.$request['idsite']);
        $roottpl = 'template/modules/';
        $url = $roottpl.'/mine/commentmanage.html';

        if (Request::instance()->isAjax() && isset($request['ajax'])) {
            $url = $roottpl . '/mine/ajax_commentmanage.html';
        }

        $this->assign('roottpl','/'.$roottpl);
        $this->assign('idsite',$idsite);
        $this->assign('sitecode',$sitecode);
        $this->assign('list',$comment);
        $this->assign('SelectFooterTab',1);
        $this->assign('flag',$flag);
        return $this->fetch($url);

    }

    public function showcomment(){
        $request = Request::instance()->param();
        $id=$request['id'];
        if($id==0)
            return 0;

        $show=$request['show'];
        if($show == 1)
            $show = 2;
        else
            $show = 1;

        $bool=db('comment')->where(['id'=>$id])->update(['show'=>$show]);

        if($bool)
            return 1;
        else
            return 0;

    }

    public function delcomment(){
        $request = Request::instance()->param();
        $userid=$this->userinfo['idmember'];
        $id=I('id',0);
        if($id==0)
        {
            echo '0';
            exit();
        }

        $arr=[];
        $arr['id']=$id;
        if($this->userinfo['ismanage']!=1)
        {
            $arr['iduser']=$userid;
        }

        $bool=db('comment')->where($arr)->delete();

        if($bool)
            echo "1";
        else
            echo "0";

        exit();

    }

    //详情页面
    public function info(){
        $request = Request::instance()->param();
        $content_id = $request['contentid']; // 当前内容id

        //检测它的父节点是否需要登录才能浏览
        $content_info = db('content')->where('contentid='.$request['contentid'])->field('siteid,nodeid,fieldspare10')->find();
        if(empty($content_info))
        {
            header("location:/error.php?msg=".urlencode("没找到相关文章，有疑问请和管理联系！")."&url=");
            exit();
        }


        $node_info = db('node')->where('nodeid='.$content_info['nodeid'])->find();
        //if(strstr($node_info['option'],'3')){
        //   return "请登录";
        //}

        //该文章的评论列表
        $comment_list = db('comment')->where('dataid='.$content_id." and `show`=1")->select();
        $idsite=$content_info['siteid'];
        $roottpl = 'template/modules/';
        //获得栏目列表模版路径

        $sitecode=$this->getsitecode($idsite);

        $config=$this->wxConfig;

        $url=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api(
            array(
                'appId' => trim($config['appid']),
                'appSecret'    => trim($config['appsecret']),
            )
        );
        $signPackage=$api->get_jsapi_config($url);
        $this->assign('signPackage',$signPackage);

        if(empty($node_info['templateofnodecontent'])){
            $url = $roottpl.'/'.GetConfigVal("weboption","contentstencil",$idsite); //模版路径
        }else{
            $url =$roottpl.'/'.$node_info['templateofnodecontent'];
        }

        $visitflag=0;
        $userid=$this->userinfo['idmember'];
        if($userid>0)
        {
            $visitinfo=db("collection")->where(array('dataid'=>$content_id,'userid'=>$userid,'flag'=>1))->find();
            if($visitinfo)
                $visitflag=1;

        }

        //查询用户是否有权限查看此文章
        $content_usertype=$content_info['fieldspare10'];
        if(!empty($content_usertype)){
            $usertype=db('member')->where(['idmember'=>$userid])->column('categoryid');

            if(empty($usertype))
            {
                $usertype="123456asdfzdsfv";
            }
            else
            {
                $usertype=$usertype[0];
            }

            //dump($usertype);

            //获取分类的名字
            $obj = new \app\admin\module\activity($idsite);
            $hyfl=$obj->getDic("hyfl");
            $type=[];
            foreach($hyfl as $v){
                $type[$v['id']]=$v['name'];
            }
            $usertypename='';
            foreach (explode('|',$content_usertype) as $v){
                if(array_key_exists($v,$type))
                {
                    $usertypename=$usertypename.$type[$v].',';
                }
            }
            $usertypename=rtrim($usertypename,',');
            if(strpos($content_usertype,$usertype) == false){
                $usertypeflag=1;
                $this->assign('usertypeflag',$usertypeflag);
                $this->assign('usertype',$usertypename);
            }


        }




        $this->assign('roottpl','/'.$roottpl);
        $this->assign('comment_list',$comment_list);
        $this->assign('node_info',$node_info);
        $this->assign('visitflag',$visitflag);
        $this->assign('idsite',$idsite);
        $this->assign('content_id',$content_id);
        $this->assign('sitecode',$this->getsitecode($idsite));
        $this->assign('SelectFooterTab',1);
        return $this->fetch($url);
    }

    //文章翻页
    public function updown(){
        $request = Request::instance()->param();

        $model_type = db('model')->where('modeltype=4 and isusing = 1')->find();
        //根据模型id找出对应的模型字段
        $model_fields = db('modelfield')->where('idmodel='.$model_type['idmodel'].' and isusing=1')->select();
        $this->assign('model_field',$model_fields);
        $this->assign('model_id',$model_type['idmodel']);

        $content_info = db('content')->where('contentid='.$request['contentid'])->find();
        $map['nodeid'] = ['eq',$content_info['nodeid']];
        if($request['action'] == 'up'){
            $map['contentid'] = ['<',$content_info['contentid']];
            $order = 'desc';
        }else{
            $map['contentid'] = ['>',$content_info['contentid']];
            $order = 'asc';
        }

        $content = db('content')->where($map)->order('contentid '.$order)->find();

        if(empty($content)){
            $content_id = $content_info['contentid'];
        }else{
            $content_id = $content['contentid'];
        }
        $this->assign('content_id',$content_id);

        //根据模型id找出对应的模型字段
        $model_type = db('model')->where('modeltype=4 and isusing = 1')->find();
        $model_fields = db('modelfield')->where('idmodel='.$model_type['idmodel'].' and isusing=1')->select();
        //该文章的评论列表
        $comment_list = db('comment')->where('contentid='.$content_id.' and intlock=1')->select();

        //获得栏目列表模版路径
        $node_info = db('node')->where('nodeid='.$content_info['nodeid'])->find();
        if(empty($node_info['templateofnodecontent'])){
            $url = ROOT_PATH.GetConfigVal("weboption","stencildir").GetConfigVal("weboption","contentstencil"); //模版路径
        }else{
            $url = ROOT_PATH.GetConfigVal('weboption','stencildir').$node_info['templateofnodecontent'];
        }
        $this->assign('comment_list',$comment_list);
        $this->assign('model_field',$model_fields);
        return $this->fetch($url);
    }

    //留言
    public function comment1(){
        $request = Request::instance()->param();
        foreach ($request as $key=>$value){
            $request[$key] = field_filter($value);
        }

        $request['addtime'] = time();
        $bool = db('comment')->insert($request);
        if($bool){
            return 1;
        }else{
            return 2;
        }
    }

    //验证码
    public function yzm(){
        //ob_end_clean();
        $captcha = new Captcha();
        $captcha->entry();
    }

    //多语言
    public function lang(){

        switch ($_GET['lang']) {
            case 'cn':
                session('aa', 'cn');
                break;
            case 'en':
                session('aa', 'en');
                break;
            case 'tc':
                session('aa', 'tc');
                break;
            //其它语言
        }

    }

    //收藏
    public function addcollection()
    {
        $request = Request::instance()->param();
        $idsite=$request['idsite'];
        $title=$request['title'];
        $ContentID=$request['id'];
        $flag=empty($request['flag'])?1:$request['flag'];

        $arr=[];
        $arr['userid']=$this->userinfo['idmember'];
        $arr['username']=$this->userinfo['nickname'];
        $arr['idsite']=$idsite;
        $arr['dataid']=$ContentID;
        $arr['chrtitle']=$title;
        $arr['flag']=$flag;
        $arr['createtime']=time();
        //print_r($arr);
        $bool=db('collection')->insert($arr);
        echo "1";
        exit();
    }

    public function delcollection()
    {
        $request = Request::instance()->param();
        $id=$request['id'];
        $arr=[];

        $arr['id']=$id;
        $arr['userid']=$this->userinfo['idmember'];
        //print_r($arr);
        $bool=db('collection')->where($arr)->delete();
        echo "1";
        exit();
    }

    //访问记录
    public function addwaitervisit()
    {
        $request = Request::instance()->param();
        $arr=[];
        $arr["openid"]=$this->userinfo['openid'];
        $arr["name"]=$this->userinfo['nickname'];
        $arr["createtime"]=time();
        $arr["idsite"]=$request['idsite'];
        $arr["flag"]=empty($request['flag'])?0:$request['flag'];
        $arr["aid"]=empty($request['id'])?0:$request['id'];

        db("waiter_visit")->insert($arr);
        exit();
    }

    //访问记录
    public function addVisitRecord()
    {
        $request = Request::instance()->param();
        $idsite=$request['idsite'];
        $title=$request['title'];
        $ContentID=$request['id'];
        $flag=empty($request['flag'])?1:$request['flag'];
        $guid=$request['guid'];
        if($flag==1)
        {
            $cate = db('content')->where('contentid='.$ContentID)->setInc('hits',1);
        }
        else
        {
            $cate = db('activity')->where('idactivity='.$ContentID)->setInc('hits',1);
        }
		$source = '其它';
		$http_referer = $_SERVER["HTTP_REFERER"];
		if($http_referer){
			$host = parse_url($http_referer)['host'];
			$sourceArray = config('source');
			if($sourceArray){
				foreach($sourceArray as $key => $value){
                    if($host == $key){
                        $source = $value;
                        break;
                    }
				}
			}
		}else{
			$source = '本站';
		}

        $this->visitdata($idsite,$ContentID,$title,$flag,$guid,$source);
        exit();
    }

    public function addVisitRecorded()
    {
        $request = Request::instance()->param();
        $guid=$request['guid'];
        $tmptime= db('visit_record')->where(array('guid'=>$guid))->field('stime')->find();
        //print_r($tmptime);
        $tmptime1=time();
        $arr=[];
        $arr['etime']=$tmptime1;
        $arr['differtime']=$tmptime1-$tmptime['stime'];
        $bool=db('visit_record')->where(array('guid'=>$guid))->update($arr);
    }
    public function visitdata($idsite,$dataid,$title,$flag,$guid,$source)
    {
        $arr=[];
        $arr['userid']=$this->userinfo['idmember'];
        $arr['username']=$this->userinfo['nickname'];
        $arr['openid']=$this->userinfo['openid'];
        $arr['idsite']=$idsite;
        $arr['aid']=$dataid;
        $arr['atitle']=$title;
        $arr['flag']=$flag;
        $arr['guid']=$guid;
		$arr['source']=$source;
        $arr['stime']=time();

        $arr['ip']=$this->ip();
        $arr['createtime']=date('Y-m-d H:i:s');
        //print_r($arr);
        $bool=db('visit_record')->insert($arr);

    }
    public function ip() {
        //strcasecmp 比较两个字符，不区分大小写。返回0，>0，<0。
        if(getenv('HTTP_CLIENT_IP') && strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')) {
            $ip = getenv('HTTP_CLIENT_IP');
        } elseif(getenv('HTTP_X_FORWARDED_FOR') && strcasecmp(getenv('HTTP_X_FORWARDED_FOR'), 'unknown')) {
            $ip = getenv('HTTP_X_FORWARDED_FOR');
        } elseif(getenv('REMOTE_ADDR') && strcasecmp(getenv('REMOTE_ADDR'), 'unknown')) {
            $ip = getenv('REMOTE_ADDR');
        } elseif(isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] && strcasecmp($_SERVER['REMOTE_ADDR'], 'unknown')) {
            $ip = $_SERVER['REMOTE_ADDR'];
        }
        if('::1'==$ip)
        {
            $ip='127.0.0.1';
        }
        $res =  preg_match ( '/[\d\.]{7,15}/', $ip, $matches ) ? $matches [0] : '';
        return $res;
        //dump(phpinfo());//所有PHP配置信息
    }
    //读取配配信息
    public function getWeiXinConfig($sitecode)
    {
        $config=cache("WeiXinConfig");
        if(empty($config))
        {
            $config=[];
        }

        if(array_key_exists($sitecode,$config)==false)
        {
            $data=db('site_manage')->field('id,site_name,appid,appsecret,token,encodingaeskey,mchid,paykey,cainfo,sslcertpath,sslkeypath')->where(['site_code'=>$sitecode])->find();
            if($data)
            {
                $config[$sitecode]=$data;
                cache("WeiXinConfig",$config);
            }
            else
            {
                echo $sitecode." 不存在！";
                exit();
            }
        }

        return $config[$sitecode];
    }

    private function  getUserInfo($v)
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $key="UserInfo_".$sitecode.'_'.$v;

        if(empty(session($key)))
        {
         //   if(empty(session("UserInfo_load_".$sitecode)))
            {
                session("UserInfo_load_".$sitecode,true);
                $this->getuserinfo1();
            }
            if(empty(session($key)))
            {
                return "";
            }
        }
        return session($key);
    }

    public function getsitecode($idSite)
    {
        $row = db('site_manage')->where('id='.$idSite)->find();
        if($row)
        {
            return $row['site_code'];
        }
        return '';
    }

    private  function _strlen($str)
    {
        preg_match_all("/./us", $str, $matches);
        return count(current($matches));
    }

    private function wechatpay($api,$ordersn,$name,$total,$dataid)
    {

        if(empty($this->userinfo['idmember']))
        {
            echo '登陆已超时！';
            //return true;
        }

        $request = Request::instance()->param();
        $sitecode=strtolower($request['sitecode']);
        $config=$this->wxConfig;;

        $conf=[];
        //$conf['attach']='童享云';
        $length = $this->_strlen($name);
        if($length >=18) {
            $body = mb_substr($name, 0, 15, 'utf-8')."...";
        }else{
            $body = $name;
        }
        $conf['body']= $body;
        $conf['openid']=$this->userinfo['openid'];
        $conf['notify_url']=ROOTURL."/".$sitecode."/signup_post1/".$dataid.".html" ;
        $conf['out_trade_no']=$ordersn;
        $conf['total_fee']=$total*100;//总金额
        $conf['trade_type']='JSAPI';
        //$conf['scene_info']='{"h5_info": {"type":"Wap","wap_url": "'.ROOTURL.'","wap_name": "童享云"}}';

        $re=$api->wxPayUnifiedOrder($conf);
        Log::info('微信下单返回'.json_encode($re,JSON_UNESCAPED_UNICODE));
        if($re['return_code']=='FAIL')
        {
            print_r($conf);
            echo $re['return_msg'];
            exit();
        }
        if($re['result_code']=='FAIL')
        {
            print_r($conf);
            echo  $re['err_code'];
            exit();
        }

        $data=$api->getWxPayJsApiParameters($re['prepay_id']);
        return $data;

    }
    public function loginlog()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $userid=$this->userinfo['idmember'];
        $arr=[];

        if(!empty($request["latitude"])) $arr["latitude"]=$request["latitude"];
        if(!empty($request["longitude"])) $arr["longitude"]=$request["longitude"];
        if(!empty($request["address"])) $arr["address"]=$request["address"];
        $arr["userid"]=$userid;
        $arr["idsite"]=$idsite;
        $arr["ip"]=getip();
        $arr["createtime"]=time();

        $bl=db("login_log")->insert($arr);
        if($bl)
        {
            $tmpData=db("login_log")->field("address,COUNT(*) as vcount")->where(array("userid"=>$userid))->group("address")->order("vcount desc")->limit(0,1)->select();
            if($tmpData)
            {
                $datainfo=db("member")->where(array("idmember"=>$userid))->find();
                if($datainfo)
                {
                    $visitcount=$datainfo["visitcount"];
                    if(empty($visitcount))
                        $visitcount=0;
                    $visitcount=$visitcount+1;
                    if($tmpData[0]["address"]!=$datainfo["chraddress"])
                    {
                        //db("member")->where(array("idmember"=>$userid))->update(array("chraddress"=>$tmpData[0]["address"],"dtlastvisitteim"=>time(),"visitcount"=>$visitcount));
                        db("member")->where(array("idmember"=>$userid))->update(array("chraddress"=>$tmpData[0]["address"]));
                    }
                    else
                    {
                        db("member")->where(array("idmember"=>$userid))->update(array("dtlastvisitteim"=>time(),"visitcount"=>$visitcount));
                    }

                }
            }
            exit(json_encode(array("state"=>1,"msg"=>"")));
        }
        else
        {
            exit(json_encode(array("state"=>0,"msg"=>"写日记失败！")));
        }

    }

    private function loginCount()
    {
        $userid=$this->userinfo['idmember'];
        if(!empty($userid))
        {
            $datainfo=db("member")->where(array("idmember"=>$userid))->find();
            if($datainfo)
            {
                $visitcount=$datainfo["visitcount"];
                if(empty($visitcount))
                    $visitcount=0;

                $visitcount=$visitcount+1;
                db("member")->where(array("idmember"=>$userid))->update(array("dtlastvisitteim"=>time(),"visitcount"=>$visitcount));
            }
        }
    }

    //转发日记
    public function forwardedlog()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];
        $config=$this->wxConfig;
        $idsite=$config['id'];
        $userid=$this->userinfo['idmember'];
        $arr=[];
        $share_id = '';
        $a = '';
        if(!empty($request["dataid"])) $arr["dataid"]=$request["dataid"];
        if(!empty($request["chrtitle"])) $arr["chrtitle"]=$request["chrtitle"];
        if(!empty($request["chrdesc"])) $arr["chrdesc"]=$request["chrdesc"];
        if(!empty($request["chrlink"])) $arr["chrlink"]=$request["chrlink"];
        if(!empty($request["imgurl"])) $arr["imgurl"]=$request["imgurl"];
        if(!empty($request["datatype"])) $arr["datatype"]=$request["datatype"];
        if(!empty($request["inttype"])) $arr["inttype"]=$request["inttype"];
        //分销的分享id
        if(!empty($request["share_id"])) $share_id = intval($request["share_id"]);
        //用户二维码id
        if(!empty($request["a"])) $a = intval($request["a"]);
        //如果有用户二维码id
        if ($a){
            $share_id = $a;
        }
        $query = new Query();
        $query->startTrans();
        try {
            //如果有分销的分享id
            if($share_id){
                //查询出活动的信息
                $activity_info = db('activity')->field('chrkeyword',true)->where(['idactivity'=>$arr["dataid"],'siteid'=>$idsite])->find();
                //查询出该用户是否有代言过该商品
                $spokesman_activity = db('spokesman_activity')->field('site_id',true)->where(['activity_id'=>$arr["dataid"],'site_id'=>$idsite,'spokesman_user_id'=>$share_id])->find();
                //查询出代言人的信息
                $spokesman_info = db('member')->where(['idmember'=>$share_id,'idsite'=>$idsite])->find();
                //如果代言过,那么就进行修改代言活动表中的分享数据
                if($spokesman_activity){
                    //如果分享id和该用户id一致  那么就是代言人自己分享
                    if($userid == $share_id){
                        $update_spokesman_activity['oneself_share_time'] = $spokesman_activity['oneself_share_time'] + 1;
                    }else{
                        //他人分享
                        $update_spokesman_activity['others_share_time'] = $spokesman_activity['others_share_time'] + 1;
                    }
                    //进行修改
                    db('spokesman_activity')->where(['activity_id'=>$arr["dataid"],'site_id'=>$idsite,'spokesman_user_id'=>$share_id])->update($update_spokesman_activity);
                }else{
                    //进行数据库的插入
                    db("spokesman_activity")->insert([
                        'activity_id'=>$arr["dataid"],
                        'chrtitle'=>$activity_info['chrtitle'],
                        'chrimg'=>$activity_info['chrimg_m'],
                        'dtstart'=>$activity_info['dtstart'],
                        'dtend'=>$activity_info['dtend'],
                        'dtsignstime'=>$activity_info['dtsignstime'],
                        'dtsignetime'=>$activity_info['dtsignetime'],
                        'spokesman_time'=>date('Y-m-d H:i:s',time()),
                        'spokesman_user_id'=>$share_id,
                        'spokesman_nick_name'=>$spokesman_info['nickname'],
                        'spokesman_name'=>$spokesman_info['u_chrname'],
                        'get_commission'=>0,
                        'oneself_share_time'=>1,
                        'site_id'=>$idsite,
                    ]);
                    //进行修改用户的活动代言个数
                    db('member')->where(['idmember'=>$share_id,'idsite'=>$idsite])->setInc('spokesman_activity_num',1);
                }
                //修改活动表中的分享次数
                db('activity')->where(['idactivity'=>$arr["dataid"],'siteid'=>$idsite])->update(['share_time'=>$activity_info['share_time'] + 1]);
            }
            $arr["userid"]=$userid;
            $arr["idsite"]=$idsite;
            $arr["ip"]=getip();
            $arr["createtime"]=time();

            $bl=db("forwarded_log")->insert($arr);
            $query->commit();
        } catch (\Exception $e) {
            $query->rollBack();
            Log::error('分享执行数据库出错，info:' . print_r($e, true));
        }
    }

    //增加用户
    public function addUser($data,$siteid,$sitecode)
    {

        /*
        {    "openid":" OPENID",
            " nickname": NICKNAME,
            "sex":"1",
            "province":"PROVINCE"
            "city":"CITY",
            "country":"COUNTRY",
            "headimgurl":    "http://thirdwx.qlogo.cn/mmopen/g3MonUZtNHkdmzicIlibx6iaFqAc56vxLSUfpb6n5WKSYVY0ChQKkiaJSgQ1dZuTOgvLLrhJbERQQ4eMsv84eavHiaiceqxibJxCfHe/46",
            "privilege":[ "PRIVILEGE1" "PRIVILEGE2"     ],
            "unionid": "o6_bmasdasdsad6_2sgVt7hMZOPfL"
          }
        */
        $bool=false;
        if(empty($data) || !isset($data->openid))
            return $bool;

        if(!empty($data->province) && !empty($data->city)) {
            $tmpIDs = getRegionIDs($data->province, $data->city);
            $arr['intcity'] = $tmpIDs[1];
            $arr['intprovince'] = $tmpIDs[0];
        }
        $arr['openid']=$data->openid;
        $arr['chrname']=empty($data->nickname)?"游客": $arr['chrname']=$data->nickname;
        $arr['nickname']=empty($data->nickname)?"游客":$data->nickname;
        if(!empty($data->sex)) $arr['intsex']=$data->sex;
        if(!empty($data->headimgurl)) $arr['userimg']=$data->headimgurl;//$this->getUserImg($data->headimgurl,$siteid);
        $arr['dtcreatetime']=time();
        $dtsubscribetime =0 ;
        //$arr['unionid']=$data->unionid;
        //$arr['subscribe_scene']=$data->subscribe_scene;
        //$arr['qr_scene']=$data->qr_scene;
        $arr['intstate']=3;//会员状态（1审批通过 2取消关注 3游客）
        if(!empty($data->unionid))
        {
            $arr['intstate']=1;//会员状态（1审批通过 2取消关注 3游客）
            $arr['unionid']=$data->unionid;
            $dtsubscribetime = time();
            $arr['dtsubscribetime'] = $dtsubscribetime;
        }
        //$arr['qr_scene_str']=$data->qr_scene_str;
        $arr['intlock']=2;//1锁定  2 未锁定
        $arr['idsite']=$siteid;

        $userinfo=db('member')->where(array('openid'=>$data->openid,'idsite'=>$siteid))->find();
        if(!$userinfo)
        {
            //$arr['visitcount']=1;
            //$arr['dtlastvisitteim']=time();
            $bool=db('member')->insert($arr);

            //添加会员状态日志
            $logArr = $arr;
            $logArr["openid"] = $data->openid;
            $logArr["idmember"] =db('member')->getLastInsID();
            member_log($logArr,1);

            $userinfo=db('member')->where(array('openid'=>$data->openid,'idsite'=>$siteid))->find();
        }

        if($userinfo)
        {
            session("UserInfo_".$sitecode."_nickname",$userinfo["nickname"]);
            session("UserInfo_".$sitecode."_openid",$userinfo["openid"]);
            session("UserInfo_".$sitecode."_ismanage",empty($userinfo["ismanage"])?0:$userinfo["ismanage"]);
            session("UserInfo_".$sitecode."_userid",$userinfo['idmember']);
            session("UserInfo_".$sitecode."_siteid",$userinfo['idsite']);
        }
        return $bool;
    }

    //取得用户头像
    public function getUserImg($url,$SiteID)
    {

        $path='public/uploads/'.$SiteID.'/Member/photo';
        if(is_dir($path)==false)
        {
            mkdir($path, 0777, true);
        }
        $path=$path."/".getNumber().".jpg";
        //$url ='http://mmbiz.qpic.cn/mmbiz/PGkxayImcuhpTfGWiagtAY1R8L7C1licueqssxnJSJJntscaUrK6vAiakqo4RXdv2bud2ic3YicVbvIghLFhGc5ByyA/0';
        file_put_contents($path, file_get_contents($url));
        return $path;
    }

    function isMobile() {
        // 如果有HTTP_X_WAP_PROFILE则一定是移动设备
        if (isset($_SERVER['HTTP_X_WAP_PROFILE'])) {
            return 0;//true;
        }
        // 如果via信息含有wap则一定是移动设备,部分服务商会屏蔽该信息
        if (isset($_SERVER['HTTP_VIA'])) {
            // 找不到为flase,否则为true
            return stristr($_SERVER['HTTP_VIA'], "wap") ? true : false;
        }
        // 脑残法，判断手机发送的客户端标志,兼容性有待提高。其中'MicroMessenger'是电脑微信
        if (isset($_SERVER['HTTP_USER_AGENT'])) {
            $clientkeywords = array('nokia','sony','ericsson','mot','samsung','htc','sgh','lg','sharp','sie-','philips','panasonic','alcatel','lenovo','iphone','ipod','blackberry','meizu','android','netfront','symbian','ucweb','windowsce','palm','operamini','operamobi','openwave','nexusone','cldc','midp','wap','mobile','MicroMessenger');
            // 从HTTP_USER_AGENT中查找手机浏览器的关键字
            if (preg_match("/(" . implode('|', $clientkeywords) . ")/i", strtolower($_SERVER['HTTP_USER_AGENT']))) {
                return true;
            }
        }
        // 协议法，因为有可能不准确，放到最后判断
        if (isset ($_SERVER['HTTP_ACCEPT'])) {
            // 如果只支持wml并且不支持html那一定是移动设备
            // 如果支持wml和html但是wml在html之前则是移动设备
            if ((strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') !== false) && (strpos($_SERVER['HTTP_ACCEPT'], 'text/html') === false || (strpos($_SERVER['HTTP_ACCEPT'], 'vnd.wap.wml') < strpos($_SERVER['HTTP_ACCEPT'], 'text/html')))) {
                return true;
            }
        }
        return false;
    }

    //清空用户Session变量
    public function getuserinfo1()
    {
        $request = Request::instance()->param();
        $sitecode=$request['sitecode'];

        if(strstr(getip(),'192.168.168'))
        {
            //$userinfo=db('member')->where(array('openid'=>"oZS4v1aiMfreRinDgG-uWZFEDpnk"))->find();
            $userinfo=db('member')->where(array('openid'=>"oZS4v1WWxE2vzQKc6vjUNJmnmlp8"))->find();
           // $userinfo=db('member')->find(534);
            if($userinfo)
            {
                session("UserInfo_".$sitecode."_nickname",$userinfo["nickname"]);
                session("UserInfo_".$sitecode."_openid",$userinfo["openid"]);
                session("UserInfo_".$sitecode."_ismanage",0);
                session("UserInfo_".$sitecode."_userid",$userinfo['idmember']);
                session("UserInfo_".$sitecode."_siteid",$userinfo['idsite']);
            }
            return;
        }


        if($this->isMobile()==false || (empty($request['type'])==false && $request['type']=='test'))
        {
            return;
        }

        $config=$this->wxConfig;
        $idsite=$config['id'];
        $url=ROOTURL.$_SERVER['REQUEST_URI'];
        $api = new \think\wx\Api(
            array(
                'appId' => trim($config['appid']),
                'appSecret'    => trim($config['appsecret']),
            )
        );

        $reload=false;
        if(!empty(session('getuserinfog_code')) && !empty($request['code']))
        {
            if(session('getuserinfog_code')==$request['code'])
            {
                $reload=true;
            }
        }

        if(empty($request['code']) || $reload==true)
        {
            //snsapi_base snsapi_userinfo
            $url= $api->get_authorize_url('snsapi_base',$url,1);
            //echo $url;
            header("location:".$url);
            exit();
        }
        $result = $api->get_userinfo_by_authorize('snsapi_userinfo');
        //print_r($result);
        $this->addUser($result[1],$idsite,$sitecode);
        //exit(session("UserInfo_nickname"));
    }

    /**
     * 短信支付通知
     */
    public function sms_pay_notify()
    {
        try {
            $input = file_get_contents("php://input");
            $sign = $return_code = $out_trade_no =  "";
            $total_fee = 0;
            $xml = "";
            if ($input) {
                $xml = simplexml_load_string($input,'SimpleXMLElement', LIBXML_NOCDATA);
                //$money = (string)$xml->total_fee;

                file_put_contents( 'sms_pay_notify.txt', print_r(json_decode(json_encode((array)$xml), 1),true),FILE_APPEND);
                $return_code = (string)$xml->return_code;
                //$attach = (string)$xml->attach;
                $out_trade_no = (string)$xml->out_trade_no;
                $total_fee = $xml->total_fee;
                $sign = $xml->sign;
            }
            if (strtoupper($return_code)  == 'SUCCESS') {
                file_put_contents( 'sms_pay_notify.txt',"代码执行到这里",FILE_APPEND);

                //获取订单信息
                $order_info = db('sms_order')->where(array('order_sn' => $out_trade_no))->find();
                if(empty($order_info)){
                    echo 'fail';
                }else {
                    $sitecode = getSiteCode(7);
                    $config = $this->wxConfig;;
                    $key = $config['paykey'];

                    //签名验证
                    $verify_sign = SHA1::getSign2($this -> object_array($xml), 'key='.$key);
                    if($sign == $verify_sign) {

                        $order_price = round($order_info["order_price"], 2);
                        //判断校验返回的订单金额是否与商户侧的订单金额一致
                        if (($order_price*100) != $total_fee) {
                            echo "fail";
                        } else {
                            //更新支付状态，支付金额以及支付时间
                            $arr = [];
                            $arr['status'] = 1;
                            $arr['pay_price'] = $total_fee / 100;
                            $arr['pay_time'] = date("Y-m-d H:i:s");
                            $bool = db('sms_order')->where(array('order_sn' => $out_trade_no, "status" => 0))->update($arr);
                            if ($bool) {
                                $sms_num = (int)$order_info["sms_num"];
                                $idsite = $order_info["idsite"];
                                $site_manage_info = db("site_manage")->where(array("id" => $idsite))->find();
                                //更新短信可发送数量
                                $update_arr = array();
                                $update_arr["sms_num"] = (int)$site_manage_info["sms_num"] + $sms_num;
                                $update_arr["sms_total_num"] = (int)$site_manage_info["sms_total_num"] + $sms_num;
                                $update_arr["sms_recharge_total_money"] = round($site_manage_info["sms_recharge_total_money"], 2) + round($order_price, 2);
                                $rs = db("site_manage")->where(array("id" => $idsite))->update($update_arr);
                                if($rs){
                                    //写入短信线上充值记录
                                    $log_arr = array();
                                    $log_arr["sms_num"] = $sms_num;
                                    $log_arr["recharge_price"] = $order_price;
                                    $log_arr["idsite"] = $idsite;
                                    $log_arr["type"] = 1;
                                    $log_arr["create_time"] = date("Y-m-d H:i:s");
                                    $log_arr["ip"] = getip();
                                    db("sms_recharge_log")->insert($log_arr);
                                }
                                echo 'success';
                            } else {
                                echo 'fail';
                            }
                        }
                    }else{
                        echo 'fail';
                    }
                }
            } else {
                echo 'fail';
            }
        } catch (Exception $ex) {
            echo 'fail';
        }
        exit;
    }

    //对象转数组
    private function object_array($array)
    {
        if (is_object($array)) {
            $array = (array)$array;
        }
        if (is_array($array)) {
            foreach ($array as $key => $value) {
                $array[$key] = $this -> object_array($value);
            }
        }
        return $array;
    }

    public function activitymanage(){
        $request = Request::instance()->param();
        $sitecode = $request['sitecode'];
        $config = $this->wxConfig;
        $idsite = $config['id'];
        if(isset($_POST['nodeid'])){
            $nodeid=$_POST['nodeid'];
        }elseif(isset($request['nodeid'])){
            $nodeid=$request['nodeid'];
        }else{
            $nodeid=0;
        }

        $typeid = isset($request['typeid']) ? $request['typeid'] : "";
        $tagid = isset($request['tagid']) ? $request['tagid'] : "";
        $keyword=isset($request['keyword'])?$request['keyword']:"";
        $intflag = isset($request['intflag']) ? $request['intflag'] : "1";

        if (isset($request['p'])) {
            $ipage = $request['p'];
        } else {
            $ipage = 1;
        }
        $pagesize = 10;

        $nodes=db('node')->where(["idsite"=>$idsite,'nodetype'=>2])->field(['nodeid','nodename'])->select();
        if(empty($nodes)){
            header("location:/error.php?msg=" . urlencode("栏目不存在，有疑问请和管理联系！") . "&url=" . urlencode("/" . $sitecode));
            exit();
        }
        if($nodeid == 0){
            $nodeid=$nodes[0]['nodeid'];
        }
        $search = [];
        $search['siteid'] = $idsite;
//        $search['chkdown'] = array('neq', 1);
        $search['intflag'] = 2;
        $search['nodeid'] = $nodeid;

        if (!empty($typeid)) $search['fidtype'] = $typeid;
        if (!empty($tagid)) $search['chrtags'] = array('like', "%," . $tagid . ",%");
        if(!empty($keyword)) {
            $search['chrtitle']=['like',"%".$keyword."%"];
            Session::flash('keyword', $keyword);
        }
        if ($intflag == "1") {
            $search['dtsignetime'] = array('>', date('Y-m-d H:i:s', time()));
        } else if ($intflag == "2") {
            $search['dtsignetime'] = array('<', date('Y-m-d H:i:s', time()));
        } elseif($intflag == "3"){
            $search['intflag']=6;
        }elseif($intflag == "4"){
            $search['intflag']=1;
        }elseif($intflag == "5"){
            $search['intflag']=3;
        }else{
            unset($search['intflag']);
        }
        $offset = ($ipage - 1) * $pagesize;
        $show_field = "idactivity,chrtitle,chrimg_m,chrimg,chrurl,chrsummary,dtstart,dtpublishtime,hits,s.is_receive_cashed,a.usertype,a.idactivity,a.intflag";
        $result = db('activity')->alias('a')->join('activity_cashed_card_set s', 'a.idactivity=s.activity_id', 'left')->where($search)->order("chkcontentlev desc,contentlevtime desc,dtpublishtime desc")->field($show_field)->limit($offset, $pagesize)->select();
        $roottpl = 'template/modules/';
        $url = $roottpl . '/mine/activitymanage.html';
        if (Request::instance()->isPost() && isset($request['ajax'])) {
            // echo json_encode($result);exit;
            $url = $roottpl . '/mine/ajax_activitymanage.html';
        }
        $obj = new \app\admin\module\activity($idsite);
        $hdfl = $obj->getDic("hdfl");
        $this->assign('hdfl', $hdfl);
        $hdbq = $obj->getDic("hdbq");
        $this->assign('hdbq', $hdbq);
        $this->assign('nodes',$nodes);
        $this->assign('roottpl', '/' . $roottpl);
        $this->assign('typeid', $typeid);
        $this->assign('tagid', $tagid);
        $this->assign('intflag', $intflag);
        $this->assign('pageSize', $pagesize);
        $this->assign('idsite', $idsite);
        $this->assign('result_data', $result);
        $this->assign('pageIndex', $ipage);
        $this->assign('sitecode', $sitecode);
        $this->assign('SelectFooterTab', 2);
        $this->assign('nodeid', $nodeid);
        $this->assign('is_cashed', checkedMarketingPackage($idsite, 'cashed'));


        return $this->fetch($url);
    }

    public function activitymanagecopy(){
        $data = Request::instance()->param();
        $idsite = $data['siteid'];
        $obj = new \app\admin\module\activity($idsite);
        if ($obj->copydata($data['id'])) {
            echo 1;
        } else {
            echo 0;
        }
        exit();
    }


    public function activitymanageModi(){
        $data = Request::instance()->param();
//dump($data);die;
        $sitecode = $data['sitecode'];
        $config = $this->wxConfig;
        $idsite = $config['id'];
        $userID = $this->userinfo['idmember'];
        $accountID=db('account')->where(['idmember'=>$userID])->value('idaccount');
        $userName= $this->userinfo['nickname'];
        session('idsite',$idsite);
        session('AccountID',$accountID);
        session('UserName',$userName);
        $obj = new \app\admin\module\activity($idsite);
        $cashed_obj = new \app\admin\module\Cashed($idsite);
        if($data['action'] == 'add'){
            $data['nodeid']=$data['id'];
            unset($data['id']);
        }
        if (Request::instance()->isPost()) {

            if (isset($data["intflag"])) {

                if ((int) $data["intflag"] == 0) {
                    unset($data["intflag"]);
                }
            }
            if(empty($data['usertype']))
                $data['usertype']=[];
            //$img="data:image/png;base64,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";
            //base64转换为图片保存在服务器，并把名字保存数据库

            if(!empty($data['chrimg_m'])){
                $small_imgfile=$this->base64_image_content($data['chrimg_m'],$idsite);
                $data['chrimg_m']=$small_imgfile;
            }

            $res = $obj->PostData($data);
            if ($res['status'] === 'success') {
                //dump($data);
                $this->success('操作成功', '/'.$sitecode."/activitymanage/".$data['nodeid']);
            } else {
                $this->error($res['msg']);
            }
            exit();
        }

        $cms=new CmsFunction;
        $CheckPurview=$cms->CheckPurview($idsite,'contentmanage',"checkactivity");
        $this->assign('CheckPurview',$CheckPurview);

        $hdfl = $obj->getDic("hdfl");
        $this->assign('hdfl', $hdfl);
        //获取自定义会员分类
        $hyfl = $obj->getDic("hyfl");
        $this->assign('hyfl', $hyfl);
        //获取现金券计划列表
        $cashed_plan = $cashed_obj->getCashedPlan();
        $this->assign('cashed_plan', $cashed_plan);
        $hdbq = $obj->getDic("hdbq");
        $this->assign('hdbq', $hdbq);
        $FromTemp = $obj->getFromTemp();
        $this->assign('fromtemp', $FromTemp);
        $user = $obj->getUser();
        $this->assign('user', $user);

        $activityId = isset($data["id"]) ? (int) $data["id"] : 0;
        $orderNum = $obj->getActivityOrderCount($activityId);
        $this->assign('ordernum', $orderNum);

        $datainfo = $obj->deal($data);

        //dump($datainfo);//die;
        $this->assign('datainfo', $datainfo);
        $this->assign('idsite', $idsite);
        $this->assign('is_cashed',checkedMarketingPackage($idsite,'cashed'));//是否具有现金券营销包
        $this->assign('is_distribution',checkedMarketingPackage($idsite,'distribution'));//是否具有分销功能营销包
        $this->assign('sitecode', $sitecode);
        $roottpl = 'template/modules/';
        $url = $roottpl . '/mine/activitymanage_modi111.html';
        // halt($url);
        return $this->fetch($url);
    }

    public function activitymanage1(){

        $roottpl = 'template/modules/';
        $url = $roottpl . '/mine/activitymanage.html';

        $request = Request::instance()->param();
        $config = $this->wxConfig;
        $idsite = $config['id'];
        dump($request);
        dump($_FILES);

        $newname='';
        $tmp_num = getNumber();
        if(isset($request['imgBase64'])){
            $filepath='public/uploads/'.$idsite.'/admin/'.date('Y').'/'.date('m-d').'/';
            $newname=$this->base64_image_content($request['imgBase64'],$filepath);

        }

        return $this->fetch($url);
    }
    public function base64_image_content($base64_image_content,$idsite)
    {
        $filepath='public/uploads/'.$idsite.'/admin/'.date('Y').'/'.date('m-d').'/';
        //匹配出图片的格式
        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $base64_image_content, $result)) {
            $type = $result[2];
            if (!is_dir($filepath)) {
                //检查是否有该文件夹，如果没有就创建，并给予最高权限
                mkdir($filepath, 0777,true);
            }
            $new_file = $filepath . time() . ".{$type}";
            if (file_put_contents($new_file, base64_decode(str_replace($result[1], '', $base64_image_content)))) {
                return '/' . $new_file;
            } else {
                return false;
            }
        } else {
            return $base64_image_content;
        }
    }

   public function deleteGroupBuy(){
        $request = Request::instance()->param();
        $siteId=$request['idsite'];
        $groupBuyId=$request['group_buy_id'];
        $orderNum = db('group_buy_order')->where(['group_buy_id' => $groupBuyId])->count();
        if($orderNum > 0)
        {
            return ['status' => 'fail', 'msg' => '不允许删除，已有订单生成'];
        }
        $res = db('group_buy')->where(
            [
                'group_buy_id' => $groupBuyId,
                'site_id' => $siteId
            ]
        )
            ->delete();

        if($res)
        {
            return ['status' => 'success', 'msg' => '删除成功'];
        }
        return ['status' => 'fail', 'msg' => '删除失败'];
    }




    function activityDetailEdit(){
        $roottpl = 'template/modules/';
        $url = $roottpl . '/mine/activitydetailedit.html';
        return $this->fetch($url);
    }

}